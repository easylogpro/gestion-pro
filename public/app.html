<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GESTION PRO - Tableau de Bord Unifié</title>
    
    <!-- Fonts Premium -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Auth Loading Screen */
        #auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        #auth-loading.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .auth-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(16, 185, 129, 0.2);
            border-top-color: #10b981;
            border-radius: 50%;
            animation: auth-spin 1s linear infinite;
            margin-bottom: 1.5rem;
        }
        @keyframes auth-spin {
            to { transform: rotate(360deg); }
        }
        .auth-text {
            color: #94a3b8;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1rem;
        }
        /* Logout Button */
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
        }
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }
        .user-info {
            position: fixed;
            top: 20px;
            right: 140px;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 0.8rem;
            color: #475569;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        .user-info-icon {
            font-size: 1.1rem;
        }
    </style>
    
    <style>
        /* ============================================
           CSS VARIABLES - THÈME FERRARI/EASYLOG PRO
           ============================================ */
        :root {
            /* Couleurs ÉMERAUDE (pour sélection) */
            --emerald: #10b981;
            --emerald-light: #34d399;
            --emerald-dark: #059669;
            --emerald-darker: #047857;
            --emerald-glow: rgba(16, 185, 129, 0.5);
            
            /* Couleurs principales */
            --primary: #10b981;
            --primary-light: #34d399;
            --primary-dark: #059669;
            --primary-glow: rgba(16, 185, 129, 0.4);
            
            --secondary: #0d9488;
            --accent: #14b8a6;
            
            /* Secteurs */
            --s1-color: #3b82f6;
            --s1-light: #60a5fa;
            --s1-dark: #2563eb;
            --s1-glow: rgba(59, 130, 246, 0.3);
            
            --s2-color: #10b981;
            --s2-light: #34d399;
            --s2-dark: #059669;
            --s2-glow: rgba(16, 185, 129, 0.3);
            
            --s3-color: #ef4444;
            --s3-light: #f87171;
            --s3-dark: #dc2626;
            --s3-glow: rgba(239, 68, 68, 0.3);
            
            --autres-color: #64748b;
            --autres-light: #94a3b8;
            --autres-dark: #475569;
            
            /* États */
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0ea5e9;
            
            /* SIDEBAR - BLEU FONCÉ avec effet dynamique */
            --sidebar-bg: linear-gradient(180deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            --sidebar-item-hover: rgba(59, 130, 246, 0.15);
            --sidebar-item-active: linear-gradient(135deg, #10b981 0%, #059669 100%);
            
            /* ZONE PRINCIPALE - Un peu plus sombre */
            --bg-main: #e2e8f0;
            --bg-page: #f1f5f9;
            --bg-card: #ffffff;
            --bg-card-hover: #f8fafc;
            --bg-elevated: #f1f5f9;
            
            /* Textes - Zone claire */
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            
            /* Textes - Sidebar */
            --sidebar-text: #e2e8f0;
            --sidebar-text-muted: rgba(148, 163, 184, 0.8);
            
            /* Bordures */
            --border-subtle: rgba(148, 163, 184, 0.2);
            --border-medium: rgba(148, 163, 184, 0.3);
            --border-card: #cbd5e1;
            
            /* Dimensions */
            --sidebar-width: 260px;
            --sidebar-collapsed: 70px;
            --header-height: 70px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-base: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Shadows - Premium */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07), 0 2px 4px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1), 0 6px 10px rgba(0, 0, 0, 0.08);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.12);
            --shadow-glow: 0 0 30px var(--emerald-glow);
            --shadow-card: 0 2px 8px rgba(0, 0, 0, 0.06), 0 0 1px rgba(0, 0, 0, 0.1);
            --shadow-card-hover: 0 12px 28px rgba(0, 0, 0, 0.12), 0 0 1px rgba(0, 0, 0, 0.1);
        }

        /* ============================================
           ANIMATIONS DYNAMIQUES
           ============================================ */
        @keyframes pulse-icon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 8px rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 25px rgba(239, 68, 68, 0.8), 0 0 40px rgba(239, 68, 68, 0.5); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .icon-animated {
            display: inline-block;
            animation: pulse-icon 2s ease-in-out infinite;
        }

        .card-hover-float:hover {
            animation: float 0.5s ease;
        }

        /* STT cliquable pour relance DSF */
        .stt-clickable {
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: inline-block;
            font-weight: 700;
            background: rgba(16, 185, 129, 0.1);
        }

        .stt-clickable:hover {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            transform: scale(1.08);
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .stt-clickable.has-retard {
            color: #fff;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            animation: glow-pulse 1.5s ease-in-out infinite;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .stt-clickable.has-retard:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: scale(1.1);
            animation: none;
            box-shadow: 0 6px 25px rgba(239, 68, 68, 0.6);
        }

        /* Dégradés dynamiques - PLUS VISIBLES */
        .section-title .icon,
        .stats-card-header h3::before,
        .card-header h3::before {
            animation: pulse-icon 2.5s ease-in-out infinite;
        }

        /* Effets hover TRÈS VISIBLES sur cards */
        .sector-card,
        .kpi-card,
        .stats-card,
        .dsf-sector-card,
        .stt-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .sector-card::before,
        .kpi-card::before,
        .stt-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .sector-card:hover::before,
        .kpi-card:hover::before,
        .stt-card:hover::before {
            left: 100%;
        }

        .sector-card:hover,
        .kpi-card:hover,
        .stats-card:hover,
        .dsf-sector-card:hover,
        .stt-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15), 0 0 20px rgba(16, 185, 129, 0.2);
        }

        /* Dégradé TRÈS VISIBLE sur les headers de tableaux */
        .history-table-header.s1,
        .dsf-planning-header.s1 {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 50%, #1e40af 100%) !important;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        .history-table-header.s2,
        .dsf-planning-header.s2 {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%) !important;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        .history-table-header.s3,
        .dsf-planning-header.s3 {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%) !important;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        .history-table-header.autres,
        .dsf-planning-header.autres {
            background: linear-gradient(135deg, #64748b 0%, #475569 50%, #334155 100%) !important;
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.4);
        }

        /* Section header avec dégradé subtil */
        .section-header {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(6, 182, 212, 0.05) 100%);
            border-left: 4px solid var(--primary);
            padding-left: 16px;
            margin-left: -16px;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
        }

        /* Filtres avec style premium TRÈS VISIBLE */
        .planning-filters,
        .filter-dropdown {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(241,245,249,0.95) 100%);
            border: 2px solid var(--primary);
            border-radius: var(--radius-md);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.15);
        }

        .planning-filters select,
        .filter-dropdown select {
            border: 2px solid var(--border-medium);
            transition: all 0.3s ease;
        }

        .planning-filters select:focus,
        .filter-dropdown select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        /* KPI cards avec dégradé de fond */
        .kpi-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-top: 4px solid var(--primary);
        }

        .kpi-card.ca { border-top-color: var(--success); }
        .kpi-card.travaux { border-top-color: var(--info); }
        .kpi-card.devis { border-top-color: var(--warning); }
        .kpi-card.visites { border-top-color: var(--primary); }

        /* Stats cards avec effet glassmorphism */
        .stats-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.9) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        /* Sector cards améliorées */
        .sector-card.s1 { border-left: 5px solid var(--s1-color); background: linear-gradient(135deg, #ffffff 0%, rgba(59, 130, 246, 0.05) 100%); }
        .sector-card.s2 { border-left: 5px solid var(--s2-color); background: linear-gradient(135deg, #ffffff 0%, rgba(16, 185, 129, 0.05) 100%); }
        .sector-card.s3 { border-left: 5px solid var(--s3-color); background: linear-gradient(135deg, #ffffff 0%, rgba(239, 68, 68, 0.05) 100%); }
        .sector-card.autres { border-left: 5px solid var(--autres-color); background: linear-gradient(135deg, #ffffff 0%, rgba(100, 116, 139, 0.05) 100%); }

        /* ============================================
           RESET & BASE
           ============================================ */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* Scrollbar personnalisée */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-elevated);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--emerald) 0%, var(--emerald-dark) 100%);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--emerald-light);
        }

        /* ============================================
           LAYOUT PRINCIPAL
           ============================================ */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* ============================================
           SIDEBAR - ÉMERAUDE AVEC GLOW
           ============================================ */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: var(--sidebar-bg);
            border-right: 1px solid rgba(59, 130, 246, 0.2);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: width var(--transition-base);
            box-shadow: 4px 0 25px rgba(0, 0, 0, 0.3);
        }

        /* Effet glow dynamique BLEU sur la sidebar */
        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at top left, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at bottom right, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
            pointer-events: none;
            animation: sidebarGlow 4s ease-in-out infinite alternate;
        }

        @keyframes sidebarGlow {
            0% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            position: relative;
            z-index: 1;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--sidebar-text);
        }

        .logo-icon {
            width: 46px;
            height: 46px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4), 0 0 20px rgba(59, 130, 246, 0.2);
            animation: logoGlow 3s ease-in-out infinite alternate;
        }

        @keyframes logoGlow {
            0% { box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4), 0 0 20px rgba(59, 130, 246, 0.2); }
            100% { box-shadow: 0 4px 20px rgba(59, 130, 246, 0.6), 0 0 30px rgba(59, 130, 246, 0.4); }
        }

        .logo-text {
            font-size: 1.3em;
            font-weight: 700;
            background: linear-gradient(135deg, #e0e7ff 0%, #93c5fd 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 12px;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--sidebar-text-muted);
            padding: 0 12px;
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            color: var(--sidebar-text);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95em;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--sidebar-item-hover);
            color: #ffffff;
            transform: translateX(4px);
        }

        .nav-item.active {
            background: var(--sidebar-item-active);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4), 0 0 20px rgba(16, 185, 129, 0.2);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 70%;
            background: #ffffff;
            border-radius: 0 4px 4px 0;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .nav-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 0.7em;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }

        /* Sidebar Footer */
        .sidebar-footer {
            padding: 16px 12px;
            border-top: 1px solid rgba(167, 243, 208, 0.15);
            position: relative;
            z-index: 1;
        }

        .data-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: var(--radius-md);
            font-size: 0.85em;
            color: var(--sidebar-text);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--sidebar-text-muted);
            animation: pulse-muted 2s infinite;
        }

        .status-dot.connected {
            background: #6ee7b7;
            box-shadow: 0 0 10px rgba(110, 231, 183, 0.6);
            animation: pulse-success 2s infinite;
        }

        @keyframes pulse-success {
            0%, 100% { opacity: 1; box-shadow: 0 0 10px rgba(110, 231, 183, 0.6); }
            50% { opacity: 0.8; box-shadow: 0 0 20px rgba(110, 231, 183, 0.8); }
        }

        @keyframes pulse-muted {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* ============================================
           MAIN CONTENT - ZONE TRÈS CLAIRE
           ============================================ */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg-main);
        }

        /* ============================================
           HEADER - CLAIR
           ============================================ */
        .main-header {
            height: var(--header-height);
            background: var(--bg-page);
            border-bottom: 1px solid var(--border-card);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: var(--shadow-sm);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-title h1 {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-week {
            background: var(--bg-elevated);
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-size: 0.85em;
            color: var(--text-secondary);
            font-weight: 500;
            border: 1px solid var(--border-card);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Search Bar */
        .search-global {
            position: relative;
        }

        .search-global input {
            width: 320px;
            padding: 10px 16px 10px 44px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9em;
            font-family: inherit;
            transition: all var(--transition-fast);
        }

        .search-global input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        .search-global input::placeholder {
            color: var(--text-muted);
        }

        .search-global .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1em;
        }

        .search-global .search-shortcut {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-elevated);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Boutons Header */
        .btn-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
            font-family: inherit;
        }

        .btn-import {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-import:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        /* ============================================
           PAGE CONTENT
           ============================================ */
        .page-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        /* Masquer toutes les pages par défaut */
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================
           ZONE IMPORT (État initial)
           ============================================ */
        .import-zone {
            max-width: 700px;
            margin: 60px auto;
            text-align: center;
        }

        .import-card {
            background: var(--bg-card);
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-xl);
            padding: 60px 40px;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .import-card:hover {
            border-color: var(--primary);
            background: var(--bg-elevated);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .import-card.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            box-shadow: var(--shadow-glow);
        }

        .import-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .import-card h2 {
            font-size: 1.6em;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .import-card p {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .import-card .formats {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 16px;
        }

        .import-options {
            margin-top: 30px;
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .import-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 24px;
            background: var(--bg-dark);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.9em;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .import-option:hover {
            border-color: var(--primary);
            color: var(--text-primary);
            background: var(--bg-card);
        }

        .import-option.access {
            border-color: var(--warning);
        }

        .import-option.access:hover {
            background: rgba(245, 158, 11, 0.1);
        }

        /* Status de chargement */
        .import-status {
            margin-top: 40px;
            display: none;
        }

        .import-status.visible {
            display: block;
        }

        .sheets-loaded {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .sheet-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .sheet-badge.loaded {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .sheet-badge .count {
            font-weight: 700;
            color: var(--text-primary);
        }

        /* ============================================
           DASHBOARD
           ============================================ */
        .dashboard-grid {
            display: grid;
            gap: 24px;
        }

        /* Filtre Secteur Dashboard */
        .dashboard-filter {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 16px 20px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-card);
            box-shadow: var(--shadow-card);
        }

        .dashboard-filter label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .dashboard-filter select {
            padding: 10px 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-card);
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-family: inherit;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .dashboard-filter select:focus {
            outline: none;
            border-color: var(--emerald);
            box-shadow: 0 0 0 3px var(--emerald-glow);
        }

        /* KPIs Row - EN BAS */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .kpi-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all var(--transition-base);
            cursor: pointer;
            border: 1px solid var(--border-card);
            box-shadow: var(--shadow-card);
        }

        .kpi-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-card-hover);
            border-color: transparent;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--kpi-color, var(--emerald));
        }

        .kpi-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(180deg, transparent 0%, rgba(16, 185, 129, 0.03) 100%);
            opacity: 0;
            transition: opacity var(--transition-base);
            pointer-events: none;
        }

        .kpi-card:hover::after {
            opacity: 1;
        }

        .kpi-card.ca { --kpi-color: var(--emerald); }
        .kpi-card.travaux { --kpi-color: var(--success); }
        .kpi-card.devis { --kpi-color: var(--warning); }
        .kpi-card.visites { --kpi-color: var(--info); }
        .kpi-card.dsf { --kpi-color: var(--danger); }

        .kpi-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            border: 1px solid var(--border-card);
        }

        .kpi-trend {
            font-size: 0.8em;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .kpi-trend.up {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .kpi-trend.down {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .kpi-value {
            font-size: 2em;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-family: 'JetBrains Mono', monospace;
        }

        .kpi-label {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        /* Secteurs Grid */
        .sectors-section {
            margin-top: 8px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title .icon {
            font-size: 1.1em;
        }

        .sectors-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .sector-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-card);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-card);
            transition: all var(--transition-base);
        }

        .sector-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-card-hover);
        }

        .sector-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--sector-color);
        }

        .sector-card.s1 { --sector-color: var(--s1-color); }
        .sector-card.s2 { --sector-color: var(--s2-color); }
        .sector-card.s3 { --sector-color: var(--s3-color); }
        .sector-card.autres { --sector-color: var(--autres-color); }

        /* Hover glow par secteur */
        .sector-card.s1:hover { box-shadow: var(--shadow-card-hover), 0 0 20px var(--s1-glow); }
        .sector-card.s2:hover { box-shadow: var(--shadow-card-hover), 0 0 20px var(--s2-glow); }
        .sector-card.s3:hover { box-shadow: var(--shadow-card-hover), 0 0 20px var(--s3-glow); }

        .sector-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .sector-name {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--sector-color);
        }

        .sector-sites {
            background: var(--bg-elevated);
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.85em;
            color: var(--text-secondary);
            border: 1px solid var(--border-card);
        }

        .sector-stats {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sector-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .stat-value {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-number {
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        .stat-percent {
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .stat-percent.good {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .stat-percent.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .stat-percent.danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--sector-color);
            border-radius: 3px;
            transition: width 0.8s ease;
        }

        .sector-objectif {
            margin-top: 10px;
            padding: 8px 12px;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            font-size: 0.85em;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            border-left: 3px solid var(--primary);
        }

        /* Stats Row - DSF + Travaux */
        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .stats-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-card);
            box-shadow: var(--shadow-card);
            overflow: hidden;
            transition: all var(--transition-base);
        }

        .stats-card:hover {
            box-shadow: var(--shadow-card-hover);
        }

        .stats-card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-card);
            background: var(--bg-elevated);
        }

        .stats-card-header h3 {
            font-size: 1em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stats-card-body {
            padding: 20px;
            display: flex;
            gap: 16px;
        }

        /* DSF Stats Items */
        .dsf-stat-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            border-radius: var(--radius-md);
            background: var(--bg-elevated);
            cursor: pointer;
            transition: all var(--transition-base);
            border: 2px solid transparent;
        }

        .dsf-stat-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .dsf-stat-item.cloture:hover { border-color: var(--info); background: rgba(14, 165, 233, 0.1); }
        .dsf-stat-item.planif:hover { border-color: var(--warning); background: rgba(245, 158, 11, 0.1); }
        .dsf-stat-item.resp:hover { border-color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        .dsf-stat-icon {
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .dsf-stat-info {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .dsf-stat-value {
            font-size: 1.8em;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        .dsf-stat-label {
            font-size: 0.75em;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Travaux par secteur */
        .travaux-sector-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px;
            border-radius: var(--radius-md);
            background: var(--bg-elevated);
            cursor: pointer;
            transition: all var(--transition-base);
            border: 2px solid transparent;
        }

        .travaux-sector-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .travaux-sector-item.s1:hover { border-color: var(--s1-color); box-shadow: var(--shadow-md), 0 0 15px var(--s1-glow); }
        .travaux-sector-item.s2:hover { border-color: var(--s2-color); box-shadow: var(--shadow-md), 0 0 15px var(--s2-glow); }
        .travaux-sector-item.s3:hover { border-color: var(--s3-color); box-shadow: var(--shadow-md), 0 0 15px var(--s3-glow); }
        .travaux-sector-item.autres:hover { border-color: var(--autres-color); }

        .sector-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 700;
            color: white;
        }

        .sector-badge.s1 { background: var(--s1-color); }
        .sector-badge.s2 { background: var(--s2-color); }
        .sector-badge.s3 { background: var(--s3-color); }
        .sector-badge.autres { background: var(--autres-color); }

        .travaux-count {
            font-size: 1.6em;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        /* Chart Section */
        .chart-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-card);
            box-shadow: var(--shadow-card);
        }

        .chart-section .card-header {
            border-bottom: 1px solid var(--border-card);
        }

        .chart-container {
            height: 280px;
        }

        /* DSF Non clôturés par secteur - Full Width */
        .stats-row-full {
            width: 100%;
        }

        .stats-card-full {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-card);
            box-shadow: var(--shadow-card);
            overflow: hidden;
        }

        .dsf-sectors-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            padding: 20px;
        }

        .dsf-sector-card {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: 16px;
            border: 2px solid transparent;
            transition: all var(--transition-base);
        }

        .dsf-sector-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .dsf-sector-card.s1:hover { border-color: var(--s1-color); }
        .dsf-sector-card.s2:hover { border-color: var(--s2-color); }
        .dsf-sector-card.s3:hover { border-color: var(--s3-color); }
        .dsf-sector-card.autres:hover { border-color: var(--autres-color); }

        .dsf-sector-header {
            margin-bottom: 12px;
        }

        .dsf-sector-stats {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 12px;
        }

        .dsf-mini-stat {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .dsf-mini-stat:hover {
            background: var(--primary);
            color: white;
        }

        .dsf-mini-value {
            display: block;
            font-size: 1.3em;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        .dsf-mini-stat:hover .dsf-mini-value {
            color: white;
        }

        .dsf-mini-label {
            display: block;
            font-size: 0.65em;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dsf-mini-stat:hover .dsf-mini-label {
            color: rgba(255,255,255,0.8);
        }

        .dsf-sector-total {
            text-align: center;
            padding: 8px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .dsf-sector-total span {
            font-weight: 800;
            font-size: 1.2em;
            color: var(--text-primary);
        }

        .dsf-totals-bar {
            display: flex;
            justify-content: center;
            gap: 24px;
            padding: 16px 20px;
            background: var(--bg-elevated);
            border-top: 1px solid var(--border-card);
        }

        .dsf-total-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .dsf-total-item.cloture { background: rgba(14, 165, 233, 0.1); }
        .dsf-total-item.planif { background: rgba(245, 158, 11, 0.1); }
        .dsf-total-item.resp { background: rgba(239, 68, 68, 0.1); }

        .dsf-total-item:hover {
            transform: scale(1.05);
        }

        .dsf-total-label {
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .dsf-total-value {
            font-size: 1.4em;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
        }

        .dsf-total-item.cloture .dsf-total-value { color: var(--info); }
        .dsf-total-item.planif .dsf-total-value { color: var(--warning); }
        .dsf-total-item.resp .dsf-total-value { color: var(--danger); }

        /* Travaux par secteur - Homogène */
        .travaux-sectors-section {
            margin-top: 8px;
        }

        .travaux-sectors-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .travaux-sector-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-card);
            box-shadow: var(--shadow-card);
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .travaux-sector-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-card-hover);
        }

        .travaux-sector-card.s1:hover { border-color: var(--s1-color); box-shadow: var(--shadow-card-hover), 0 0 20px var(--s1-glow); }
        .travaux-sector-card.s2:hover { border-color: var(--s2-color); box-shadow: var(--shadow-card-hover), 0 0 20px var(--s2-glow); }
        .travaux-sector-card.s3:hover { border-color: var(--s3-color); box-shadow: var(--shadow-card-hover), 0 0 20px var(--s3-glow); }
        .travaux-sector-card.autres:hover { border-color: var(--autres-color); }

        .travaux-sector-icon {
            font-size: 2em;
        }

        .travaux-sector-info {
            display: flex;
            flex-direction: column;
        }

        .travaux-sector-name {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .travaux-sector-count {
            font-size: 2em;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        /* Deux colonnes en bas */
        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 8px;
        }

        .card-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-card);
            overflow: hidden;
            box-shadow: var(--shadow-card);
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-card);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-weight: 700;
            font-size: 1.05em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-body {
            padding: 24px;
        }

        /* Alertes */
        .alerts-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            border-left: 3px solid var(--alert-color);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .alert-item:hover {
            background: var(--bg-card-hover);
            transform: translateX(4px);
        }

        .alert-item.warning { --alert-color: var(--warning); }
        .alert-item.danger { --alert-color: var(--danger); }
        .alert-item.success { --alert-color: var(--success); }
        .alert-item.info { --alert-color: var(--info); }

        .alert-icon {
            font-size: 1.2em;
        }

        .alert-text {
            flex: 1;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .alert-count {
            font-weight: 700;
            color: var(--alert-color);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Chart Container */
        .chart-container {
            height: 250px;
            position: relative;
        }

        /* Empty State */
        .empty-dashboard {
            text-align: center;
            padding: 80px 40px;
            color: var(--text-secondary);
        }

        .empty-dashboard .icon {
            font-size: 4em;
            opacity: 0.5;
            margin-bottom: 20px;
        }

        .empty-dashboard h3 {
            font-size: 1.4em;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        /* ============================================
           ANIMATIONS
           ============================================ */
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .kpi-card {
            animation: slideIn 0.4s ease backwards;
        }

        .kpi-card:nth-child(1) { animation-delay: 0.05s; }
        .kpi-card:nth-child(2) { animation-delay: 0.1s; }
        .kpi-card:nth-child(3) { animation-delay: 0.15s; }
        .kpi-card:nth-child(4) { animation-delay: 0.2s; }
        .kpi-card:nth-child(5) { animation-delay: 0.25s; }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 1400px) {
            .kpi-row {
                grid-template-columns: repeat(3, 1fr);
            }
            .sectors-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: var(--sidebar-collapsed);
            }
            .sidebar .logo-text,
            .sidebar .nav-text,
            .sidebar .nav-section-title,
            .sidebar .status-text {
                display: none;
            }
            .main-content {
                margin-left: var(--sidebar-collapsed);
            }
            .bottom-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .kpi-row {
                grid-template-columns: 1fr 1fr;
            }
            .sectors-grid {
                grid-template-columns: 1fr;
            }
            .search-global {
                display: none;
            }
        }

        /* ============================================
           UTILITIES
           ============================================ */
        .hidden { display: none !important; }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .text-muted { color: var(--text-muted); }

        /* ============================================
           MODULE VISITES - STYLES
           ============================================ */
        .visites-header {
            margin-bottom: 24px;
        }

        .week-banner {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: var(--radius-lg);
            padding: 24px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-md);
        }

        .week-info-main h2 {
            font-size: 1.6em;
            margin-bottom: 4px;
            color: white;
        }

        .week-info-main p {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.95em;
        }

        .visit-type-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px 24px;
            border-radius: var(--radius-md);
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .visit-type-badge span {
            display: block;
            font-size: 1.8em;
            font-weight: 800;
            color: white;
        }

        .visit-type-badge small {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Onglets Visites */
        .visites-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .visites-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 24px;
            background: var(--bg-card);
            border: 2px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
            color: var(--text-secondary);
        }

        .visites-tab:hover {
            border-color: var(--primary);
            background: var(--bg-elevated);
        }

        .visites-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-color: var(--primary);
            color: white;
            box-shadow: var(--shadow-glow);
        }

        .visites-tab .tab-icon {
            font-size: 1.4em;
        }

        .visites-tab .tab-label {
            font-weight: 600;
            font-size: 1em;
        }

        .visites-tab .tab-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
        }

        .visites-tab.active .tab-count {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Contenu Visites */
        .visites-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .visites-content.active {
            display: block;
        }

        /* Stats Secteurs Grid */
        .sectors-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .sector-stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--border-subtle);
            position: relative;
            overflow: hidden;
        }

        .sector-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--sector-color);
        }

        .sector-stat-card.s1 { --sector-color: var(--s1-color); }
        .sector-stat-card.s2 { --sector-color: var(--s2-color); }
        .sector-stat-card.s3 { --sector-color: var(--s3-color); }
        .sector-stat-card.autres { --sector-color: var(--autres-color); }

        .sector-stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .sector-badge {
            font-weight: 700;
            font-size: 0.95em;
            color: var(--sector-color);
        }

        .sites-count {
            font-size: 0.85em;
            color: var(--text-muted);
            background: var(--bg-elevated);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
        }

        .sector-stat-body {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .visit-row {
            display: grid;
            grid-template-columns: 40px 1fr;
            gap: 12px;
            align-items: center;
        }

        .visit-type {
            font-weight: 700;
            font-size: 0.85em;
            color: var(--text-muted);
            background: var(--bg-elevated);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .visit-data {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .visit-remaining {
            font-size: 1.4em;
            font-weight: 800;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .visit-percent {
            font-size: 0.8em;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        .visit-percent.good {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .visit-percent.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .visit-percent.danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .progress-mini {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
            grid-column: span 2;
        }

        .progress-mini-fill {
            height: 100%;
            background: var(--sector-color);
            border-radius: 2px;
            transition: width 0.6s ease;
        }

        /* DSF Stats */
        .dsf-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dsf-stat-main {
            display: flex;
            flex-direction: column;
        }

        .dsf-remaining {
            font-size: 2em;
            font-weight: 800;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            line-height: 1;
        }

        .dsf-label {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .dsf-progress-circle {
            position: relative;
            width: 60px;
            height: 60px;
        }

        .dsf-progress-circle svg {
            width: 100%;
            height: 100%;
        }

        .dsf-percent {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.85em;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Historique Tables */
        .history-tables-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .history-table-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--border-subtle);
        }

        .history-table-header {
            padding: 16px 20px;
            font-weight: 700;
            font-size: 1em;
            color: white;
        }

        .history-table-header.s1 { background: linear-gradient(135deg, var(--s1-color) 0%, var(--s1-dark) 100%); }
        .history-table-header.s2 { background: linear-gradient(135deg, var(--s2-color) 0%, var(--s2-dark) 100%); }
        .history-table-header.s3 { background: linear-gradient(135deg, var(--s3-color) 0%, var(--s3-dark) 100%); }
        .history-table-header.autres { background: linear-gradient(135deg, var(--autres-color) 0%, var(--autres-dark) 100%); }

        .history-table-wrapper {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            background: var(--bg-elevated);
            padding: 12px 16px;
            text-align: left;
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        .history-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .history-table tr:hover td {
            background: var(--bg-elevated);
        }

        .history-table tr.current-week td {
            background: rgba(99, 102, 241, 0.1);
            color: var(--text-primary);
            font-weight: 600;
        }

        .history-table .cell-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.85em;
        }

        .history-table .cell-type.v1 {
            background: rgba(59, 130, 246, 0.15);
            color: var(--s1-color);
        }

        .history-table .cell-type.v2 {
            background: rgba(16, 185, 129, 0.15);
            color: var(--s2-color);
        }

        .history-table .cell-realise {
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 8px;
        }

        .history-table .cell-realise.positive {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .history-table .cell-realise.negative {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .history-table .cell-objectif {
            color: var(--warning);
            font-weight: 600;
        }

        /* Bouton Archive */
        .btn-archive {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
        }

        .btn-archive:hover {
            background: var(--bg-elevated);
            border-color: var(--primary);
            color: var(--text-primary);
        }

        /* Filter Dropdown */
        .filter-dropdown {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-dropdown label {
            font-size: 0.9em;
            color: var(--text-muted);
        }

        .filter-dropdown select {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9em;
            font-family: inherit;
            cursor: pointer;
        }

        .filter-dropdown select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Empty State Mini */
        .empty-state-mini {
            text-align: center;
            padding: 60px 40px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
        }

        /* Planning DSF Table */
        .dsf-planning-section {
            margin-bottom: 32px;
        }

        .dsf-planning-header {
            padding: 16px 20px;
            font-weight: 700;
            color: white;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .dsf-planning-table-wrapper {
            background: var(--bg-card);
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            overflow-x: auto;
            border: 1px solid var(--border-subtle);
            border-top: none;
        }

        .dsf-planning-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .dsf-planning-table th {
            background: var(--bg-elevated);
            padding: 12px 8px;
            text-align: center;
            font-size: 0.75em;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            white-space: nowrap;
        }

        .dsf-planning-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.85em;
            text-align: center;
            color: var(--text-secondary);
        }

        .dsf-planning-table tr:hover td {
            background: var(--bg-elevated);
        }

        .dsf-planning-table .stt-name {
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dsf-planning-table .month-cell {
            min-width: 50px;
        }

        .dsf-planning-table .month-cell.current {
            background: rgba(99, 102, 241, 0.1);
        }

        .dsf-planning-table .month-cell.overdue {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            font-weight: 700;
        }

        .dsf-planning-table .retard-cell {
            color: var(--danger);
            font-weight: 700;
        }

        .dsf-planning-table .restant-cell {
            background: rgba(245, 158, 11, 0.1);
            font-weight: 700;
            color: var(--warning);
        }

        .dsf-planning-table .percent-cell {
            font-weight: 600;
        }

        .dsf-planning-table .percent-cell.good {
            color: var(--success);
        }

        .dsf-planning-table .percent-cell.warning {
            color: var(--warning);
        }

        .dsf-planning-table .percent-cell.danger {
            color: var(--danger);
        }

        .dsf-planning-table tfoot td {
            background: var(--bg-elevated);
            font-weight: 700;
            color: var(--text-primary);
        }

        @media (max-width: 1400px) {
            .sectors-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .history-tables-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sectors-stats-grid {
                grid-template-columns: 1fr;
            }
            .visites-tabs {
                flex-direction: column;
            }
            .week-banner {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
        }

        /* ============================================
           MODULE TRAVAUX - STYLES
           ============================================ */
        .travaux-filters {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-subtle);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--text-muted);
        }

        .filter-group select {
            padding: 10px 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9em;
            font-family: inherit;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .filter-group select:hover {
            border-color: var(--primary);
        }

        .filter-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        .filters-actions {
            display: flex;
            gap: 12px;
        }

        .btn-action {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
            font-family: inherit;
        }

        .btn-action.email-redacteur {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            display: none;
        }

        .btn-action.email-stt {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
            display: none;
        }

        .btn-action.primary {
            background: linear-gradient(135deg, var(--success) 0%, var(--s2-dark) 100%);
            color: white;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Stats Travaux */
        .travaux-stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card-travaux {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            border: 1px solid var(--border-subtle);
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .stat-card-travaux::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--card-color, var(--primary));
        }

        .stat-card-travaux.ca { --card-color: var(--primary); }
        .stat-card-travaux.secteur { --card-color: var(--success); }
        .stat-card-travaux.tech { --card-color: var(--info); }
        .stat-card-travaux.stt { --card-color: var(--warning); }
        .stat-card-travaux.budget { --card-color: #f97316; }

        .stat-card-travaux:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--card-color);
        }

        .stat-card-travaux .stat-icon {
            font-size: 2em;
            opacity: 0.9;
        }

        .stat-card-travaux .stat-info {
            flex: 1;
        }

        .stat-card-travaux .stat-value {
            font-size: 1.5em;
            font-weight: 800;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-card-travaux .stat-label {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        /* Tableau Travaux */
        .travaux-table-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
        }

        .table-header-info {
            padding: 16px 20px;
            background: var(--bg-elevated);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-subtle);
        }

        .table-header-info span {
            font-weight: 600;
            color: var(--text-primary);
        }

        .table-legend {
            display: flex;
            gap: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .legend-item.stt::before {
            content: '';
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 3px;
            border-left: 3px solid var(--warning);
        }

        .table-wrapper {
            max-height: 60vh;
            overflow: auto;
        }

        .travaux-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .travaux-table thead {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .travaux-table th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            transition: background var(--transition-fast);
        }

        .travaux-table th:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .travaux-table th .sort-icon {
            margin-left: 6px;
            opacity: 0.7;
        }

        .travaux-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            white-space: nowrap;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .travaux-table tbody tr {
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .travaux-table tbody tr:hover {
            background: var(--bg-elevated);
        }

        .travaux-table tbody tr.has-stt {
            background: linear-gradient(90deg, rgba(254, 243, 199, 0.1) 0%, rgba(253, 230, 138, 0.1) 100%);
            border-left: 4px solid var(--warning);
        }

        .travaux-table tbody tr.has-stt:hover {
            background: linear-gradient(90deg, rgba(254, 243, 199, 0.2) 0%, rgba(253, 230, 138, 0.2) 100%);
        }

        .empty-state-travaux {
            text-align: center;
            padding: 80px 40px;
            display: none;
        }

        .empty-state-travaux .empty-icon {
            font-size: 4em;
            opacity: 0.5;
            margin-bottom: 16px;
        }

        .empty-state-travaux h3 {
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state-travaux p {
            color: var(--text-muted);
        }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: 40px;
            overflow-y: auto;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .modal-container {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        .modal-container.large {
            max-width: 1200px;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            transition: all var(--transition-fast);
            z-index: 10;
        }

        .modal-close:hover {
            transform: rotate(90deg) scale(1.1);
        }

        .modal-title {
            padding: 12px 20px;
            font-size: 1.2em;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .modal-nav {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 32px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
        }

        .btn-nav {
            padding: 10px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
        }

        .btn-nav:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-nav:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-counter {
            color: var(--text-muted);
            font-size: 0.9em;
        }

        .modal-body {
            padding: 24px 32px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 32px;
            background: var(--bg-elevated);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Fiche Client Sections */
        .detail-section {
            margin-bottom: 24px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            overflow: hidden;
            border-left: 4px solid var(--primary);
        }

        .detail-section-title {
            padding: 12px 16px;
            background: rgba(99, 102, 241, 0.1);
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-section-content {
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .detail-section-content.cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .detail-item {
            background: var(--bg-card);
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--primary-light);
        }

        .detail-item .item-label {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item .item-value {
            font-weight: 600;
            color: var(--text-primary);
            word-break: break-word;
        }

        /* STT Tabs */
        .stt-tabs-container {
            display: flex;
            gap: 8px;
            padding: 16px 32px;
            background: var(--bg-elevated);
        }

        .stt-tab-btn {
            padding: 10px 24px;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
            background: var(--bg-card);
            color: var(--text-secondary);
        }

        .stt-tab-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .stt-tab-btn:not(.active):hover {
            background: var(--bg-card-hover);
        }

        /* STT Table */
        .stt-list-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stt-list-table th {
            background: var(--bg-elevated);
            padding: 12px;
            text-align: left;
            font-size: 0.8em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stt-list-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.9em;
        }

        .stt-list-table tr:hover td {
            background: var(--bg-elevated);
        }

        .stt-list-table .checkbox-cell {
            text-align: center;
            width: 40px;
        }

        .stt-list-table .checkbox-cell input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .stt-list-table .history-cell {
            font-size: 0.8em;
            color: var(--text-muted);
            max-width: 150px;
        }

        .select-all-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .select-all-row label {
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
        }

        .select-all-row span {
            color: var(--text-muted);
            font-size: 0.9em;
        }

        /* Stats Modal */
        .stats-grid-modal {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 16px;
            padding: 14px 16px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            align-items: center;
        }

        .stats-row:hover {
            background: var(--bg-card-hover);
        }

        .stats-row .stats-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .stats-row .stats-count {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
        }

        .stats-row .stats-value {
            text-align: right;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--primary);
        }

        .stats-total {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: var(--radius-md);
            text-align: center;
            color: white;
        }

        .stats-total .total-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .stats-total .total-value {
            font-size: 2em;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
        }

        @media (max-width: 1200px) {
            .filters-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .travaux-stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr 1fr;
            }
            .travaux-stats {
                grid-template-columns: 1fr 1fr;
            }
            .detail-section-content {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================
           MODULE DEVIS - STYLES
           ============================================ */
        .devis-search-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-subtle);
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .search-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .search-field label {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--text-muted);
        }

        .search-field input {
            padding: 12px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.95em;
            font-family: inherit;
        }

        .search-field input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        .devis-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .devis-stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--border-subtle);
        }

        .devis-stat-card .stat-card-title {
            padding: 16px 20px;
            font-weight: 700;
            color: white;
        }

        .devis-stat-card.synthese .stat-card-title {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }

        .devis-stat-card.stt .stat-card-title {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .devis-stat-card.contrat .stat-card-title {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        }

        .devis-stat-card .stat-card-content {
            padding: 20px;
        }

        .stt-summary, .contrat-summary {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stt-summary-item, .contrat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
        }

        .stt-summary-item .label, .contrat-item .label {
            color: var(--text-muted);
            font-size: 0.85em;
        }

        .stt-summary-item .value, .contrat-item .value {
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        .contrat-item .value.success { color: var(--success); }
        .contrat-item .value.warning { color: var(--warning); }

        .devis-stat-card select {
            width: 100%;
            padding: 10px;
            margin-top: 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
        }

        .devis-list-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
        }

        .list-header {
            padding: 16px 20px;
            background: var(--bg-elevated);
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .devis-cards {
            padding: 20px;
            display: grid;
            gap: 16px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .devis-card-item {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            cursor: pointer;
            border: 2px solid var(--border-subtle);
            transition: all var(--transition-fast);
        }

        .devis-card-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .devis-card-item.has-bc {
            background: linear-gradient(90deg, rgba(254, 243, 199, 0.1) 0%, var(--bg-elevated) 100%);
            border-left: 4px solid var(--warning);
        }

        .devis-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .devis-number {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary);
        }

        .devis-date {
            color: var(--text-muted);
            font-size: 0.9em;
        }

        .devis-card-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .devis-info-item {
            font-size: 0.9em;
        }

        .devis-info-item .info-label {
            color: var(--text-muted);
            font-size: 0.8em;
        }

        .devis-info-item .info-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .empty-state-devis {
            text-align: center;
            padding: 60px 40px;
            display: none;
        }

        .devis-card {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            cursor: pointer;
            border: 2px solid var(--border-subtle);
            transition: all var(--transition-fast);
        }

        .devis-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .devis-card.bc-ok {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, var(--bg-elevated) 100%);
            border-left: 4px solid var(--success);
        }

        .devis-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .devis-num {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--primary);
        }

        .devis-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .devis-status.success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .devis-status.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .devis-card-body {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .devis-card-body .info-row {
            display: flex;
            gap: 8px;
            font-size: 0.9em;
        }

        .devis-card-body .info-row .label {
            color: var(--text-muted);
        }

        .devis-card-body .info-row .value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .devis-card-body .info-row.stt {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-subtle);
        }

        .synthese-year-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .synthese-year-row .year {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary);
        }

        .synthese-year-row .year-stats {
            display: flex;
            gap: 12px;
            font-size: 0.85em;
        }

        .synthese-year-row .bc-ok {
            color: var(--success);
        }

        .synthese-year-row .en-attente {
            color: var(--warning);
        }

        /* ============================================
           MODULE DSF TRACKER - STYLES
           ============================================ */
        .dsf-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .dsf-tab-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 24px;
            background: var(--bg-card);
            border: 2px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
        }

        .dsf-tab-btn:hover {
            border-color: var(--primary);
            background: var(--bg-elevated);
        }

        .dsf-tab-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-color: var(--primary);
            color: white;
        }

        .dsf-tab-btn .tab-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
        }

        .dsf-tab-btn .tab-badge.danger {
            background: var(--danger);
        }

        .dsf-table-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
        }

        .table-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
        }

        .filter-inline {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-inline label {
            color: var(--text-muted);
            font-size: 0.9em;
        }

        .filter-inline select {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
        }

        .result-count {
            color: var(--text-muted);
            font-size: 0.9em;
        }

        .dsf-table {
            width: 100%;
            border-collapse: collapse;
        }

        .dsf-table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            color: white;
            font-size: 0.85em;
        }

        .dsf-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }

        .dsf-table tbody tr {
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .dsf-table tbody tr:hover {
            background: var(--bg-elevated);
        }

        .empty-state-dsf {
            text-align: center;
            padding: 60px 40px;
            display: none;
        }

        /* ============================================
           MODULE PRODUITS - STYLES
           ============================================ */
        .produits-search {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-subtle);
        }

        .search-box-large {
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--bg-elevated);
            padding: 16px 24px;
            border-radius: var(--radius-lg);
            border: 2px solid var(--border-subtle);
            margin-bottom: 16px;
            transition: all var(--transition-fast);
        }

        .search-box-large:focus-within {
            border-color: var(--primary);
            box-shadow: var(--shadow-glow);
        }

        .search-icon-lg {
            font-size: 1.5em;
        }

        .search-box-large input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1.1em;
            font-family: inherit;
        }

        .search-box-large input:focus {
            outline: none;
        }

        .search-box-large input::placeholder {
            color: var(--text-muted);
        }

        .search-count {
            color: var(--text-muted);
            font-size: 0.9em;
            white-space: nowrap;
        }

        .search-filters {
            display: flex;
            gap: 16px;
        }

        .search-filters select {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
        }

        .produits-results {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-subtle);
            min-height: 400px;
        }

        .produits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .produit-card {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: 20px;
            cursor: pointer;
            border: 2px solid var(--border-subtle);
            transition: all var(--transition-fast);
        }

        .produit-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .produit-code {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .produit-designation {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .produit-details {
            display: flex;
            justify-content: space-between;
            color: var(--text-muted);
            font-size: 0.85em;
        }

        .produit-prix {
            font-weight: 700;
            color: var(--success);
        }

        .empty-state-produits {
            text-align: center;
            padding: 60px 40px;
        }

        .produit-description {
            color: var(--text-muted);
            font-size: 0.85em;
            margin-bottom: 12px;
            max-height: 40px;
            overflow: hidden;
        }

        .produit-tarifs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .tarif-badge {
            background: var(--bg-card);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .btn-copy {
            width: 100%;
            padding: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.85em;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
        }

        .btn-copy:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .relances-history {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-subtle);
        }

        .relances-history h3 {
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
        }

        .history-date {
            color: var(--text-muted);
            font-size: 0.85em;
            min-width: 100px;
        }

        .history-type {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .history-dest {
            flex: 1;
            color: var(--text-primary);
            font-weight: 500;
        }

        .history-count {
            color: var(--text-muted);
            font-size: 0.85em;
        }

        /* ============================================
           MODULE RELANCES - STYLES
           ============================================ */
        .relances-header, .archives-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .relances-header h2, .archives-header h2 {
            font-size: 1.8em;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .relances-header p, .archives-header p {
            color: var(--text-muted);
        }

        .relances-grid, .archives-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .relance-card, .archive-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            cursor: pointer;
            border: 2px solid var(--border-subtle);
            transition: all var(--transition-fast);
        }

        .relance-card:hover, .archive-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .relance-icon, .archive-icon {
            font-size: 3em;
            margin-bottom: 16px;
        }

        .relance-info h3, .archive-card h3 {
            font-size: 1.1em;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .relance-info p, .archive-card p {
            color: var(--text-muted);
            font-size: 0.85em;
            margin-bottom: 12px;
        }

        .relance-count {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.1em;
        }

        .btn-archive-action {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
        }

        .btn-archive-action:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .relances-history {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-subtle);
        }

        .relances-history h3 {
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
        }

        .history-item .date {
            color: var(--text-muted);
            font-size: 0.85em;
            min-width: 120px;
        }

        .history-item .type {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            background: var(--primary-glow);
            color: var(--primary);
        }

        .history-item .description {
            flex: 1;
            color: var(--text-secondary);
        }

        .maintenance-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-subtle);
        }

        .maintenance-section h3 {
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .maintenance-actions {
            display: flex;
            gap: 16px;
        }

        .btn-maintenance {
            padding: 12px 24px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
        }

        .btn-maintenance:hover {
            background: var(--bg-card-hover);
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .btn-maintenance.danger {
            border-color: var(--danger);
            color: var(--danger);
        }

        .btn-maintenance.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .empty-text {
            color: var(--text-muted);
            text-align: center;
            padding: 20px;
        }

        @media (max-width: 1200px) {
            .devis-stats-grid {
                grid-template-columns: 1fr;
            }
            .relances-grid, .archives-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .search-grid {
                grid-template-columns: 1fr;
            }
            .dsf-tabs {
                flex-direction: column;
            }
            .relances-grid, .archives-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Scrollbar Custom */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--bg-elevated);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ============================================
           MODULE VISITES - Planning & Historique & Modal STT
           ============================================ */

        /* Planning Filters */
        .planning-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            border: 1px solid var(--border-card);
        }

        .planning-filters .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .planning-filters label {
            display: block;
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .planning-filters select {
            width: 100%;
            padding: 10px 14px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-card);
            background: var(--bg-elevated);
            font-size: 0.9em;
            color: var(--text-primary);
        }

        /* STT Summary Grid */
        .stt-summary-section {
            margin-bottom: 24px;
        }

        .stt-summary-section h3 {
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .stt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .stt-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 14px;
            border: 1px solid var(--border-card);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .stt-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .stt-card.has-retard {
            border-left: 4px solid var(--danger);
        }

        .stt-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .stt-card-name {
            font-weight: 700;
            color: var(--text-primary);
        }

        .stt-card-sector {
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .stt-card-sector.s1 { background: rgba(59, 130, 246, 0.2); color: var(--s1-color); }
        .stt-card-sector.s2 { background: rgba(16, 185, 129, 0.2); color: var(--s2-color); }
        .stt-card-sector.s3 { background: rgba(239, 68, 68, 0.2); color: var(--s3-color); }
        .stt-card-sector.autres { background: rgba(100, 116, 139, 0.2); color: var(--autres-color); }

        .stt-card-stats {
            display: flex;
            gap: 12px;
            font-size: 0.85em;
        }

        .stt-card-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stt-card-stat.retard {
            color: var(--danger);
            font-weight: 700;
        }

        /* Planning Table */
        .planning-table-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-card);
            overflow: hidden;
        }

        .planning-table {
            width: 100%;
            border-collapse: collapse;
        }

        .planning-table th {
            background: var(--bg-elevated);
            padding: 14px 16px;
            text-align: left;
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-card);
        }

        .planning-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.9em;
            color: var(--text-primary);
        }

        .planning-table tr:hover {
            background: var(--bg-elevated);
        }

        .planning-table .status-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .planning-table .status-badge.retard {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .planning-table .status-badge.ok {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        /* Historique */
        .historique-chart-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-card);
            margin-bottom: 24px;
            height: 300px;
        }

        .historique-table-container h3 {
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .historique-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .historique-sector-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-card);
            overflow: hidden;
        }

        .historique-sector-header {
            padding: 12px 16px;
            font-weight: 700;
            color: white;
        }

        .historique-sector-header.s1 { background: linear-gradient(135deg, var(--s1-color), var(--s1-dark)); }
        .historique-sector-header.s2 { background: linear-gradient(135deg, var(--s2-color), var(--s2-dark)); }
        .historique-sector-header.s3 { background: linear-gradient(135deg, var(--s3-color), var(--s3-dark)); }
        .historique-sector-header.autres { background: linear-gradient(135deg, var(--autres-color), var(--autres-dark)); }

        .historique-table {
            width: 100%;
            border-collapse: collapse;
        }

        .historique-table th {
            background: var(--bg-elevated);
            padding: 10px 12px;
            text-align: left;
            font-size: 0.75em;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .historique-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.85em;
        }

        .historique-table .empty-cell {
            text-align: center;
            color: var(--text-muted);
            padding: 20px;
        }

        /* Modal STT */
        .modal-stt {
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
        }

        .modal-stt .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Onglets dans la modal STT */
        .modal-stt-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--border-medium);
        }

        .modal-stt-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            position: relative;
            transition: all 0.3s ease;
        }

        .modal-stt-tab:hover {
            color: var(--text-primary);
            background: var(--bg-elevated);
        }

        .modal-stt-tab.active {
            color: var(--primary);
        }

        .modal-stt-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            border-radius: 2px 2px 0 0;
        }

        .modal-stt-tab.retard { color: var(--danger); }
        .modal-stt-tab.retard.active { color: var(--danger); }
        .modal-stt-tab.retard.active::after { background: var(--danger); }

        .modal-stt-tab.planifier { color: var(--info); }
        .modal-stt-tab.planifier.active { color: var(--info); }
        .modal-stt-tab.planifier.active::after { background: var(--info); }

        .modal-stt-tab-count {
            background: var(--bg-elevated);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 6px;
        }

        .modal-stt-tab.retard .modal-stt-tab-count { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .modal-stt-tab.planifier .modal-stt-tab-count { background: rgba(14, 165, 233, 0.15); color: var(--info); }

        .modal-stt-content {
            display: none;
        }

        .modal-stt-content.active {
            display: block;
        }

        .stt-info-card {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 16px;
        }

        .stt-info-row {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
        }

        .stt-info-row:last-child {
            margin-bottom: 0;
        }

        .stt-info-label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 80px;
        }

        .stt-info-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .stt-info-value.email {
            color: var(--info);
        }

        .mail-history-card {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 16px;
        }

        .mail-history-card h4 {
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .mail-dates {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .mail-date-row {
            display: flex;
            gap: 12px;
        }

        .mail-date-label {
            color: var(--text-secondary);
            min-width: 120px;
        }

        .mail-date-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .sites-retard-section {
            margin-bottom: 16px;
        }

        .sites-retard-section h4 {
            margin-bottom: 12px;
        }

        .sites-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-card);
            border-radius: var(--radius-md);
        }

        .sites-retard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .sites-retard-table th {
            background: var(--bg-elevated);
            padding: 10px 12px;
            text-align: left;
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
        }

        .sites-retard-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.85em;
        }

        .mail-status {
            text-align: center;
            padding: 10px;
            color: var(--text-secondary);
        }

        .mail-status.success {
            color: var(--success);
        }

        .mail-status.error {
            color: var(--danger);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        /* Input File Hidden */
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Auth Loading Screen -->
    <div id="auth-loading">
        <div class="auth-spinner"></div>
        <div class="auth-text">Vérification de l'authentification...</div>
    </div>
    
    <!-- User Info & Logout -->
    <div class="user-info" id="userInfo" style="display: none;">
        <span class="user-info-icon">👤</span>
        <span id="userEmail">-</span>
    </div>
    <button class="logout-btn" id="logoutBtn" onclick="handleLogout()" style="display: none;">
        <span>🚪</span>
        <span>Déconnexion</span>
    </button>
    
    <div class="app-container">
        <!-- ============================================
             SIDEBAR
             ============================================ -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="sidebar-logo" onclick="navigateTo('dashboard')">
                    <div class="logo-icon">🏢</div>
                    <span class="logo-text">GESTION PRO</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <!-- Dashboard -->
                <div class="nav-section">
                    <div class="nav-item active" data-page="dashboard" onclick="navigateTo('dashboard')">
                        <span class="nav-icon">📊</span>
                        <span class="nav-text">Dashboard</span>
                    </div>
                </div>

                <!-- Analyses -->
                <div class="nav-section">
                    <div class="nav-section-title">Analyses</div>
                    <div class="nav-item" data-page="visites" onclick="navigateTo('visites')">
                        <span class="nav-icon">📅</span>
                        <span class="nav-text">Visites SSI/DSF</span>
                    </div>
                    <div class="nav-item" data-page="dsf" onclick="navigateTo('dsf')">
                        <span class="nav-icon">📈</span>
                        <span class="nav-text">DSF Tracker</span>
                        <span class="nav-badge" id="badge-dsf">0</span>
                    </div>
                    <div class="nav-item" data-page="devis" onclick="navigateTo('devis')">
                        <span class="nav-icon">📄</span>
                        <span class="nav-text">Devis</span>
                    </div>
                    <div class="nav-item" data-page="travaux" onclick="navigateTo('travaux')">
                        <span class="nav-icon">📋</span>
                        <span class="nav-text">Travaux</span>
                        <span class="nav-badge" id="badge-travaux">0</span>
                    </div>
                </div>

                <!-- Outils -->
                <div class="nav-section">
                    <div class="nav-section-title">Outils</div>
                    <div class="nav-item" data-page="searchssi" onclick="navigateTo('searchssi')">
                        <span class="nav-icon">🔍</span>
                        <span class="nav-text">Recherche Client</span>
                    </div>
                    <div class="nav-item" data-page="produits" onclick="navigateTo('produits')">
                        <span class="nav-icon">📦</span>
                        <span class="nav-text">Recherche Réf Produit</span>
                    </div>
                    <div class="nav-item" data-page="relances" onclick="navigateTo('relances')">
                        <span class="nav-icon">📧</span>
                        <span class="nav-text">Relances</span>
                    </div>
                </div>

                <!-- Système -->
                <div class="nav-section">
                    <div class="nav-section-title">Système</div>
                    <div class="nav-item" data-page="archives" onclick="navigateTo('archives')">
                        <span class="nav-icon">🗄️</span>
                        <span class="nav-text">Archives</span>
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="data-status">
                    <span class="status-dot" id="statusDot"></span>
                    <span class="status-text" id="statusText">Aucune donnée</span>
                </div>
            </div>
        </aside>

        <!-- ============================================
             MAIN CONTENT
             ============================================ -->
        <main class="main-content">
            <!-- Header -->
            <header class="main-header">
                <div class="header-title">
                    <h1 id="pageTitle">📊 Dashboard</h1>
                    <div class="header-week" id="headerWeek">Semaine 51 - 2025</div>
                </div>
                <div class="header-actions">
                    <button class="btn-header btn-import" onclick="document.getElementById('fileInput').click()">
                        <span>📥</span>
                        <span>Importer Excel</span>
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                
                <!-- ============================================
                     PAGE: DASHBOARD
                     ============================================ -->
                <div id="page-dashboard" class="page active">
                    
                    <!-- État initial: Import -->
                    <div id="importZone" class="import-zone">
                        <div class="import-card" id="importCard">
                            <div class="import-icon">📁</div>
                            <h2>Importer vos données</h2>
                            <p>Glissez votre fichier Excel ici ou cliquez pour sélectionner</p>
                            <p class="formats">Formats acceptés: .xlsx, .xls</p>
                        </div>
                        
                        <div class="import-options">
                            <div class="import-option" onclick="document.getElementById('fileInput').click()">
                                <span>📊</span>
                                <span>Fichier Excel unique</span>
                            </div>
                            <div class="import-option access" onclick="showAccessConfig()">
                                <span>🔗</span>
                                <span>Connexion Access (Bridge)</span>
                            </div>
                        </div>

                        <div class="import-status" id="importStatus">
                            <p style="color: var(--text-secondary); margin-bottom: 16px;">Feuilles chargées :</p>
                            <div class="sheets-loaded" id="sheetsLoaded"></div>
                        </div>
                    </div>

                    <!-- Dashboard (affiché après import) -->
                    <div id="dashboardContent" class="dashboard-grid hidden">
                        
                        <!-- FILTRE SECTEUR EN HAUT -->
                        <div class="dashboard-filter">
                            <label>🎯 Filtrer par secteur :</label>
                            <select id="dashboardSectorFilter" onchange="DASHBOARD.filterBySector()">
                                <option value="TOUS">Tous les secteurs</option>
                                <option value="S1">🔵 Secteur S1</option>
                                <option value="S2">🟢 Secteur S2</option>
                                <option value="S3">🔴 Secteur S3</option>
                                <option value="AUTRES">⚪ Autres</option>
                            </select>
                            <div style="margin-left: auto; display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 0.85em; color: var(--text-muted);">Semaine</span>
                                <span id="dashboardWeekNum" style="font-weight: 700; color: var(--emerald); font-size: 1.1em;">--</span>
                                <span id="dashboardVisitType" style="padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; background: var(--emerald); color: white;">V1/V2</span>
                            </div>
                        </div>

                        <!-- VISITES SSI PAR SECTEUR -->
                        <div class="sectors-section">
                            <div class="section-header">
                                <h2 class="section-title">
                                    <span class="icon">🔧</span>
                                    Visites SSI par secteur
                                </h2>
                                <div id="ssiObjectifInfo" style="font-size: 0.85em; color: var(--text-secondary);">Objectif: -- visites/semaine</div>
                            </div>
                            <div class="sectors-grid" id="sectorsSSI">
                                <!-- S1 -->
                                <div class="sector-card s1">
                                    <div class="sector-header">
                                        <span class="sector-name">🔵 Secteur S1</span>
                                        <span class="sector-sites"><span id="ssiS1Sites">0</span> sites</span>
                                    </div>
                                    <div class="sector-stats">
                                        <div class="sector-stat-row">
                                            <span class="stat-label">V1 restantes</span>
                                            <div class="stat-value">
                                                <span class="stat-number" id="ssiS1V1">0</span>
                                                <span class="stat-percent good" id="ssiS1V1Pct">0%</span>
                                            </div>
                                        </div>
                                        <div class="sector-stat-row">
                                            <span class="stat-label">V2 restantes</span>
                                            <div class="stat-value">
                                                <span class="stat-number" id="ssiS1V2">0</span>
                                                <span class="stat-percent good" id="ssiS1V2Pct">0%</span>
                                            </div>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="ssiS1Progress" style="width: 0%"></div>
                                        </div>
                                        <div class="sector-objectif" id="ssiS1Objectif">~0/sem</div>
                                    </div>
                                </div>

                                <!-- S2 -->
                                <div class="sector-card s2">
                                    <div class="sector-header">
                                        <span class="sector-name">🟢 Secteur S2</span>
                                        <span class="sector-sites"><span id="ssiS2Sites">0</span> sites</span>
                                    </div>
                                    <div class="sector-stats">
                                        <div class="sector-stat-row">
                                            <span class="stat-label">V1 restantes</span>
                                            <div class="stat-value">
                                                <span class="stat-number" id="ssiS2V1">0</span>
                                                <span class="stat-percent good" id="ssiS2V1Pct">0%</span>
                                            </div>
                                        </div>
                                        <div class="sector-stat-row">
                                            <span class="stat-label">V2 restantes</span>
                                            <div class="stat-value">
                                                <span class="stat-number" id="ssiS2V2">0</span>
                                                <span class="stat-percent good" id="ssiS2V2Pct">0%</span>
                                            </div>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="ssiS2Progress" style="width: 0%"></div>
                                        </div>
                                        <div class="sector-objectif" id="ssiS2Objectif">~0/sem</div>
                                    </div>
                                </div>

                                <!-- S3 -->
                                <div class="sector-card s3">
                                    <div class="sector-header">
                                        <span class="sector-name">🔴 Secteur S3</span>
                                        <span class="sector-sites"><span id="ssiS3Sites">0</span> sites</span>
                                    </div>
                                    <div class="sector-stats">
                                        <div class="sector-stat-row">
                                            <span class="stat-label">V1 restantes</span>
                                            <div class="stat-value">
                                                <span class="stat-number" id="ssiS3V1">0</span>
                                                <span class="stat-percent danger" id="ssiS3V1Pct">0%</span>
                                            </div>
                                        </div>
                                        <div class="sector-stat-row">
                                            <span class="stat-label">V2 restantes</span>
                                            <div class="stat-value">
                                                <span class="stat-number" id="ssiS3V2">0</span>
                                                <span class="stat-percent danger" id="ssiS3V2Pct">0%</span>
                                            </div>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="ssiS3Progress" style="width: 0%"></div>
                                        </div>
                                        <div class="sector-objectif" id="ssiS3Objectif">~0/sem</div>
                                    </div>
                                </div>

                                <!-- Autres -->
                                <div class="sector-card autres">
                                    <div class="sector-header">
                                        <span class="sector-name">⚪ Autres</span>
                                        <span class="sector-sites"><span id="ssiAutresSites">0</span> sites</span>
                                    </div>
                                    <div class="sector-stats">
                                        <div class="sector-stat-row">
                                            <span class="stat-label">V1 restantes</span>
                                            <div class="stat-value">
                                                <span class="stat-number" id="ssiAutresV1">0</span>
                                                <span class="stat-percent" id="ssiAutresV1Pct">0%</span>
                                            </div>
                                        </div>
                                        <div class="sector-stat-row">
                                            <span class="stat-label">V2 restantes</span>
                                            <div class="stat-value">
                                                <span class="stat-number" id="ssiAutresV2">0</span>
                                                <span class="stat-percent" id="ssiAutresV2Pct">0%</span>
                                            </div>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="ssiAutresProgress" style="width: 0%"></div>
                                        </div>
                                        <div class="sector-objectif" id="ssiAutresObjectif">~0/sem</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- VISITES DSF PAR SECTEUR -->
                        <div class="sectors-section">
                            <div class="section-header">
                                <h2 class="section-title">
                                    <span class="icon">🔥</span>
                                    Visites DSF par secteur
                                </h2>
                            </div>
                            <div class="sectors-grid" id="sectorsDSF">
                                <div class="sector-card s1">
                                    <div class="sector-header">
                                        <span class="sector-name">🔵 Secteur S1</span>
                                        <span class="sector-sites"><span id="dsfS1Sites">0</span> sites</span>
                                    </div>
                                    <div class="sector-stats">
                                        <div class="sector-stat-row">
                                            <span class="stat-label">Restantes</span>
                                            <div class="stat-value">
                                                <span class="stat-number" id="dsfS1Rest">0</span>
                                                <span class="stat-percent good" id="dsfS1Pct">0%</span>
                                            </div>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="dsfS1Progress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="sector-card s2">
                                    <div class="sector-header">
                                        <span class="sector-name">🟢 Secteur S2</span>
                                        <span class="sector-sites"><span id="dsfS2Sites">0</span> sites</span>
                                    </div>
                                    <div class="sector-stats">
                                        <div class="sector-stat-row">
                                            <span class="stat-label">Restantes</span>
                                            <div class="stat-value">
                                                <span class="stat-number" id="dsfS2Rest">0</span>
                                                <span class="stat-percent good" id="dsfS2Pct">0%</span>
                                            </div>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="dsfS2Progress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="sector-card s3">
                                    <div class="sector-header">
                                        <span class="sector-name">🔴 Secteur S3</span>
                                        <span class="sector-sites"><span id="dsfS3Sites">0</span> sites</span>
                                    </div>
                                    <div class="sector-stats">
                                        <div class="sector-stat-row">
                                            <span class="stat-label">Restantes</span>
                                            <div class="stat-value">
                                                <span class="stat-number" id="dsfS3Rest">0</span>
                                                <span class="stat-percent danger" id="dsfS3Pct">0%</span>
                                            </div>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="dsfS3Progress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="sector-card autres">
                                    <div class="sector-header">
                                        <span class="sector-name">⚪ Autres</span>
                                        <span class="sector-sites"><span id="dsfAutresSites">0</span> sites</span>
                                    </div>
                                    <div class="sector-stats">
                                        <div class="sector-stat-row">
                                            <span class="stat-label">Restantes</span>
                                            <div class="stat-value">
                                                <span class="stat-number" id="dsfAutresRest">0</span>
                                                <span class="stat-percent" id="dsfAutresPct">0%</span>
                                            </div>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="dsfAutresProgress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- DSF NON CLOTURÉS PAR SECTEUR + TRAVAUX PAR SECTEUR -->
                        <div class="stats-row-full">
                            <!-- DSF par secteur -->
                            <div class="stats-card-full dsf-stats-full">
                                <div class="stats-card-header">
                                    <h3>🔥 DSF par secteur</h3>
                                </div>
                                <div class="dsf-sectors-grid">
                                    <!-- S1 -->
                                    <div class="dsf-sector-card s1">
                                        <div class="dsf-sector-header">
                                            <span class="sector-badge s1">🔵 S1</span>
                                        </div>
                                        <div class="dsf-sector-stats">
                                            <div class="dsf-mini-stat" onclick="navigateTo('dsf'); DSF.switchTab('cloture');">
                                                <span class="dsf-mini-value" id="dsfS1Cloture">0</span>
                                                <span class="dsf-mini-label">CLOT</span>
                                            </div>
                                            <div class="dsf-mini-stat" onclick="navigateTo('dsf'); DSF.switchTab('resp');">
                                                <span class="dsf-mini-value" id="dsfS1Resp">0</span>
                                                <span class="dsf-mini-label">RESP</span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- S2 -->
                                    <div class="dsf-sector-card s2">
                                        <div class="dsf-sector-header">
                                            <span class="sector-badge s2">🟢 S2</span>
                                        </div>
                                        <div class="dsf-sector-stats">
                                            <div class="dsf-mini-stat">
                                                <span class="dsf-mini-value" id="dsfS2Cloture">0</span>
                                                <span class="dsf-mini-label">CLOT</span>
                                            </div>
                                            <div class="dsf-mini-stat">
                                                <span class="dsf-mini-value" id="dsfS2Resp">0</span>
                                                <span class="dsf-mini-label">RESP</span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- S3 -->
                                    <div class="dsf-sector-card s3">
                                        <div class="dsf-sector-header">
                                            <span class="sector-badge s3">🔴 S3</span>
                                        </div>
                                        <div class="dsf-sector-stats">
                                            <div class="dsf-mini-stat">
                                                <span class="dsf-mini-value" id="dsfS3Cloture">0</span>
                                                <span class="dsf-mini-label">CLOT</span>
                                            </div>
                                            <div class="dsf-mini-stat">
                                                <span class="dsf-mini-value" id="dsfS3Resp">0</span>
                                                <span class="dsf-mini-label">RESP</span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Autres -->
                                    <div class="dsf-sector-card autres">
                                        <div class="dsf-sector-header">
                                            <span class="sector-badge autres">⚪ Autres</span>
                                        </div>
                                        <div class="dsf-sector-stats">
                                            <div class="dsf-mini-stat">
                                                <span class="dsf-mini-value" id="dsfAutresCloture">0</span>
                                                <span class="dsf-mini-label">CLOT</span>
                                            </div>
                                            <div class="dsf-mini-stat">
                                                <span class="dsf-mini-value" id="dsfAutresResp">0</span>
                                                <span class="dsf-mini-label">RESP</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TRAVAUX PAR SECTEUR -->
                        <div class="travaux-sectors-section">
                            <div class="section-header">
                                <h2 class="section-title">
                                    <span class="icon">🔧</span>
                                    Travaux par secteur
                                </h2>
                            </div>
                            <div class="travaux-sectors-grid">
                                <div class="travaux-sector-card s1" onclick="navigateTo('travaux'); document.getElementById('travauxSecteurFilter').value='S1'; TRAVAUX.filter();">
                                    <div class="travaux-sector-icon">🔵</div>
                                    <div class="travaux-sector-info">
                                        <span class="travaux-sector-name">Secteur S1</span>
                                        <span class="travaux-sector-count" id="travauxS1Count">0</span>
                                    </div>
                                </div>
                                <div class="travaux-sector-card s2" onclick="navigateTo('travaux'); document.getElementById('travauxSecteurFilter').value='S2'; TRAVAUX.filter();">
                                    <div class="travaux-sector-icon">🟢</div>
                                    <div class="travaux-sector-info">
                                        <span class="travaux-sector-name">Secteur S2</span>
                                        <span class="travaux-sector-count" id="travauxS2Count">0</span>
                                    </div>
                                </div>
                                <div class="travaux-sector-card s3" onclick="navigateTo('travaux'); document.getElementById('travauxSecteurFilter').value='S3'; TRAVAUX.filter();">
                                    <div class="travaux-sector-icon">🔴</div>
                                    <div class="travaux-sector-info">
                                        <span class="travaux-sector-name">Secteur S3</span>
                                        <span class="travaux-sector-count" id="travauxS3Count">0</span>
                                    </div>
                                </div>
                                <div class="travaux-sector-card autres" onclick="navigateTo('travaux'); document.getElementById('travauxSecteurFilter').value='AUTRES'; TRAVAUX.filter();">
                                    <div class="travaux-sector-icon">⚪</div>
                                    <div class="travaux-sector-info">
                                        <span class="travaux-sector-name">Autres</span>
                                        <span class="travaux-sector-count" id="travauxAutresCount">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- GRAPHIQUE ÉVOLUTION HEBDOMADAIRE -->
                        <div class="card-section chart-section">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <span>📊</span>
                                    Évolution hebdomadaire
                                </h3>
                                <select id="chartSectorFilter" onchange="DASHBOARD.updateChart()" style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid var(--border-card); background: var(--bg-elevated); font-size: 0.85em;">
                                    <option value="TOUS">Tous les secteurs</option>
                                    <option value="S1">🔵 S1</option>
                                    <option value="S2">🟢 S2</option>
                                    <option value="S3">🔴 S3</option>
                                    <option value="AUTRES">⚪ Autres</option>
                                </select>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="evolutionChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- KPIs EN BAS -->
                        <div class="kpi-row">
                            <div class="kpi-card ca" onclick="navigateTo('travaux')">
                                <div class="kpi-header">
                                    <div class="kpi-icon">💰</div>
                                    <span class="kpi-trend up" id="kpiCaTrend">+12%</span>
                                </div>
                                <div class="kpi-value" id="kpiCa">0 €</div>
                                <div class="kpi-label">Chiffre d'affaires</div>
                            </div>

                            <div class="kpi-card travaux" onclick="navigateTo('travaux')">
                                <div class="kpi-header">
                                    <div class="kpi-icon">📋</div>
                                </div>
                                <div class="kpi-value" id="kpiTravaux">0</div>
                                <div class="kpi-label">Travaux en cours</div>
                            </div>

                            <div class="kpi-card devis" onclick="navigateTo('devis')">
                                <div class="kpi-header">
                                    <div class="kpi-icon">📄</div>
                                </div>
                                <div class="kpi-value" id="kpiDevis">0</div>
                                <div class="kpi-label">Devis en attente</div>
                            </div>

                            <div class="kpi-card visites" onclick="navigateTo('visites')">
                                <div class="kpi-header">
                                    <div class="kpi-icon">📅</div>
                                </div>
                                <div class="kpi-value" id="kpiVisites">0</div>
                                <div class="kpi-label">Visites restantes</div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- ============================================
                     PAGE: TRAVAUX (Module complet)
                     ============================================ -->
                <div id="page-travaux" class="page">
                    
                    <!-- Filtres Travaux -->
                    <div class="travaux-filters">
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label>👤 Technicien INFO</label>
                                <select id="travauxTechFilter">
                                    <option value="TOUS">Tous les techniciens</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>✍️ Rédacteur Devis</label>
                                <select id="travauxRedacteurFilter">
                                    <option value="TOUS">Tous les rédacteurs</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>📍 Secteur</label>
                                <select id="travauxSecteurFilter">
                                    <option value="TOUS">Tous les secteurs</option>
                                    <option value="S1">Secteur S1</option>
                                    <option value="S2">Secteur S2</option>
                                    <option value="S3">Secteur S3</option>
                                    <option value="AUTRES">Autres</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>🏢 Sous-traitant</label>
                                <select id="travauxSttFilter">
                                    <option value="TOUS">Tous</option>
                                    <option value="AVEC">Avec STT</option>
                                    <option value="SANS">Sans STT</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>📅 Année</label>
                                <select id="travauxAnneeFilter">
                                    <option value="TOUS">Toutes</option>
                                </select>
                            </div>
                        </div>
                        <div class="filters-actions">
                            <button class="btn-action email-redacteur" id="btnEmailRedacteur" onclick="TRAVAUX.sendEmailRedacteur()">
                                📧 Email Rédacteur
                            </button>
                            <button class="btn-action email-stt" id="btnEmailSttList" onclick="TRAVAUX.openSttModal()">
                                📧 Emails STT
                            </button>
                        </div>
                    </div>

                    <!-- Stats Travaux -->
                    <div class="travaux-stats">
                        <div class="stat-card-travaux ca" onclick="TRAVAUX.openModalCA()">
                            <div class="stat-icon">💰</div>
                            <div class="stat-info">
                                <div class="stat-value" id="travauxCA">0 €</div>
                                <div class="stat-label">Total CA</div>
                            </div>
                        </div>
                        <div class="stat-card-travaux secteur" onclick="TRAVAUX.openModalSecteur()">
                            <div class="stat-icon">📊</div>
                            <div class="stat-info">
                                <div class="stat-value" id="travauxNbSecteur">0</div>
                                <div class="stat-label">Travaux (Secteur)</div>
                            </div>
                        </div>
                        <div class="stat-card-travaux tech" onclick="TRAVAUX.openModalTechnicien()">
                            <div class="stat-icon">👷</div>
                            <div class="stat-info">
                                <div class="stat-value" id="travauxNbTech">0</div>
                                <div class="stat-label">Travaux (Tech)</div>
                            </div>
                        </div>
                        <div class="stat-card-travaux stt" onclick="TRAVAUX.openModalStatsStt()">
                            <div class="stat-icon">🏢</div>
                            <div class="stat-info">
                                <div class="stat-value" id="travauxNbStt">0</div>
                                <div class="stat-label">Travaux STT</div>
                            </div>
                        </div>
                        <div class="stat-card-travaux budget" onclick="TRAVAUX.openModalBudgetStt()">
                            <div class="stat-icon">💵</div>
                            <div class="stat-info">
                                <div class="stat-value" id="travauxBudgetStt">0 €</div>
                                <div class="stat-label">Budget STT</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tableau Travaux -->
                    <div class="travaux-table-container">
                        <div class="table-header-info">
                            <span id="travauxCount">0 travaux</span>
                            <div class="table-legend">
                                <span class="legend-item stt">🟡 Avec sous-traitant</span>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table class="travaux-table" id="travauxTable">
                                <thead id="travauxTableHead"></thead>
                                <tbody id="travauxTableBody"></tbody>
                            </table>
                        </div>
                        <div class="empty-state-travaux" id="travauxEmptyState">
                            <div class="empty-icon">📋</div>
                            <h3>Aucune donnée</h3>
                            <p>Importez un fichier Excel avec la feuille TRAVAUX</p>
                        </div>
                    </div>

                </div>

                <!-- Modal Détail Client Travaux -->
                <div id="travauxDetailModal" class="modal-overlay">
                    <div class="modal-container large">
                        <button class="modal-close" onclick="TRAVAUX.closeDetail()">×</button>
                        <h2 class="modal-title">📋 Fiche Client Détaillée</h2>
                        <div class="modal-nav">
                            <button class="btn-nav" id="travauxPrevBtn" onclick="TRAVAUX.navigate(-1)">← Précédent</button>
                            <span class="nav-counter" id="travauxNavCounter">1 / 1</span>
                            <button class="btn-nav" id="travauxNextBtn" onclick="TRAVAUX.navigate(1)">Suivant →</button>
                            <button class="btn-action email-stt" id="travauxEmailSttBtn" onclick="TRAVAUX.sendEmailSttSingle()" style="display: none;">📧 Email STT</button>
                        </div>
                        <div class="modal-body" id="travauxDetailContent"></div>
                    </div>
                </div>

                <!-- Modal Emails STT -->
                <div id="travauxSttModal" class="modal-overlay">
                    <div class="modal-container large">
                        <button class="modal-close" onclick="TRAVAUX.closeSttModal()">×</button>
                        <h2 class="modal-title">📧 Gestion Emails Sous-traitants</h2>
                        <div class="stt-tabs-container">
                            <button class="stt-tab-btn active" data-tab="aPlanifier" onclick="TRAVAUX.switchSttTab('aPlanifier')">📅 À Planifier</button>
                            <button class="stt-tab-btn" data-tab="planifies" onclick="TRAVAUX.switchSttTab('planifies')">✅ Déjà Planifiés</button>
                        </div>
                        <div class="modal-body" id="travauxSttContent"></div>
                        <div class="modal-footer">
                            <button class="btn-action primary" onclick="TRAVAUX.sendSelectedSttEmails()">📧 Envoyer aux sélectionnés</button>
                        </div>
                    </div>
                </div>

                <!-- Modal Stats (CA, Secteur, Technicien, Budget STT) -->
                <div id="travauxStatsModal" class="modal-overlay">
                    <div class="modal-container">
                        <button class="modal-close" onclick="TRAVAUX.closeStatsModal()">×</button>
                        <h2 class="modal-title" id="travauxStatsModalTitle">📊 Statistiques</h2>
                        <div class="modal-body" id="travauxStatsContent"></div>
                        <div class="stats-total" id="travauxStatsTotal"></div>
                    </div>
                </div>

                <!-- ============================================
                     PAGE: DEVIS (Module complet)
                     ============================================ -->
                <div id="page-devis" class="page">
                    
                    <!-- Recherche Devis - IDENTIQUE AU FICHIER ORIGINAL -->
                    <div class="devis-search-section">
                        <div class="search-grid">
                            <div class="search-field">
                                <label>🔍 Recherche par N° Client</label>
                                <input type="text" id="devisSearchClient" placeholder="Entrez le numéro du client...">
                            </div>
                            <div class="search-field">
                                <label>📄 Recherche par N° Devis</label>
                                <input type="text" id="devisSearchDevis" placeholder="Entrez le numéro de devis...">
                            </div>
                            <div class="search-field">
                                <label>✍️ Recherche par Rédacteur</label>
                                <input type="text" id="devisSearchRedacteur" placeholder="Entrez le nom du rédacteur...">
                            </div>
                        </div>
                    </div>

                    <!-- Stats Devis - 3 colonnes IDENTIQUE AU FICHIER ORIGINAL -->
                    <div class="synthese-contrat-section" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <!-- Synthèse par Année - Couleur violet/bleu -->
                        <div class="synthese-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white;">
                            <div class="synthese-title" style="font-size: 18px; font-weight: 700; margin-bottom: 15px; text-align: center;">📊 Synthèse par Année</div>
                            <div class="synthese-content" id="devisSyntheseContent" style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Chargez un fichier pour voir la synthèse</div>
                            </div>
                        </div>
                        
                        <!-- Synthèse STT - Couleur rose/rouge -->
                        <div class="stt-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: white;">
                            <div class="stt-title" style="font-size: 18px; font-weight: 700; margin-bottom: 15px; text-align: center;">🏢 Synthèse STT</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div style="background: rgba(255, 255, 255, 0.2); padding: 12px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px; opacity: 0.9;">Budget Total</div>
                                    <div style="font-size: 20px; font-weight: 700;" id="devisTotalBudgetSTT">-- €</div>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.2); padding: 12px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px; opacity: 0.9;">Nombre STT</div>
                                    <div style="font-size: 20px; font-weight: 700;" id="devisCountSTT">0</div>
                                </div>
                            </div>
                            <div style="background: rgba(255, 255, 255, 0.15); padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; opacity: 0.9; text-align: center;">Budget par Année (Tous STT)</div>
                                <div id="devisBudgetParAnneeSTT" style="display: flex; flex-direction: column; gap: 6px;">
                                    <div style="text-align: center; color: rgba(255,255,255,0.7); font-size: 12px;">Chargez un fichier</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <select class="stt-dropdown" id="devisSttSelect" style="width: 100%; padding: 10px; margin-bottom: 15px; border: none; border-radius: 6px; background: rgba(255, 255, 255, 0.9); color: #333; font-weight: 600; cursor: pointer;">
                                        <option value="">Sélectionnez un STT...</option>
                                    </select>
                                </div>
                                <div class="stt-content" id="devisSttContent">
                                    <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px; font-size: 14px;">Sélectionnez un STT</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Contrat SSI - Couleur violet -->
                        <div class="contrat-box" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); padding: 20px; border-radius: 10px; color: white;">
                            <div class="contrat-title" style="font-size: 18px; font-weight: 700; margin-bottom: 15px; text-align: center;">💼 Contrat SSI</div>
                            <div class="contrat-content" style="display: flex; flex-direction: column; gap: 15px;">
                                <div class="contrat-item" style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 6px;">
                                    <div class="contrat-label" style="font-size: 12px; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">Valeur du contrat</div>
                                    <div class="contrat-value" style="font-size: 24px; font-weight: 700;" id="devisValeurContrat">-- €</div>
                                </div>
                                <div class="contrat-item" style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 6px;">
                                    <div class="contrat-label" style="font-size: 12px; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">Taux horaire</div>
                                    <div class="contrat-value" style="font-size: 24px; font-weight: 700;" id="devisTauxHoraire">-- €</div>
                                    <div class="contrat-value-small" style="font-size: 16px; font-weight: 600; margin-top: 5px; opacity: 0.95;" id="devisPourcentageTaux">--% du contrat</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section Résultats Devis - STYLE IDENTIQUE AU FICHIER ORIGINAL -->
                    <div class="devis-list-container" id="devisResultsSection" style="display: none; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px;">
                        <div class="results-header" style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">
                            <span id="devisResultsCount" style="color: #667eea; font-weight: 600; font-size: 18px;">0 devis trouvés</span>
                        </div>
                        <div class="devis-list" id="devisDevisList" style="display: grid; gap: 15px;"></div>
                    </div>

                </div>

                <!-- Modal Détail Devis - IDENTIQUE AU FICHIER ORIGINAL -->
                <div id="devisDetailModal" class="modal-overlay">
                    <div class="modal-container large">
                        <div class="modal-header-devis" style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 25px 30px; border-radius: var(--radius-lg) var(--radius-lg) 0 0; display: flex; justify-content: space-between; align-items: center;">
                            <h2 id="devisModalTitle" style="font-size: 1.4em; margin: 0;">Détails du Devis</h2>
                            <div class="nav-buttons" style="display: flex; gap: 10px; align-items: center;">
                                <button class="nav-btn" id="devisPrevBtn" onclick="DEVIS.navigate(-1)" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 20px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">←</button>
                                <span class="nav-info" id="devisNavInfo" style="color: white; font-size: 0.9em; font-weight: 600;">1/1</span>
                                <button class="nav-btn" id="devisNextBtn" onclick="DEVIS.navigate(1)" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 20px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">→</button>
                                <button class="close-btn" onclick="DEVIS.closeDetail()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: 10px;">×</button>
                            </div>
                        </div>
                        <div class="modal-body" id="devisModalBody" style="padding: 30px;"></div>
                    </div>
                </div>

                <!-- ============================================
                     PAGE: VISITES (Module complet)
                     ============================================ -->
                <div id="page-visites" class="page">
                    
                    <!-- En-tête Visites -->
                    <div class="visites-header">
                        <div class="week-banner">
                            <div class="week-info-main">
                                <h2 id="visitesWeekTitle">📅 Semaine 51</h2>
                                <p id="visitesWeekPeriod">16 décembre 2025 - 22 décembre 2025</p>
                            </div>
                            <div class="visit-type-badge" id="visitTypeBadge">
                                <span>V2</span>
                                <small>Semaines 27-52</small>
                            </div>
                        </div>
                    </div>

                    <!-- Onglets SSI / DSF / Historique -->
                    <div class="visites-tabs">
                        <button class="visites-tab active" data-tab="ssi" onclick="switchVisitesTab('ssi')">
                            <span class="tab-icon">🔧</span>
                            <span class="tab-label">SSI</span>
                            <span class="tab-count" id="tabCountSSI">0</span>
                        </button>
                        <button class="visites-tab" data-tab="dsf" onclick="switchVisitesTab('dsf')">
                            <span class="tab-icon">🔥</span>
                            <span class="tab-label">DSF</span>
                            <span class="tab-count" id="tabCountDSF">0</span>
                        </button>
                        <button class="visites-tab" data-tab="historique" onclick="switchVisitesTab('historique')">
                            <span class="tab-icon">📊</span>
                            <span class="tab-label">Historique</span>
                        </button>
                    </div>

                    <!-- Contenu SSI -->
                    <div id="visites-ssi" class="visites-content active">
                        
                        <!-- Stats SSI par secteur -->
                        <div class="section-header">
                            <h2 class="section-title">
                                <span class="icon">📈</span>
                                Résumé SSI par secteur - Semaine <span id="ssiWeekNum">51</span>
                            </h2>
                            <button class="btn-archive" onclick="archiveSSIWeek()">
                                <span>💾</span> Archiver cette semaine
                            </button>
                        </div>

                        <div class="sectors-stats-grid">
                            <!-- S1 -->
                            <div class="sector-stat-card s1">
                                <div class="sector-stat-header">
                                    <span class="sector-badge s1">🔵 S1</span>
                                    <span class="sites-count"><span id="ssiStatS1Sites">0</span> sites</span>
                                </div>
                                <div class="sector-stat-body">
                                    <div class="visit-row">
                                        <div class="visit-type">V1</div>
                                        <div class="visit-data">
                                            <span class="visit-remaining" id="ssiStatS1V1">0</span>
                                            <span class="visit-percent good" id="ssiStatS1V1Pct">0%</span>
                                        </div>
                                        <div class="progress-mini">
                                            <div class="progress-mini-fill" id="ssiStatS1V1Bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="visit-row">
                                        <div class="visit-type">V2</div>
                                        <div class="visit-data">
                                            <span class="visit-remaining" id="ssiStatS1V2">0</span>
                                            <span class="visit-percent good" id="ssiStatS1V2Pct">0%</span>
                                        </div>
                                        <div class="progress-mini">
                                            <div class="progress-mini-fill" id="ssiStatS1V2Bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- S2 -->
                            <div class="sector-stat-card s2">
                                <div class="sector-stat-header">
                                    <span class="sector-badge s2">🟢 S2</span>
                                    <span class="sites-count"><span id="ssiStatS2Sites">0</span> sites</span>
                                </div>
                                <div class="sector-stat-body">
                                    <div class="visit-row">
                                        <div class="visit-type">V1</div>
                                        <div class="visit-data">
                                            <span class="visit-remaining" id="ssiStatS2V1">0</span>
                                            <span class="visit-percent good" id="ssiStatS2V1Pct">0%</span>
                                        </div>
                                        <div class="progress-mini">
                                            <div class="progress-mini-fill" id="ssiStatS2V1Bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="visit-row">
                                        <div class="visit-type">V2</div>
                                        <div class="visit-data">
                                            <span class="visit-remaining" id="ssiStatS2V2">0</span>
                                            <span class="visit-percent good" id="ssiStatS2V2Pct">0%</span>
                                        </div>
                                        <div class="progress-mini">
                                            <div class="progress-mini-fill" id="ssiStatS2V2Bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- S3 -->
                            <div class="sector-stat-card s3">
                                <div class="sector-stat-header">
                                    <span class="sector-badge s3">🔴 S3</span>
                                    <span class="sites-count"><span id="ssiStatS3Sites">0</span> sites</span>
                                </div>
                                <div class="sector-stat-body">
                                    <div class="visit-row">
                                        <div class="visit-type">V1</div>
                                        <div class="visit-data">
                                            <span class="visit-remaining" id="ssiStatS3V1">0</span>
                                            <span class="visit-percent danger" id="ssiStatS3V1Pct">0%</span>
                                        </div>
                                        <div class="progress-mini">
                                            <div class="progress-mini-fill" id="ssiStatS3V1Bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="visit-row">
                                        <div class="visit-type">V2</div>
                                        <div class="visit-data">
                                            <span class="visit-remaining" id="ssiStatS3V2">0</span>
                                            <span class="visit-percent danger" id="ssiStatS3V2Pct">0%</span>
                                        </div>
                                        <div class="progress-mini">
                                            <div class="progress-mini-fill" id="ssiStatS3V2Bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Autres -->
                            <div class="sector-stat-card autres">
                                <div class="sector-stat-header">
                                    <span class="sector-badge autres">⚪ Autres</span>
                                    <span class="sites-count"><span id="ssiStatAutresSites">0</span> sites</span>
                                </div>
                                <div class="sector-stat-body">
                                    <div class="visit-row">
                                        <div class="visit-type">V1</div>
                                        <div class="visit-data">
                                            <span class="visit-remaining" id="ssiStatAutresV1">0</span>
                                            <span class="visit-percent" id="ssiStatAutresV1Pct">0%</span>
                                        </div>
                                        <div class="progress-mini">
                                            <div class="progress-mini-fill" id="ssiStatAutresV1Bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="visit-row">
                                        <div class="visit-type">V2</div>
                                        <div class="visit-data">
                                            <span class="visit-remaining" id="ssiStatAutresV2">0</span>
                                            <span class="visit-percent" id="ssiStatAutresV2Pct">0%</span>
                                        </div>
                                        <div class="progress-mini">
                                            <div class="progress-mini-fill" id="ssiStatAutresV2Bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tableaux historiques SSI -->
                        <div class="section-header" style="margin-top: 32px;">
                            <h2 class="section-title">
                                <span class="icon">📋</span>
                                Historique Hebdomadaire SSI
                            </h2>
                        </div>

                        <div class="history-tables-grid">
                            <!-- Tableau S1 -->
                            <div class="history-table-card s1">
                                <div class="history-table-header s1">🔵 SECTEUR S1</div>
                                <div class="history-table-wrapper">
                                    <table class="history-table">
                                        <thead>
                                            <tr>
                                                <th>Semaine</th>
                                                <th>Type</th>
                                                <th>Restantes</th>
                                                <th>Réalisées</th>
                                                <th>Objectif</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ssiHistoryS1"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Tableau S2 -->
                            <div class="history-table-card s2">
                                <div class="history-table-header s2">🟢 SECTEUR S2</div>
                                <div class="history-table-wrapper">
                                    <table class="history-table">
                                        <thead>
                                            <tr>
                                                <th>Semaine</th>
                                                <th>Type</th>
                                                <th>Restantes</th>
                                                <th>Réalisées</th>
                                                <th>Objectif</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ssiHistoryS2"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Tableau S3 -->
                            <div class="history-table-card s3">
                                <div class="history-table-header s3">🔴 SECTEUR S3</div>
                                <div class="history-table-wrapper">
                                    <table class="history-table">
                                        <thead>
                                            <tr>
                                                <th>Semaine</th>
                                                <th>Type</th>
                                                <th>Restantes</th>
                                                <th>Réalisées</th>
                                                <th>Objectif</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ssiHistoryS3"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Tableau Autres -->
                            <div class="history-table-card autres">
                                <div class="history-table-header autres">⚪ AUTRES SECTEURS</div>
                                <div class="history-table-wrapper">
                                    <table class="history-table">
                                        <thead>
                                            <tr>
                                                <th>Semaine</th>
                                                <th>Type</th>
                                                <th>Restantes</th>
                                                <th>Réalisées</th>
                                                <th>Objectif</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ssiHistoryAutres"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Contenu DSF -->
                    <div id="visites-dsf" class="visites-content">
                        
                        <!-- Stats DSF par secteur -->
                        <div class="section-header">
                            <h2 class="section-title">
                                <span class="icon">🔥</span>
                                Résumé DSF par secteur - Semaine <span id="dsfWeekNum">51</span>
                            </h2>
                        </div>

                        <div class="sectors-stats-grid">
                            <!-- S1 DSF -->
                            <div class="sector-stat-card s1">
                                <div class="sector-stat-header">
                                    <span class="sector-badge s1">🔵 S1</span>
                                    <span class="sites-count"><span id="dsfStatS1Sites">0</span> sites</span>
                                </div>
                                <div class="sector-stat-body">
                                    <div class="dsf-stat-row">
                                        <div class="dsf-stat-main">
                                            <span class="dsf-remaining" id="dsfStatS1Rest">0</span>
                                            <span class="dsf-label">restantes</span>
                                        </div>
                                        <div class="dsf-progress-circle">
                                            <svg viewBox="0 0 40 40">
                                                <circle cx="20" cy="20" r="16" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="4"/>
                                                <circle id="dsfCircleS1" cx="20" cy="20" r="16" fill="none" stroke="var(--s1-color)" stroke-width="4" stroke-dasharray="100.53" stroke-dashoffset="100.53" stroke-linecap="round" transform="rotate(-90 20 20)"/>
                                            </svg>
                                            <span class="dsf-percent" id="dsfStatS1Pct">0%</span>
                                        </div>
                                    </div>
                                    <div class="progress-mini">
                                        <div class="progress-mini-fill" id="dsfStatS1Bar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- S2 DSF -->
                            <div class="sector-stat-card s2">
                                <div class="sector-stat-header">
                                    <span class="sector-badge s2">🟢 S2</span>
                                    <span class="sites-count"><span id="dsfStatS2Sites">0</span> sites</span>
                                </div>
                                <div class="sector-stat-body">
                                    <div class="dsf-stat-row">
                                        <div class="dsf-stat-main">
                                            <span class="dsf-remaining" id="dsfStatS2Rest">0</span>
                                            <span class="dsf-label">restantes</span>
                                        </div>
                                        <div class="dsf-progress-circle">
                                            <svg viewBox="0 0 40 40">
                                                <circle cx="20" cy="20" r="16" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="4"/>
                                                <circle id="dsfCircleS2" cx="20" cy="20" r="16" fill="none" stroke="var(--s2-color)" stroke-width="4" stroke-dasharray="100.53" stroke-dashoffset="100.53" stroke-linecap="round" transform="rotate(-90 20 20)"/>
                                            </svg>
                                            <span class="dsf-percent" id="dsfStatS2Pct">0%</span>
                                        </div>
                                    </div>
                                    <div class="progress-mini">
                                        <div class="progress-mini-fill" id="dsfStatS2Bar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- S3 DSF -->
                            <div class="sector-stat-card s3">
                                <div class="sector-stat-header">
                                    <span class="sector-badge s3">🔴 S3</span>
                                    <span class="sites-count"><span id="dsfStatS3Sites">0</span> sites</span>
                                </div>
                                <div class="sector-stat-body">
                                    <div class="dsf-stat-row">
                                        <div class="dsf-stat-main">
                                            <span class="dsf-remaining" id="dsfStatS3Rest">0</span>
                                            <span class="dsf-label">restantes</span>
                                        </div>
                                        <div class="dsf-progress-circle">
                                            <svg viewBox="0 0 40 40">
                                                <circle cx="20" cy="20" r="16" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="4"/>
                                                <circle id="dsfCircleS3" cx="20" cy="20" r="16" fill="none" stroke="var(--s3-color)" stroke-width="4" stroke-dasharray="100.53" stroke-dashoffset="100.53" stroke-linecap="round" transform="rotate(-90 20 20)"/>
                                            </svg>
                                            <span class="dsf-percent" id="dsfStatS3Pct">0%</span>
                                        </div>
                                    </div>
                                    <div class="progress-mini">
                                        <div class="progress-mini-fill" id="dsfStatS3Bar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Autres DSF -->
                            <div class="sector-stat-card autres">
                                <div class="sector-stat-header">
                                    <span class="sector-badge autres">⚪ Autres</span>
                                    <span class="sites-count"><span id="dsfStatAutresSites">0</span> sites</span>
                                </div>
                                <div class="sector-stat-body">
                                    <div class="dsf-stat-row">
                                        <div class="dsf-stat-main">
                                            <span class="dsf-remaining" id="dsfStatAutresRest">0</span>
                                            <span class="dsf-label">restantes</span>
                                        </div>
                                        <div class="dsf-progress-circle">
                                            <svg viewBox="0 0 40 40">
                                                <circle cx="20" cy="20" r="16" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="4"/>
                                                <circle id="dsfCircleAutres" cx="20" cy="20" r="16" fill="none" stroke="var(--autres-color)" stroke-width="4" stroke-dasharray="100.53" stroke-dashoffset="100.53" stroke-linecap="round" transform="rotate(-90 20 20)"/>
                                            </svg>
                                            <span class="dsf-percent" id="dsfStatAutresPct">0%</span>
                                        </div>
                                    </div>
                                    <div class="progress-mini">
                                        <div class="progress-mini-fill" id="dsfStatAutresBar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Planning mensuel DSF -->
                        <div class="section-header" style="margin-top: 32px;">
                            <h2 class="section-title">
                                <span class="icon">📅</span>
                                Planning Mensuel DSF
                            </h2>
                            <div class="filter-dropdown">
                                <label>Secteur :</label>
                                <select id="dsfSectorFilter" onchange="filterDSFPlanning(this.value)">
                                    <option value="all">Tous les secteurs</option>
                                    <option value="s1">Secteur S1</option>
                                    <option value="s2">Secteur S2</option>
                                    <option value="s3">Secteur S3</option>
                                    <option value="autres">Autres</option>
                                </select>
                            </div>
                        </div>

                        <div id="dsfPlanningContainer">
                            <!-- Les tableaux de planning seront générés dynamiquement -->
                            <div class="empty-state-mini" id="dsfPlanningEmpty">
                                <p>📊 Importez des données DSF pour voir le planning mensuel</p>
                            </div>
                        </div>

                    </div>

                    <!-- Contenu Planning -->
                    <!-- Contenu Historique -->
                    <div id="visites-historique" class="visites-content">
                        <div class="section-header">
                            <h2 class="section-title">
                                <span class="icon">📊</span>
                                Historique des Visites
                            </h2>
                            <div class="historique-actions">
                                <button class="btn-secondary" onclick="VISITESMODULE.exportHistorique()">
                                    <span>📥</span> Exporter
                                </button>
                            </div>
                        </div>

                        <!-- Graphique historique -->
                        <div class="historique-chart-container">
                            <canvas id="historiqueChart"></canvas>
                        </div>

                        <!-- Tableau historique par semaine -->
                        <div class="historique-table-container">
                            <h3>📅 Progression par semaine</h3>
                            <div class="historique-grid">
                                <!-- S1 -->
                                <div class="historique-sector-card">
                                    <div class="historique-sector-header s1">🔵 Secteur S1</div>
                                    <table class="historique-table">
                                        <thead>
                                            <tr>
                                                <th>Semaine</th>
                                                <th>Type</th>
                                                <th>Restantes</th>
                                                <th>Réalisées</th>
                                                <th>Objectif</th>
                                            </tr>
                                        </thead>
                                        <tbody id="historiqueS1">
                                            <tr><td colspan="5" class="empty-cell">Aucun historique</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- S2 -->
                                <div class="historique-sector-card">
                                    <div class="historique-sector-header s2">🟢 Secteur S2</div>
                                    <table class="historique-table">
                                        <thead>
                                            <tr>
                                                <th>Semaine</th>
                                                <th>Type</th>
                                                <th>Restantes</th>
                                                <th>Réalisées</th>
                                                <th>Objectif</th>
                                            </tr>
                                        </thead>
                                        <tbody id="historiqueS2">
                                            <tr><td colspan="5" class="empty-cell">Aucun historique</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- S3 -->
                                <div class="historique-sector-card">
                                    <div class="historique-sector-header s3">🔴 Secteur S3</div>
                                    <table class="historique-table">
                                        <thead>
                                            <tr>
                                                <th>Semaine</th>
                                                <th>Type</th>
                                                <th>Restantes</th>
                                                <th>Réalisées</th>
                                                <th>Objectif</th>
                                            </tr>
                                        </thead>
                                        <tbody id="historiqueS3">
                                            <tr><td colspan="5" class="empty-cell">Aucun historique</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- Autres -->
                                <div class="historique-sector-card">
                                    <div class="historique-sector-header autres">⚪ Autres</div>
                                    <table class="historique-table">
                                        <thead>
                                            <tr>
                                                <th>Semaine</th>
                                                <th>Type</th>
                                                <th>Restantes</th>
                                                <th>Réalisées</th>
                                                <th>Objectif</th>
                                            </tr>
                                        </thead>
                                        <tbody id="historiqueAutres">
                                            <tr><td colspan="5" class="empty-cell">Aucun historique</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- MODAL STT - Fiche récapitulative -->
                <div id="modalSTT" class="modal-overlay" style="display: none;">
                    <div class="modal-container modal-stt">
                        <div class="modal-header">
                            <h2 id="modalSTTTitle">📋 Fiche STT</h2>
                            <button class="modal-close" onclick="VISITESMODULE.closeModalSTT()">×</button>
                        </div>
                        <div class="modal-body">
                            <!-- Info STT -->
                            <div class="stt-info-card">
                                <div class="stt-info-row">
                                    <span class="stt-info-label">STT :</span>
                                    <span class="stt-info-value" id="modalSTTName">-</span>
                                </div>
                                <div class="stt-info-row">
                                    <span class="stt-info-label">Secteur :</span>
                                    <span class="stt-info-value" id="modalSTTSector">-</span>
                                </div>
                                <div class="stt-info-row">
                                    <span class="stt-info-label">Email :</span>
                                    <span class="stt-info-value email" id="modalSTTEmail">-</span>
                                </div>
                            </div>

                            <!-- Onglets Retard / À Planifier -->
                            <div class="modal-stt-tabs">
                                <button class="modal-stt-tab retard active" onclick="VISITESMODULE.switchModalTab('retard')">
                                    ⚠️ En Retard <span class="modal-stt-tab-count" id="modalSTTRetardCount">0</span>
                                </button>
                                <button class="modal-stt-tab planifier" onclick="VISITESMODULE.switchModalTab('planifier')">
                                    📅 À Planifier <span class="modal-stt-tab-count" id="modalSTTPlanifierCount">0</span>
                                </button>
                            </div>

                            <!-- Contenu Retard -->
                            <div id="modalSTTContentRetard" class="modal-stt-content active">
                                <!-- Historique RETARD -->
                                <div class="mail-history-card" style="background: rgba(239, 68, 68, 0.08); border-left: 4px solid var(--danger);">
                                    <h4 style="color: var(--danger);">⚠️ Historique Relances RETARD</h4>
                                    <div class="mail-dates">
                                        <div class="mail-date-row">
                                            <span class="mail-date-label">Dernier envoi :</span>
                                            <span class="mail-date-value" id="modalSTTLastSentRetard">Non enregistré</span>
                                        </div>
                                        <div class="mail-date-row">
                                            <span class="mail-date-label">Avant-dernier :</span>
                                            <span class="mail-date-value" id="modalSTTSecondLastSentRetard">Non enregistré</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Boutons RETARD en haut -->
                                <div class="modal-footer" style="margin-bottom: 16px; justify-content: flex-start;">
                                    <button class="btn-primary" onclick="VISITESMODULE.generateMailSTT('retard')" style="background: var(--danger);">
                                        <span>✉️</span> Mail Relance RETARD
                                    </button>
                                    <button class="btn-success" onclick="VISITESMODULE.archiveMailDate('retard')">
                                        <span>💾</span> Archiver Date RETARD
                                    </button>
                                </div>
                                <div class="sites-table-container">
                                    <table class="sites-retard-table">
                                        <thead>
                                            <tr>
                                                <th>Num. Client</th>
                                                <th>Nom du Site</th>
                                                <th>Ville</th>
                                                <th>Mois Prévu</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modalSTTSitesRetardBody">
                                            <!-- Généré dynamiquement -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Contenu À Planifier -->
                            <div id="modalSTTContentPlanifier" class="modal-stt-content">
                                <!-- Historique PLANIFIER -->
                                <div class="mail-history-card" style="background: rgba(14, 165, 233, 0.08); border-left: 4px solid var(--info);">
                                    <h4 style="color: var(--info);">📅 Historique Rappels À PLANIFIER</h4>
                                    <div class="mail-dates">
                                        <div class="mail-date-row">
                                            <span class="mail-date-label">Dernier envoi :</span>
                                            <span class="mail-date-value" id="modalSTTLastSentPlanifier">Non enregistré</span>
                                        </div>
                                        <div class="mail-date-row">
                                            <span class="mail-date-label">Avant-dernier :</span>
                                            <span class="mail-date-value" id="modalSTTSecondLastSentPlanifier">Non enregistré</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Boutons PLANIFIER en haut -->
                                <div class="modal-footer" style="margin-bottom: 16px; justify-content: flex-start;">
                                    <button class="btn-primary" onclick="VISITESMODULE.generateMailSTT('planifier')" style="background: var(--info);">
                                        <span>✉️</span> Mail Rappel À PLANIFIER
                                    </button>
                                    <button class="btn-success" onclick="VISITESMODULE.archiveMailDate('planifier')">
                                        <span>💾</span> Archiver Date RAPPEL
                                    </button>
                                </div>
                                <div class="sites-table-container">
                                    <table class="sites-retard-table">
                                        <thead>
                                            <tr>
                                                <th>Num. Client</th>
                                                <th>Nom du Site</th>
                                                <th>Ville</th>
                                                <th>Mois Prévu</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modalSTTSitesPlanifierBody">
                                            <!-- Généré dynamiquement -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Message status -->
                            <div class="mail-status" id="modalSTTStatus"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="VISITESMODULE.closeModalSTT()">
                                Fermer
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ============================================
                     PAGE: DSF (Module complet)
                     ============================================ -->
                <div id="page-dsf" class="page">
                    
                    <!-- Onglets DSF -->
                    <div class="dsf-tabs">
                        <button class="dsf-tab-btn active" data-tab="cloture" onclick="DSF.switchTab('cloture')">
                            <span>📋</span> À Clôturer
                            <span class="tab-badge" id="dsfBadgeCloture">0</span>
                        </button>
                        <button class="dsf-tab-btn" data-tab="planif" onclick="DSF.switchTab('planif')">
                            <span>📅</span> À Planifier
                            <span class="tab-badge" id="dsfBadgePlanif">0</span>
                        </button>
                        <button class="dsf-tab-btn" data-tab="resp" onclick="DSF.switchTab('resp')">
                            <span>⚠️</span> RESP à traiter
                            <span class="tab-badge danger" id="dsfBadgeResp">0</span>
                        </button>
                    </div>

                    <!-- Contenu DSF -->
                    <div class="dsf-content">
                        <div class="dsf-table-container">
                            <div class="table-actions">
                                <div class="filter-inline">
                                    <label>Secteur:</label>
                                    <select id="dsfSectorFilterTable" onchange="DSF.applyFilter()">
                                        <option value="TOUS">Tous</option>
                                        <option value="S1">S1</option>
                                        <option value="S2">S2</option>
                                        <option value="S3">S3</option>
                                        <option value="AUTRES">Autres</option>
                                    </select>
                                </div>
                                <span class="result-count" id="dsfResultCount">0 éléments</span>
                            </div>
                            <div class="table-wrapper">
                                <table class="dsf-table" id="dsfTable">
                                    <thead id="dsfTableHead"></thead>
                                    <tbody id="dsfTableBody"></tbody>
                                </table>
                            </div>
                            <div class="empty-state-dsf" id="dsfEmptyState">
                                <div class="empty-icon">📈</div>
                                <h3>Aucune donnée DSF</h3>
                                <p>Importez un fichier avec les feuilles DSF CLOTURE, DSF PLANIF, DSF RESP</p>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Modal Détail DSF -->
                <div id="dsfDetailModal" class="modal-overlay">
                    <div class="modal-container">
                        <button class="modal-close" onclick="DSF.closeDetail()">×</button>
                        <h2 class="modal-title" id="dsfModalTitle">📈 Détail DSF</h2>
                        <div class="modal-body" id="dsfDetailContent"></div>
                        <div class="modal-footer">
                            <button class="btn-action primary" onclick="DSF.markAsProcessed()">✅ Marquer comme traité</button>
                        </div>
                    </div>
                </div>

                <!-- ============================================
                     PAGE: SEARCH SSI (Module complet)
                     ============================================ -->
                <div id="page-searchssi" class="page">

                    <!-- Filtres -->
                    <div style="background: var(--bg-card); padding: 20px; border-radius: var(--radius-lg); margin-bottom: 24px; border: 1px solid var(--border-subtle);">
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 6px; color: var(--text-muted); font-size: 0.85em; text-transform: uppercase;">Code</label>
                                <input type="text" id="ssiSearchCode" placeholder="Rechercher..." style="width: 100%; padding: 10px 14px; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); font-family: inherit;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; color: var(--text-muted); font-size: 0.85em; text-transform: uppercase;">Nom</label>
                                <input type="text" id="ssiSearchNom" placeholder="Rechercher..." style="width: 100%; padding: 10px 14px; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); font-family: inherit;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; color: var(--text-muted); font-size: 0.85em; text-transform: uppercase;">Ville</label>
                                <input type="text" id="ssiSearchVille" placeholder="Rechercher..." style="width: 100%; padding: 10px 14px; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); font-family: inherit;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; color: var(--text-muted); font-size: 0.85em; text-transform: uppercase;">Secteur</label>
                                <select id="ssiSearchSecteur" style="width: 100%; padding: 10px 14px; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); font-family: inherit;">
                                    <option value="">TOUS</option>
                                    <option value="S1">S1</option>
                                    <option value="S2">S2</option>
                                    <option value="S3">S3</option>
                                    <option value="AUTRES">AUTRES</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; color: var(--text-muted); font-size: 0.85em; text-transform: uppercase;">Département</label>
                                <input type="text" id="ssiSearchDept" placeholder="Rechercher..." style="width: 100%; padding: 10px 14px; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); font-family: inherit;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <button id="ssiFilterV1" onclick="SEARCHSSI.toggleFilter('v1')" style="padding: 10px 20px; background: var(--bg-elevated); border: 2px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit;">📅 V1 RESTANT</button>
                            <button id="ssiFilterV2" onclick="SEARCHSSI.toggleFilter('v2')" style="padding: 10px 20px; background: var(--bg-elevated); border: 2px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit;">📅 V2 RESTANT</button>
                            <span id="ssiFilterCounter" style="display: none; background: var(--primary); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9em;">Visites restantes: <span id="ssiCounterValue">0</span></span>
                            <button onclick="SEARCHSSI.reset()" style="margin-left: auto; padding: 10px 20px; background: var(--danger); border: none; border-radius: var(--radius-md); color: white; font-weight: 600; cursor: pointer; font-family: inherit;">🔄 Réinitialiser</button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="background: var(--bg-card); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); text-align: center;">
                            <div style="font-size: 0.85em; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Heures Seul</div>
                            <div id="ssiHeuresSeul" style="font-size: 2em; font-weight: 800; color: var(--text-primary); font-family: 'JetBrains Mono', monospace;">0</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); text-align: center;">
                            <div style="font-size: 0.85em; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Heures Binôme</div>
                            <div id="ssiHeuresBinome" style="font-size: 2em; font-weight: 800; color: var(--text-primary); font-family: 'JetBrains Mono', monospace;">0</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); text-align: center;">
                            <div style="font-size: 0.85em; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Total Heures</div>
                            <div id="ssiTotalHeures" style="font-size: 2em; font-weight: 800; color: var(--primary); font-family: 'JetBrains Mono', monospace;">0</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); text-align: center;">
                            <div style="font-size: 0.85em; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Sites Total</div>
                            <div id="ssiSitesTotal" style="font-size: 2em; font-weight: 800; color: var(--text-primary); font-family: 'JetBrains Mono', monospace;">0</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); text-align: center;">
                            <div style="font-size: 0.85em; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Sites Seul</div>
                            <div id="ssiSitesSeul" style="font-size: 2em; font-weight: 800; color: var(--text-primary); font-family: 'JetBrains Mono', monospace;">0</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); text-align: center;">
                            <div style="font-size: 0.85em; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Sites Binome</div>
                            <div id="ssiSitesBinome" style="font-size: 2em; font-weight: 800; color: var(--text-primary); font-family: 'JetBrains Mono', monospace;">0</div>
                        </div>
                    </div>

                    <!-- Techniciens par secteur -->
                    <div style="background: var(--bg-card); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); margin-bottom: 24px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 16px;">👨‍🔧 Techniciens par Secteur</h3>
                        <div id="ssiTechBySector" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                            <div>
                                <div style="background: linear-gradient(135deg, var(--s1-color) 0%, var(--s1-dark) 100%); color: white; padding: 12px; border-radius: var(--radius-md); text-align: center; font-weight: 700; margin-bottom: 12px;">S1</div>
                                <div id="ssiTechS1" style="display: flex; flex-direction: column; gap: 8px;"></div>
                            </div>
                            <div>
                                <div style="background: linear-gradient(135deg, var(--s2-color) 0%, var(--s2-dark) 100%); color: white; padding: 12px; border-radius: var(--radius-md); text-align: center; font-weight: 700; margin-bottom: 12px;">S2</div>
                                <div id="ssiTechS2" style="display: flex; flex-direction: column; gap: 8px;"></div>
                            </div>
                            <div>
                                <div style="background: linear-gradient(135deg, var(--s3-color) 0%, var(--s3-dark) 100%); color: white; padding: 12px; border-radius: var(--radius-md); text-align: center; font-weight: 700; margin-bottom: 12px;">S3</div>
                                <div id="ssiTechS3" style="display: flex; flex-direction: column; gap: 8px;"></div>
                            </div>
                            <div>
                                <div style="background: linear-gradient(135deg, var(--autres-color) 0%, var(--autres-dark) 100%); color: white; padding: 12px; border-radius: var(--radius-md); text-align: center; font-weight: 700; margin-bottom: 12px;">AUTRES</div>
                                <div id="ssiTechAutres" style="display: flex; flex-direction: column; gap: 8px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Table des résultats -->
                    <div style="background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); overflow: hidden;">
                        <div style="max-height: 500px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); position: sticky; top: 0; z-index: 10;">
                                    <tr>
                                        <th onclick="ssiSortTable('tech')" style="padding: 14px 12px; text-align: left; color: white; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; position: relative;">
                                            TECH <span id="ssiSortTech"></span>
                                            <div id="ssiTechFilterDropdown" style="display:none;position:absolute;top:100%;left:0;background:#fff;border:2px solid #667eea;border-radius:8px;padding:15px;min-width:250px;max-height:400px;overflow-y:auto;z-index:100;box-shadow:0 5px 20px rgba(0,0,0,.3)">
                                                <div style="margin-bottom:10px;padding-bottom:10px;border-bottom:2px solid #e9ecef">
                                                    <button onclick="ssiSelectAllTech()" style="padding:8px 15px;background:#667eea;color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:600;margin-right:5px">Tous</button>
                                                    <button onclick="ssiDeselectAllTech()" style="padding:8px 15px;background:#dc3545;color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:600">Aucun</button>
                                                </div>
                                                <div id="ssiTechCheckboxList"></div>
                                            </div>
                                            <button id="ssiTechFilterBtn" onclick="ssiToggleTechFilter(event)" style="position:absolute;right:5px;top:50%;transform:translateY(-50%);background:#667eea;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-weight:600;font-size:0.8em">▼</button>
                                        </th>
                                        <th onclick="ssiSortTable('nom')" style="padding: 14px 12px; text-align: left; color: white; font-size: 0.8em; text-transform: uppercase; cursor: pointer;">NOM <span id="ssiSortNom"></span></th>
                                        <th onclick="ssiSortTable('ville')" style="padding: 14px 12px; text-align: left; color: white; font-size: 0.8em; text-transform: uppercase; cursor: pointer;">VILLE <span id="ssiSortVille"></span></th>
                                        <th onclick="ssiSortTable('code')" style="padding: 14px 12px; text-align: left; color: white; font-size: 0.8em; text-transform: uppercase; cursor: pointer;">CODE <span id="ssiSortCode"></span></th>
                                        <th onclick="ssiSortTable('site')" style="padding: 14px 12px; text-align: left; color: white; font-size: 0.8em; text-transform: uppercase; cursor: pointer;">SITE <span id="ssiSortSite"></span></th>
                                        <th onclick="ssiSortTable('dept')" style="padding: 14px 12px; text-align: left; color: white; font-size: 0.8em; text-transform: uppercase; cursor: pointer;">DEPT <span id="ssiSortDept"></span></th>
                                        <th onclick="ssiSortTable('nbVisite')" style="padding: 14px 12px; text-align: left; color: white; font-size: 0.8em; text-transform: uppercase; cursor: pointer;">VISITE <span id="ssiSortNbVisite"></span></th>
                                        <th onclick="ssiSortTable('nbHeure')" style="padding: 14px 12px; text-align: left; color: white; font-size: 0.8em; text-transform: uppercase; cursor: pointer;">HEURE <span id="ssiSortNbHeure"></span></th>
                                        <th onclick="ssiSortTable('techBinomeAffich')" style="padding: 14px 12px; text-align: left; color: white; font-size: 0.8em; text-transform: uppercase; cursor: pointer;">BINOME <span id="ssiSortTechBinomeAffich"></span></th>
                                        <th onclick="ssiSortTable('bk')" style="padding: 14px 12px; text-align: left; color: white; font-size: 0.8em; text-transform: uppercase; cursor: pointer;">V0 MAX <span id="ssiSortBk"></span></th>
                                        <th onclick="ssiSortTable('bt')" style="padding: 14px 12px; text-align: left; color: white; font-size: 0.8em; text-transform: uppercase; cursor: pointer;">PL1 <span id="ssiSortBt"></span></th>
                                        <th onclick="ssiSortTable('bp')" style="padding: 14px 12px; text-align: left; color: white; font-size: 0.8em; text-transform: uppercase; cursor: pointer;">V1 <span id="ssiSortBp"></span></th>
                                        <th onclick="ssiSortTable('bv')" style="padding: 14px 12px; text-align: left; color: white; font-size: 0.8em; text-transform: uppercase; cursor: pointer;">PL2 <span id="ssiSortBv"></span></th>
                                        <th onclick="ssiSortTable('bq')" style="padding: 14px 12px; text-align: left; color: white; font-size: 0.8em; text-transform: uppercase; cursor: pointer;">V2 <span id="ssiSortBq"></span></th>
                                        <th style="padding: 14px 12px; text-align: left; color: white; font-size: 0.8em; text-transform: uppercase;">#</th>
                                    </tr>
                                </thead>
                                <tbody id="ssiSearchTableBody">
                                    <tr><td colspan="15" style="text-align: center; padding: 40px; color: var(--text-muted);">📋 Chargez un fichier Excel avec la feuille SSI</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>

                <!-- Modal Site SSI -->
                <div id="ssiSiteModal" class="modal-overlay">
                    <div class="modal-container" style="max-width:98vw;width:98vw;height:auto;max-height:98vh;overflow:hidden;padding:5px 10px;margin:auto;position:relative;">
                        <button class="modal-close" onclick="SEARCHSSI.closeModal()">×</button>
                        <!-- Flèches navigation -->
                        <button id="ssiPrevBtn" onclick="SEARCHSSI.prev()" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:50%;border:none;background:linear-gradient(135deg,#667eea,#764ba2);color:white;font-size:20px;cursor:pointer;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,0.2);">◀</button>
                        <button id="ssiNextBtn" onclick="SEARCHSSI.next()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:50%;border:none;background:linear-gradient(135deg,#667eea,#764ba2);color:white;font-size:20px;cursor:pointer;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,0.2);">▶</button>
                        <h2 class="modal-title" id="ssiModalTitle" style="padding:3px 8px;font-size:0.9em;margin:0 50px;border-bottom:none;">🏢 Fiche Site SSI</h2>
                        <div class="modal-body" id="ssiModalBody" style="padding:1px 0px;"></div>
                    </div>
                </div>

                <!-- ============================================
                     PAGE: PRODUITS (Module complet)
                     ============================================ -->
                <div id="page-produits" class="page">
                    
                    <!-- STYLES pour Recherche Réf Produit -->
                    <style>
                        .produit-upload-zone {
                            background: rgba(255, 255, 255, 0.95);
                            border-radius: 15px;
                            padding: 50px 30px;
                            text-align: center;
                            border: 3px dashed #667eea;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            margin-bottom: 20px;
                        }
                        .produit-upload-zone:hover { transform: translateY(-3px); border-color: #764ba2; }
                        .produit-search-container { display: none; }
                        .produit-search-box { background: white; border-radius: 12px; padding: 12px; margin-bottom: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
                        .produit-search-input { width: 100%; padding: 10px 10px 10px 38px; font-size: 0.9em; border: 2px solid #e0e0e0; border-radius: 8px; outline: none; }
                        .produit-search-input:focus { border-color: #667eea; }
                        .produit-controls-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
                        .produit-year-btn { padding: 6px 16px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 16px; cursor: pointer; font-weight: 600; }
                        .produit-year-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
                        .produit-results-info { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 20px; border-radius: 12px; margin-bottom: 15px; display: none; align-items: center; gap: 8px; }
                        .produit-table { width: 100%; border-collapse: collapse; background: white; border-radius: 15px; overflow: hidden; }
                        .produit-table thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
                        .produit-table th { padding: 12px 15px; text-align: left; font-weight: 600; }
                        .produit-table td { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; }
                        .produit-table tbody tr:hover { background: rgba(102, 126, 234, 0.08); }
                        .produit-copy-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; }
                        .produit-copy-btn.copied { background: #10b981; }
                    </style>

                    <!-- Zone Upload -->
                    <div class="produit-upload-zone" id="produitUploadZone" onclick="document.getElementById('produitFileInput').click()" ondragover="event.preventDefault()" ondrop="event.preventDefault(); handleProduitFile(event.dataTransfer.files[0])">
                        <div style="font-size: 4em; color: #667eea; margin-bottom: 15px;">📁</div>
                        <h2 style="color: #333; margin-bottom: 8px;">Importer le fichier Produits</h2>
                        <p style="color: #666;">Glissez-déposez ou cliquez pour sélectionner un fichier Excel</p>
                    </div>
                    <input type="file" id="produitFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleProduitFile(this.files[0]); this.value=''">

                    <!-- Container Recherche -->
                    <div class="produit-search-container" id="produitSearchContainer">
                        <div class="produit-search-box">
                            <div style="position: relative;">
                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #667eea;">🔍</span>
                                <input type="text" id="produitSearchInput" class="produit-search-input" placeholder="Rechercher par code, nom ou description..." oninput="performProduitSearch()">
                            </div>
                            <div class="produit-controls-row">
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <label style="font-weight: 600;">Année :</label>
                                    <div id="produitYearButtons"></div>
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center; flex: 1;">
                                    <label style="font-weight: 600; color: #667eea;">📁 Catégorie :</label>
                                    <select id="produitCategoryFilter" style="flex: 1; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;" onchange="produitSelectedCategory=this.value; performProduitSearch()">
                                        <option value="">Toutes</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="produit-results-info" id="produitResultsInfo">
                            <span>📊</span>
                            <span id="produitResultsCount">0 produits</span>
                        </div>
                        <div style="max-height: 60vh; overflow-y: auto; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
                            <table class="produit-table">
                                <thead>
                                    <tr>
                                        <th>Copier</th>
                                        <th>Code</th>
                                        <th>Nom</th>
                                        <th>Description</th>
                                        <th>Prix Public</th>
                                        <th>Prix Util</th>
                                        <th>Prix Install</th>
                                    </tr>
                                </thead>
                                <tbody id="produitResultsBody"></tbody>
                            </table>
                        </div>
                    </div>

                </div>

                <!-- ============================================
                     PAGE: RELANCES (Centre de relances)
                     ============================================ -->
                <div id="page-relances" class="page">
                    
                    <div class="relances-header">
                        <h2>📧 Centre de Relances</h2>
                        <p>Gérez toutes vos relances emails en un seul endroit</p>
                    </div>

                    <!-- Types de relances -->
                    <div class="relances-grid">
                        <div class="relance-card" onclick="RELANCES.openType('stt')">
                            <div class="relance-icon">🏢</div>
                            <div class="relance-info">
                                <h3>Relances STT</h3>
                                <p>Sous-traitants à relancer</p>
                                <span class="relance-count" id="relanceCountStt">0</span>
                            </div>
                        </div>
                        <div class="relance-card" onclick="RELANCES.openType('devis')">
                            <div class="relance-icon">📄</div>
                            <div class="relance-info">
                                <h3>Relances Devis</h3>
                                <p>Devis en attente > 30 jours</p>
                                <span class="relance-count" id="relanceCountDevis">0</span>
                            </div>
                        </div>
                        <div class="relance-card" onclick="RELANCES.openType('dsf')">
                            <div class="relance-icon">📈</div>
                            <div class="relance-info">
                                <h3>Relances DSF</h3>
                                <p>DSF en retard</p>
                                <span class="relance-count" id="relanceCountDsf">0</span>
                            </div>
                        </div>
                        <div class="relance-card" onclick="RELANCES.openType('visites')">
                            <div class="relance-icon">📅</div>
                            <div class="relance-info">
                                <h3>Relances Visites</h3>
                                <p>Visites STT à planifier</p>
                                <span class="relance-count" id="relanceCountVisites">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Historique des relances -->
                    <div class="relances-history">
                        <h3>📜 Historique récent</h3>
                        <div class="history-list" id="relancesHistoryList">
                            <p class="empty-text">Aucune relance envoyée récemment</p>
                        </div>
                    </div>

                </div>

                <!-- ============================================
                     PAGE: ARCHIVES
                     ============================================ -->
                <div id="page-archives" class="page">
                    
                    <div class="archives-header">
                        <h2>🗄️ Archives & Historique</h2>
                        <p>Consultez l'historique de vos données</p>
                    </div>

                    <!-- Types d'archives -->
                    <div class="archives-grid">
                        <div class="archive-card">
                            <div class="archive-icon">📅</div>
                            <h3>Archives SSI</h3>
                            <p>Historique hebdomadaire des visites SSI</p>
                            <button class="btn-archive-action" onclick="ARCHIVES.exportSSI()">📥 Exporter</button>
                        </div>
                        <div class="archive-card">
                            <div class="archive-icon">📊</div>
                            <h3>Archives Travaux</h3>
                            <p>Historique des travaux traités</p>
                            <button class="btn-archive-action" onclick="ARCHIVES.exportTravaux()">📥 Exporter</button>
                        </div>
                        <div class="archive-card">
                            <div class="archive-icon">📧</div>
                            <h3>Historique Emails</h3>
                            <p>Log des emails envoyés</p>
                            <button class="btn-archive-action" onclick="ARCHIVES.viewEmails()">👁️ Consulter</button>
                        </div>
                    </div>

                    <!-- Actions de maintenance -->
                    <div class="maintenance-section">
                        <h3>🔧 Maintenance</h3>
                        <div class="maintenance-actions">
                            <button class="btn-maintenance" onclick="ARCHIVES.clearCache()">🗑️ Vider le cache</button>
                            <button class="btn-maintenance" onclick="ARCHIVES.exportAll()">📦 Exporter tout</button>
                            <button class="btn-maintenance danger" onclick="ARCHIVES.resetAll()">⚠️ Réinitialiser</button>
                        </div>
                    </div>

                </div>

            </div>
        </main>
    </div>

    <!-- Input file caché -->
    <input type="file" id="fileInput" accept=".xlsx,.xls">

    <!-- ============================================
         JAVASCRIPT
         ============================================ -->
    <script>
        // ============================================
        // DONNÉES GLOBALES
        // ============================================
        const APP = {
            data: {
                travaux: [],
                devis: [],
                ssi: [],
                dsf: [],
                dsfCloture: [],
                dsfPlanif: [],
                dsfResp: [],
                tech: [],
                stt: [],
                mails: [],
                produits: [],
                techRaw: [],
                sttRaw: []
            },
            tables: {
                tech: new Map(),
                stt: new Map()
            },
            loaded: false,
            currentPage: 'dashboard',
            currentWeek: null
        };

        // ============================================
        // INITIALISATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            // Calculer semaine courante
            APP.currentWeek = getCurrentWeek();
            document.getElementById('headerWeek').textContent = `Semaine ${APP.currentWeek.num} - ${APP.currentWeek.year}`;
            
            // Event listeners
            setupEventListeners();
            
            // Charger données sauvegardées si disponibles
            loadSavedData();
            
            console.log('🚀 GESTION PRO initialisé');
        }

        function getCurrentWeek() {
            const now = new Date();
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            const days = Math.floor((now - startOfYear) / (24 * 60 * 60 * 1000));
            const weekNum = Math.ceil((days + startOfYear.getDay() + 1) / 7);
            return { num: weekNum, year: now.getFullYear(), label: `S${weekNum}-${now.getFullYear()}` };
        }

        function setupEventListeners() {
            // Import file
            const fileInput = document.getElementById('fileInput');
            const importCard = document.getElementById('importCard');

            fileInput.addEventListener('change', handleFileUpload);

            // Drag & Drop
            importCard.addEventListener('dragover', (e) => {
                e.preventDefault();
                importCard.classList.add('dragover');
            });

            importCard.addEventListener('dragleave', () => {
                importCard.classList.remove('dragover');
            });

            importCard.addEventListener('drop', (e) => {
                e.preventDefault();
                importCard.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) processFile(file);
            });

            importCard.addEventListener('click', () => {
                fileInput.click();
            });

            // Recherche globale
            const searchInput = document.getElementById('globalSearch');
            searchInput.addEventListener('input', handleGlobalSearch);

            // Raccourci clavier Cmd+K / Ctrl+K
            document.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    searchInput.focus();
                }
            });
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function navigateTo(page) {
            // Mettre à jour nav active
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === page) {
                    item.classList.add('active');
                }
            });

            // Mettre à jour page active
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            document.getElementById(`page-${page}`).classList.add('active');

            // Mettre à jour titre
            const titles = {
                dashboard: '📊 Dashboard',
                visites: '📅 Suivi Visites',
                dsf: '📈 DSF Tracker',
                devis: '📄 Dashboard Devis',
                travaux: '📋 Analyseur Travaux',
                searchssi: '🔍 Recherche Client',
                produits: '📦 Recherche Produits',
                relances: '📧 Centre de Relances',
                archives: '🗄️ Archives'
            };
            document.getElementById('pageTitle').textContent = titles[page] || page;

            APP.currentPage = page;
        }

        // ============================================
        // IMPORT EXCEL
        // ============================================
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function processFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    console.log('📁 Lecture du fichier:', file.name);
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true, raw: false });
                    
                    console.log('📂 Feuilles trouvées:', workbook.SheetNames);
                    
                    // Parser chaque feuille
                    parseWorkbook(workbook);
                    
                    // Afficher le dashboard
                    showDashboard();
                    
                } catch (error) {
                    console.error('❌ Erreur lecture fichier:', error);
                    console.error('Stack:', error.stack);
                    alert('❌ Erreur lors de la lecture du fichier Excel:\n' + error.message);
                }
            };
            
            reader.onerror = function(e) {
                console.error('❌ Erreur FileReader:', e);
                alert('❌ Erreur lors de la lecture du fichier');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function parseWorkbook(workbook) {
            const sheetsLoaded = [];
            
            try {
                console.log('🔄 Début du parsing...');
                
                // ============================================
                // ÉTAPE 1 : CHARGER LES MAPPINGS TECH ET STT EN PREMIER
                // ============================================
                
                // TECH : colonne A = clé, colonne B = valeur
                const techMapping = {};
                const techFullInfo = {};
                
                if (workbook.SheetNames.includes('TECH')) {
                    console.log('📋 Chargement TECH...');
                    const sheet = workbook.Sheets['TECH'];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                    
                    // Stocker les données brutes pour le module DEVIS
                    APP.data.techRaw = data.slice(1).filter(row => row && row.some(val => val !== null && val !== undefined && val !== ''));
                    
                    // DEBUG: Afficher les en-têtes TECH
                    console.log('📋 TECH Headers:', data[0]);
                    console.log('📋 TECH Exemple lignes 2-6:', data.slice(1, 6));
                    
                    data.slice(1).forEach(row => {
                        if (!row || !Array.isArray(row)) return;
                        const cle = String(row[0] || '').trim();
                        const valeur = String(row[1] || '').trim();
                        const nom = String(row[2] || '').trim() || valeur;
                        const email = String(row[3] || '').trim();
                        const tel = String(row[4] || '').trim();
                        
                        if (cle && valeur) {
                            techMapping[cle] = valeur;
                            techFullInfo[cle] = { value: valeur, nom, email, tel };
                            APP.tables.tech.set(cle, { value: valeur, nom, email, tel });
                        }
                    });
                    
                    // DEBUG: Afficher quelques mappings et leurs secteurs
                    const sampleMappings = Object.entries(techMapping).slice(0, 10);
                    console.log('📋 TECH Mappings (10 premiers):');
                    sampleMappings.forEach(([k, v]) => {
                        const lastTwo = String(v).slice(-2).toUpperCase();
                        const secteur = lastTwo === 'S1' ? 'S1' : lastTwo === 'S2' ? 'S2' : lastTwo === 'S3' ? 'S3' : 'AUTRES';
                        console.log(`   "${k}" → "${v}" → secteur: ${secteur}`);
                    });
                    
                    sheetsLoaded.push({ name: 'TECH', count: Object.keys(techMapping).length });
                    console.log('✅ TECH Mapping chargé:', Object.keys(techMapping).length, 'entrées');
                } else {
                    console.warn('⚠️ Feuille TECH non trouvée');
                }
                
                // STT : colonne A = clé, colonne B = valeur, colonne C = email
                const sttMapping = {};
                const sttEmailMap = {};
                
                if (workbook.SheetNames.includes('STT')) {
                    console.log('🏢 Chargement STT...');
                    const sheet = workbook.Sheets['STT'];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                    
                    // Stocker les données brutes pour le module DEVIS
                    APP.data.sttRaw = data.slice(1).filter(row => row && row.some(val => val !== null && val !== undefined && val !== ''));
                    
                    data.slice(1).forEach(row => {
                        if (!row || !Array.isArray(row)) return;
                        const cle = String(row[0] || '').trim();
                        const valeur = String(row[1] || '').trim();
                        const email = String(row[2] || '').trim();
                        
                        if (cle && valeur) {
                            sttMapping[cle] = valeur;
                            if (email) sttEmailMap[cle] = email;
                            APP.tables.stt.set(cle, { value: valeur, email });
                        }
                    });
                    sheetsLoaded.push({ name: 'STT', count: Object.keys(sttMapping).length });
                    console.log('✅ STT Mapping chargé:', Object.keys(sttMapping).length, 'entrées');
                } else {
                    console.warn('⚠️ Feuille STT non trouvée');
                }
                
                // Fonctions de conversion locales
                const convertTech = (code) => {
                    const key = String(code || '').trim();
                    return techMapping[key] || key;
                };
                
                const convertStt = (code) => {
                    const key = String(code || '').trim();
                    return sttMapping[key] || key;
                };
                
                const getSttEmail = (code) => {
                    const key = String(code || '').trim();
                    return sttEmailMap[key] || '';
                };
                
                const getSector = (convertedValue) => {
                    const val = String(convertedValue || '').trim();
                    const lastTwo = val.slice(-2).toUpperCase();
                    if (lastTwo === 'S1') return 'S1';
                    if (lastTwo === 'S2') return 'S2';
                    if (lastTwo === 'S3') return 'S3';
                    return 'AUTRES';
                };
                
                // ============================================
                // ÉTAPE 2 : TRAITER SSI
                // ============================================
                if (workbook.SheetNames.includes('SSI')) {
                    console.log('📊 Chargement SSI...');
                    try {
                        const sheet = workbook.Sheets['SSI'];
                        // IDENTIQUE à ssi_search_fixed: {header:1}
                        const jsonData = XLSX.utils.sheet_to_json(sheet, {header:1});
                        
                        console.log('📊 SSI colonnes:', jsonData[0]?.length);
                        
                        if (jsonData.length > 1) {
                            // Stocker les headers pour le module SEARCHSSI
                            APP.data.ssiHeaders = jsonData[0];
                            
                            const colE = 4, colBT = 71, colBP = 67, colBQ = 68, colBV = 73;
                            
                            // DEBUG: Afficher les en-têtes pour vérifier les colonnes
                            console.log('📋 SSI Headers (premiers 80):', jsonData[0].slice(0, 80));
                            console.log('📋 SSI Exemple ligne 2:', jsonData[1]?.slice(0, 10), '... BT/BP/BQ/BV:', jsonData[1]?.[colBP], jsonData[1]?.[colBQ], jsonData[1]?.[colBT], jsonData[1]?.[colBV]);
                            
                            // DEBUG: Afficher quelques entrées du mapping TECH
                            console.log('📋 TECH Mapping (5 premiers):', Object.entries(techMapping).slice(0, 5));
                            
                            APP.data.ssi = jsonData.slice(1).map((row, idx) => {
                                if (!row || !Array.isArray(row)) return null;
                                const techCode = row[colE];
                                const techConverted = convertTech(techCode);
                                const secteur = getSector(techConverted);
                                
                                // DEBUG: Afficher les 5 premières conversions
                                if (idx < 5) {
                                    console.log(`🔍 SSI[${idx}] Secteur: code="${techCode}" → converted="${techConverted}" → secteur="${secteur}"`);
                                }
                                
                                const bt = String(row[colBT] || '').trim();
                                const bp = String(row[colBP] || '').trim();
                                const bq = String(row[colBQ] || '').trim();
                                const bv = String(row[colBV] || '').trim();
                                
                                return {
                                    _raw: row,
                                    techCode, techConverted, secteur,
                                    bt, bp, bq, bv,
                                    v1Restante: !bt && !bp,
                                    v2Restante: !bq && !bv,
                                    numClient: row[0] || '',
                                    nomSite: row[4] || ''
                                };
                            }).filter(r => r !== null);
                            
                            // DEBUG: Comptage par secteur
                            const secteurCounts = { S1: 0, S2: 0, S3: 0, AUTRES: 0 };
                            APP.data.ssi.forEach(r => secteurCounts[r.secteur]++);
                            console.log('📊 SSI par secteur:', secteurCounts);
                            
                            sheetsLoaded.push({ name: 'SSI', count: APP.data.ssi.length });
                            console.log('✅ SSI chargé:', APP.data.ssi.length, 'lignes');
                        }
                    } catch (err) {
                        console.error('❌ Erreur SSI:', err);
                    }
                }
                
                // ============================================
                // ÉTAPE 3 : TRAITER DSF
                // ============================================
                const dsfSheetName = workbook.SheetNames.find(name => {
                    const n = name.toUpperCase();
                    return n === 'DSF' || (n.includes('DSF') && !n.includes('CLOTURE') && !n.includes('PLANIF') && !n.includes('RESP'));
                });
                
                if (dsfSheetName) {
                    console.log('🔥 Chargement DSF...');
                    try {
                        const sheet = workbook.Sheets[dsfSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                        
                        if (jsonData.length > 1) {
                            const colA = 0, colE = 4, colG = 6, colL = 11, colY = 24, colZ = 25;
                            const colAC = 28, colAH = 33, colAI = 34, colAJ = 35, colBU = 72, colBV = 73, colBW = 74;
                            
                            // DEBUG: Afficher les en-têtes pour vérifier les colonnes
                            console.log('📋 DSF Headers (premiers 40):', jsonData[0].slice(0, 40));
                            console.log('📋 DSF Exemple ligne 2:', jsonData[1]?.slice(0, 40));
                            
                            APP.data.dsf = jsonData.slice(1).map((row, idx) => {
                                if (!row || !Array.isArray(row)) return null;
                                
                                const secteurCode = row[colAJ];
                                const secteurConverted = convertTech(secteurCode);
                                const secteur = getSector(secteurConverted);
                                
                                // DEBUG: Afficher les 5 premières conversions
                                if (idx < 5) {
                                    console.log(`🔍 DSF[${idx}] Secteur: code="${secteurCode}" → converted="${secteurConverted}" → secteur="${secteur}"`);
                                }
                                
                                const sttCode = row[colAH];
                                const sttConverted = convertStt(sttCode);
                                const sttEmail = getSttEmail(sttCode);
                                
                                const aiCode = row[colAI];
                                const aiConverted = convertStt(aiCode);
                                
                                const y = String(row[colY] || '').trim();
                                const bu = String(row[colBU] || '').trim();
                                const z = String(row[colZ] || '').trim();
                                const bv = String(row[colBV] || '').trim();
                                const mois = String(row[colAC] || '').trim();
                                
                                let visitesRestantes = 0, visitesTotales = 0;
                                if (!y && !bu) { visitesRestantes++; visitesTotales++; }
                                else if (y || bu) { visitesTotales++; }
                                if (aiConverted && !z && !bv) { visitesRestantes++; visitesTotales++; }
                                else if (aiConverted && (z || bv)) { visitesTotales++; }
                                
                                return {
                                    _raw: row,
                                    secteurCode, secteurConverted, secteur,
                                    sttCode, sttConverted, sttEmail,
                                    aiCode, aiConverted,
                                    y, bu, z, bv, mois,
                                    visitesRestantes, visitesTotales,
                                    numClient: row[colA] || '',
                                    nomSite: row[colE] || '',
                                    ville: row[colG] || '',
                                    contact: row[colL] || '',
                                    heureDSF: row[colBW] || ''
                                };
                            }).filter(r => r !== null);
                            sheetsLoaded.push({ name: 'DSF', count: APP.data.dsf.length });
                            console.log('✅ DSF chargé:', APP.data.dsf.length, 'lignes');
                        }
                    } catch (err) {
                        console.error('❌ Erreur DSF:', err);
                    }
                }
                
                // ============================================
                // ÉTAPE 4 : TRAITER TRAVAUX
                // ============================================
                const travauxSheetName = workbook.SheetNames.find(name => 
                    name.toUpperCase().includes('TRAVAUX') && !name.toUpperCase().includes('DSF')
                );
                
                if (travauxSheetName) {
                    console.log('📋 Chargement TRAVAUX...');
                    try {
                        const sheet = workbook.Sheets[travauxSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: '' });
                        
                        if (jsonData.length > 1) {
                            APP.data.travauxHeaders = jsonData[0];
                            
                            APP.data.travaux = jsonData.slice(1).map(row => {
                                if (!row || !Array.isArray(row)) return null;
                                
                                const processed = { _raw: row };
                                row.forEach((val, idx) => { processed[idx] = val !== undefined ? val : ''; });
                                
                                // Col 69 (index 68) = Technicien
                                const techCode = row[68];
                                const techConverted = convertTech(techCode);
                                processed.tech_converted = techConverted;
                                processed.col69_converted = techConverted;
                                processed.secteur = getSector(techConverted);
                                
                                const techInfo = techFullInfo[String(techCode || '').trim()] || {};
                                processed.technicien_nom = techInfo.nom || '';
                                processed.technicien_email = techInfo.email || '';
                                processed.technicien_telephone = techInfo.tel || '';
                                
                                // Col 12 (index 11) = Rédacteur
                                const redacteurCode = row[11];
                                const redacteurConverted = convertTech(redacteurCode);
                                processed.redacteur_converted = redacteurConverted;
                                processed.col12_converted = redacteurConverted;
                                const redInfo = techFullInfo[String(redacteurCode || '').trim()] || {};
                                processed.redacteur_email = redInfo.email || '';
                                
                                // Col 28 (index 27) = STT
                                const sttCode = String(row[27] || '').trim();
                                if (sttCode && sttCode !== '0') {
                                    const sttConv = convertStt(sttCode);
                                    processed.stt_converted = sttConv;
                                    processed.col28_converted = sttConv;
                                    processed.stt_email = getSttEmail(sttCode);
                                    processed.has_stt = true;
                                } else {
                                    processed.stt_converted = '';
                                    processed.col28_converted = '';
                                    processed.stt_email = '';
                                    processed.has_stt = false;
                                }
                                
                                // PL STT, Budget, CA
                                processed.pl_stt = String(row[50] || '').trim();
                                processed.is_planified = processed.pl_stt !== '';
                                
                                const budgetRaw = String(row[52] || '').replace(/[^\d.,-]/g, '').replace(',', '.');
                                processed.budget_stt = parseFloat(budgetRaw) || 0;
                                
                                const montantRaw = String(row[23] || '').replace(/[^\d.,-]/g, '').replace(',', '.');
                                processed.ca = parseFloat(montantRaw) || 0;
                                
                                // Année
                                const dateRetour = String(row[25] || '');
                                const yearMatch = dateRetour.match(/\/(\d{2,4})(?:\s|$)/);
                                if (yearMatch) {
                                    let y = yearMatch[1];
                                    if (y.length === 2) y = '20' + y;
                                    processed.annee = y;
                                } else {
                                    processed.annee = '';
                                }
                                
                                processed.uniqueKey = `${String(row[0] || '')}_${String(row[2] || '')}`;
                                
                                return processed;
                            }).filter(row => {
                                if (!row) return false;
                                return Object.keys(row).some(key => {
                                    if (key.startsWith('_') || key.includes('converted') || key.includes('numeric')) return false;
                                    return row[key] !== '' && row[key] !== null && row[key] !== undefined;
                                });
                            });
                            
                            sheetsLoaded.push({ name: 'TRAVAUX', count: APP.data.travaux.length });
                            console.log('✅ TRAVAUX chargé:', APP.data.travaux.length, 'lignes');
                        }
                    } catch (err) {
                        console.error('❌ Erreur TRAVAUX:', err);
                    }
                }
                
                // ============================================
                // ÉTAPE 5 : TRAITER DEVIS / DASHBOARD
                // ============================================
                const devisSheetName = workbook.SheetNames.find(name => {
                    const n = name.toUpperCase();
                    return n === 'DEVIS' || n === 'DASHBOARD';
                });
                
                if (devisSheetName) {
                    console.log('📄 Chargement DEVIS...');
                    try {
                        const sheet = workbook.Sheets[devisSheetName];
                        // IDENTIQUE à DEVIS.html : {header: 1, defval: null}
                        const jsonData = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: null});
                        
                        console.log('📄 DEVIS jsonData[0] length:', jsonData[0]?.length);
                        
                        if (jsonData.length > 1) {
                            APP.data.devisHeaders = jsonData[0];
                            
                            // Stocker juste _raw - le module DEVIS fera le traitement
                            APP.data.devis = jsonData.slice(1).map(row => {
                                if (!row || !Array.isArray(row)) return null;
                                return { _raw: row };
                            }).filter(r => r !== null && r._raw.some(val => val !== null && val !== undefined && val !== ''));
                            
                            sheetsLoaded.push({ name: 'DEVIS', count: APP.data.devis.length });
                            console.log('✅ DEVIS chargé:', APP.data.devis.length, 'lignes, colonnes:', APP.data.devisHeaders.length);
                        }
                    } catch (err) {
                        console.error('❌ Erreur DEVIS:', err);
                    }
                }
                
                // ============================================
                // ÉTAPE 6 : DSF TRACKER (CLOTURE, PLANIF, RESP)
                // ============================================
                ['CLOTURE', 'PLANIF', 'RESP'].forEach(suffix => {
                    const sheetName = workbook.SheetNames.find(name => 
                        name.toUpperCase().includes('DSF') && name.toUpperCase().includes(suffix)
                    );
                    
                    if (sheetName) {
                        console.log(`📈 Chargement DSF ${suffix}...`);
                        try {
                            const sheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                            
                            if (jsonData.length > 1) {
                                const dataKey = suffix === 'CLOTURE' ? 'dsfCloture' :
                                               suffix === 'PLANIF' ? 'dsfPlanif' : 'dsfResp';
                                
                                APP.data[dataKey] = jsonData.slice(1).map(row => {
                                    if (!row || !Array.isArray(row)) return null;
                                    const secteurCode = row[35];
                                    const secteurConverted = convertTech(secteurCode);
                                    
                                    return {
                                        _raw: row,
                                        secteur: getSector(secteurConverted),
                                        stt: convertStt(row[33]),
                                        numClient: row[0] || '',
                                        nomSite: row[4] || '',
                                        ville: row[6] || ''
                                    };
                                }).filter(r => r !== null);
                                
                                sheetsLoaded.push({ name: `DSF ${suffix}`, count: APP.data[dataKey].length });
                                console.log(`✅ DSF ${suffix} chargé:`, APP.data[dataKey].length, 'lignes');
                            }
                        } catch (err) {
                            console.error(`❌ Erreur DSF ${suffix}:`, err);
                        }
                    }
                });
                
                // ============================================
                // ÉTAPE 7 : PRODUITS (feuille séparée)
                // ============================================
                const produitsSheetName = workbook.SheetNames.find(name => 
                    name.toUpperCase().includes('PRODUIT')
                );
                
                if (produitsSheetName) {
                    console.log('🔎 Chargement PRODUITS...');
                    try {
                        const sheet = workbook.Sheets[produitsSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                        
                        if (jsonData.length > 1) {
                            APP.data.produitsHeaders = jsonData[0];
                            
                            APP.data.produits = jsonData.slice(1).map((row, idx) => {
                                if (!row || !Array.isArray(row)) return null;
                                
                                const processed = { _raw: row, _index: idx };
                                processed.code = row[0] || '';
                                processed.designation = row[1] || '';
                                processed.description = row[2] || '';
                                processed.marque = row[3] || '';
                                processed.categorie = row[4] || '';
                                
                                processed.tarifs = {};
                                jsonData[0].forEach((header, i) => {
                                    const h = String(header || '').toUpperCase();
                                    if (h.includes('TARIF') && h.includes('INSTAL')) {
                                        const yearMatch = h.match(/20\d{2}/);
                                        if (yearMatch) {
                                            const val = String(row[i] || '').replace(/[^\d.,-]/g, '').replace(',', '.');
                                            processed.tarifs[yearMatch[0]] = parseFloat(val) || 0;
                                        }
                                    }
                                });
                                
                                return processed;
                            }).filter(r => r !== null);
                            
                            sheetsLoaded.push({ name: 'PRODUITS', count: APP.data.produits.length });
                            console.log('✅ PRODUITS chargé:', APP.data.produits.length, 'lignes');
                        }
                    } catch (err) {
                        console.error('❌ Erreur PRODUITS:', err);
                    }
                }
                
                // ============================================
                // ÉTAPE 8 : MAILS
                // ============================================
                if (workbook.SheetNames.includes('MAILS')) {
                    console.log('📧 Chargement MAILS...');
                    try {
                        const sheet = workbook.Sheets['MAILS'];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                        APP.data.mails = jsonData.slice(1);
                        sheetsLoaded.push({ name: 'MAILS', count: APP.data.mails.length });
                        console.log('✅ MAILS chargé:', APP.data.mails.length, 'lignes');
                    } catch (err) {
                        console.error('❌ Erreur MAILS:', err);
                    }
                }

                // Afficher les feuilles chargées
                displayLoadedSheets(sheetsLoaded);
                
                APP.loaded = true;
                updateStatus(true);
                
                console.log('🎉 Import terminé avec succès !');
                console.log('📊 Résumé:', APP.data);
                
            } catch (error) {
                console.error('❌ Erreur parseWorkbook:', error);
                console.error('Stack:', error.stack);
                throw error;
            }
        }

        function displayLoadedSheets(sheets) {
            const container = document.getElementById('sheetsLoaded');
            container.innerHTML = sheets.map(s => `
                <div class="sheet-badge loaded">
                    <span>✅</span>
                    <span>${s.name}</span>
                    <span class="count">${s.count}</span>
                </div>
            `).join('');
            
            document.getElementById('importStatus').classList.add('visible');
        }

        function updateStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.classList.add('connected');
                const totalRecords = Object.values(APP.data).reduce((sum, arr) => sum + arr.length, 0);
                text.textContent = `${totalRecords} enregistrements`;
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Aucune donnée';
            }
        }

        // ============================================
        // MODULE DASHBOARD - Filtre & Stats DYNAMIQUES
        // (Ne touche PAS aux calculs SSI/DSF - utilise VISITES existant)
        // ============================================
        const DASHBOARD = {
            currentSector: 'TOUS',
            weekNum: 1,
            visitType: 'V1',
            chart: null,
            
            // Stats calculées UNIQUEMENT pour DSF Non clôturés, Travaux, CA, Devis
            stats: {
                dsfNonCloture: { S1: { cloture: 0, planif: 0, resp: 0 }, S2: { cloture: 0, planif: 0, resp: 0 }, S3: { cloture: 0, planif: 0, resp: 0 }, AUTRES: { cloture: 0, planif: 0, resp: 0 }, TOUS: { cloture: 0, planif: 0, resp: 0 } },
                travaux: { S1: 0, S2: 0, S3: 0, AUTRES: 0, TOUS: 0 },
                ca: { S1: 0, S2: 0, S3: 0, AUTRES: 0, TOUS: 0 },
                devis: { S1: 0, S2: 0, S3: 0, AUTRES: 0, TOUS: 0 }
            },

            init() {
                console.log('📊 Initialisation DASHBOARD (sans toucher SSI/DSF)...');
                
                // Calculer semaine et type de visite
                const now = new Date();
                const start = new Date(now.getFullYear(), 0, 1);
                const diff = now - start;
                const oneWeek = 1000 * 60 * 60 * 24 * 7;
                this.weekNum = Math.ceil(diff / oneWeek);
                
                // S1-26 = V1, S27-52 = V2
                this.visitType = this.weekNum <= 26 ? 'V1' : 'V2';
                
                // Mettre à jour l'affichage semaine
                const weekEl = document.getElementById('dashboardWeekNum');
                if (weekEl) weekEl.textContent = 'S' + this.weekNum;
                
                const typeEl = document.getElementById('dashboardVisitType');
                if (typeEl) {
                    typeEl.textContent = this.visitType;
                    typeEl.style.background = this.visitType === 'V1' ? 'var(--info)' : 'var(--warning)';
                }
                
                // Calculer SEULEMENT DSF Non clôturés, Travaux, CA, Devis par secteur
                this.calculateStats();
                
                // Afficher
                this.currentSector = 'TOUS';
                this.updateDisplay();
                
                console.log('✅ DASHBOARD initialisé', this.stats);
            },

            calculateStats() {
                // Reset stats
                ['S1', 'S2', 'S3', 'AUTRES', 'TOUS'].forEach(s => {
                    this.stats.dsfNonCloture[s] = { cloture: 0, planif: 0, resp: 0 };
                    this.stats.travaux[s] = 0;
                    this.stats.ca[s] = 0;
                    this.stats.devis[s] = 0;
                });
                
                // DSF Non clôturés par secteur
                ['dsfCloture', 'dsfPlanif', 'dsfResp'].forEach(type => {
                    if (APP.data[type]) {
                        APP.data[type].forEach(row => {
                            const secteur = row.secteur || 'AUTRES';
                            const s = ['S1', 'S2', 'S3'].includes(secteur) ? secteur : 'AUTRES';
                            
                            if (type === 'dsfCloture') {
                                this.stats.dsfNonCloture[s].cloture++;
                                this.stats.dsfNonCloture.TOUS.cloture++;
                            } else if (type === 'dsfPlanif') {
                                this.stats.dsfNonCloture[s].planif++;
                                this.stats.dsfNonCloture.TOUS.planif++;
                            } else {
                                this.stats.dsfNonCloture[s].resp++;
                                this.stats.dsfNonCloture.TOUS.resp++;
                            }
                        });
                    }
                });
                
                // Travaux et CA par secteur
                if (APP.data.travaux) {
                    APP.data.travaux.forEach(row => {
                        const secteur = row.secteur || 'AUTRES';
                        const s = ['S1', 'S2', 'S3'].includes(secteur) ? secteur : 'AUTRES';
                        
                        this.stats.travaux[s]++;
                        this.stats.travaux.TOUS++;
                        
                        this.stats.ca[s] += row.ca || 0;
                        this.stats.ca.TOUS += row.ca || 0;
                    });
                }
                
                // Devis en attente par secteur
                if (APP.data.devis) {
                    APP.data.devis.forEach(row => {
                        if (!row.bcOk) {
                            const secteur = row.secteur || 'AUTRES';
                            const s = ['S1', 'S2', 'S3'].includes(secteur) ? secteur : 'AUTRES';
                            this.stats.devis[s]++;
                            this.stats.devis.TOUS++;
                        }
                    });
                }
            },

            filterBySector() {
                const select = document.getElementById('dashboardSectorFilter');
                this.currentSector = select ? select.value : 'TOUS';
                
                console.log('🎯 Filtrage Dashboard par secteur:', this.currentSector);
                
                // Mettre à jour l'affichage (SANS toucher aux sections SSI/DSF visites)
                this.updateDisplay();
                
                // Mettre à jour le graphique
                this.updateChart();
            },

            updateDisplay() {
                // Mettre à jour objectif SSI
                this.updateObjectifInfo();
                
                // Masquer/afficher les cartes secteur SSI et DSF visites
                this.updateSectorCardsVisibility();
                
                // DSF Non clôturés par secteur (nouvelle section)
                this.updateDsfNonClotureDisplay();
                
                // Travaux par secteur
                this.updateTravauxDisplay();
                
                // KPIs filtrés (CA, Travaux, Devis, DSF)
                this.updateKPIsDisplay();
            },

            updateObjectifInfo() {
                const objectifEl = document.getElementById('ssiObjectifInfo');
                if (!objectifEl) return;
                
                // Utiliser VISITES existant pour les données SSI
                let restantes = 0;
                const sector = this.currentSector;
                
                if (typeof VISITES !== 'undefined' && VISITES.ssi) {
                    const sectorKey = sector === 'TOUS' ? 'total' : sector.toLowerCase();
                    if (this.visitType === 'V1' && VISITES.ssi.v1Restantes) {
                        restantes = VISITES.ssi.v1Restantes[sectorKey] || VISITES.ssi.v1Restantes.total || 0;
                    } else if (VISITES.ssi.v2Restantes) {
                        restantes = VISITES.ssi.v2Restantes[sectorKey] || VISITES.ssi.v2Restantes.total || 0;
                    }
                }
                
                const weeksRemaining = this.visitType === 'V1' ? Math.max(1, 26 - this.weekNum + 1) : Math.max(1, 52 - this.weekNum + 1);
                const objectif = Math.ceil(restantes / weeksRemaining);
                
                const sectorLabel = sector === 'TOUS' ? 'Global' : sector;
                objectifEl.textContent = `${sectorLabel} - Objectif ${this.visitType}: ~${objectif}/sem (${restantes} restantes, ${weeksRemaining} sem.)`;
            },

            updateSectorCardsVisibility() {
                const ssiCards = document.querySelectorAll('#sectorsSSI .sector-card');
                const dsfCards = document.querySelectorAll('#sectorsDSF .sector-card');
                
                const showAll = this.currentSector === 'TOUS';
                
                [ssiCards, dsfCards].forEach(cards => {
                    cards.forEach(card => {
                        if (showAll) {
                            card.style.display = '';
                        } else {
                            const isMatch = 
                                (card.classList.contains('s1') && this.currentSector === 'S1') ||
                                (card.classList.contains('s2') && this.currentSector === 'S2') ||
                                (card.classList.contains('s3') && this.currentSector === 'S3') ||
                                (card.classList.contains('autres') && this.currentSector === 'AUTRES');
                            card.style.display = isMatch ? '' : 'none';
                        }
                    });
                });
            },

            updateDsfNonClotureDisplay() {
                // Afficher par secteur (les 4 cartes)
                ['S1', 'S2', 'S3', 'AUTRES'].forEach(s => {
                    const prefix = 'dsf' + (s === 'AUTRES' ? 'Autres' : s);
                    const stats = this.stats.dsfNonCloture[s];
                    
                    const clotureEl = document.getElementById(prefix + 'Cloture');
                    const planifEl = document.getElementById(prefix + 'Planif');
                    const respEl = document.getElementById(prefix + 'Resp');
                    const totalEl = document.getElementById(prefix + 'Total');
                    
                    if (clotureEl) clotureEl.textContent = stats.cloture;
                    if (planifEl) planifEl.textContent = stats.planif;
                    if (respEl) respEl.textContent = stats.resp;
                    
                    const total = stats.cloture + stats.planif + stats.resp;
                    if (totalEl) totalEl.textContent = total;
                });
                
                // Totaux en bas (filtrés par secteur sélectionné)
                const sector = this.currentSector;
                const stats = this.stats.dsfNonCloture[sector];
                
                const clotureEl = document.getElementById('dsfClotureCount');
                const planifEl = document.getElementById('dsfPlanifCount');
                const respEl = document.getElementById('dsfRespCount');
                
                if (clotureEl) clotureEl.textContent = stats.cloture;
                if (planifEl) planifEl.textContent = stats.planif;
                if (respEl) respEl.textContent = stats.resp;
            },

            updateTravauxDisplay() {
                ['S1', 'S2', 'S3', 'AUTRES'].forEach(s => {
                    const el = document.getElementById('travaux' + (s === 'AUTRES' ? 'Autres' : s) + 'Count');
                    if (el) el.textContent = this.stats.travaux[s];
                });
            },

            updateKPIsDisplay() {
                const sector = this.currentSector;
                
                // CA (filtré par secteur)
                const caEl = document.getElementById('kpiCa');
                if (caEl) caEl.textContent = formatCurrency(this.stats.ca[sector]);
                
                // Travaux (filtré par secteur)
                const travauxEl = document.getElementById('kpiTravaux');
                if (travauxEl) travauxEl.textContent = this.stats.travaux[sector];
                
                // Devis en attente (filtré par secteur)
                const devisEl = document.getElementById('kpiDevis');
                if (devisEl) devisEl.textContent = this.stats.devis[sector];
                
                // Visites restantes - utiliser VISITES existant
                if (typeof VISITES !== 'undefined' && VISITES.ssi) {
                    const sectorKey = sector === 'TOUS' ? 'total' : sector.toLowerCase();
                    let visitesRestantes = 0;
                    
                    if (this.visitType === 'V1' && VISITES.ssi.v1Restantes) {
                        visitesRestantes = VISITES.ssi.v1Restantes[sectorKey] || 0;
                    } else if (VISITES.ssi.v2Restantes) {
                        visitesRestantes = VISITES.ssi.v2Restantes[sectorKey] || 0;
                    }
                    
                    // Ajouter DSF restantes si dispo
                    if (VISITES.dsf && VISITES.dsf.restantes) {
                        visitesRestantes += VISITES.dsf.restantes[sectorKey] || 0;
                    }
                    
                    const visitesEl = document.getElementById('kpiVisites');
                    if (visitesEl) visitesEl.textContent = visitesRestantes;
                }
                
                // DSF non clôturés (filtré par secteur)
                const dsfStats = this.stats.dsfNonCloture[sector];
                const dsfTotal = dsfStats.cloture + dsfStats.planif + dsfStats.resp;
                const dsfEl = document.getElementById('kpiDsf');
                if (dsfEl) dsfEl.textContent = dsfTotal;
            },

            updateChart() {
                if (!this.chart) return;
                
                const sector = document.getElementById('chartSectorFilter')?.value || this.currentSector;
                const data = this.getChartData(sector);
                
                this.chart.data.labels = data.weeks;
                this.chart.data.datasets[0].data = data.ssiRestantes;
                this.chart.data.datasets[1].data = data.dsfRestantes;
                this.chart.update();
            },

            getChartData(sector) {
                // Générer les 6 dernières semaines
                const weeks = [];
                for (let i = 5; i >= 0; i--) {
                    weeks.push('S' + Math.max(1, this.weekNum - i));
                }
                
                // Utiliser VISITES existant pour SSI
                let currentSSI = 0;
                if (typeof VISITES !== 'undefined' && VISITES.ssi) {
                    const sectorKey = sector === 'TOUS' ? 'total' : sector.toLowerCase();
                    if (this.visitType === 'V1' && VISITES.ssi.v1Restantes) {
                        currentSSI = VISITES.ssi.v1Restantes[sectorKey] || 0;
                    } else if (VISITES.ssi.v2Restantes) {
                        currentSSI = VISITES.ssi.v2Restantes[sectorKey] || 0;
                    }
                }
                
                const dsfStats = this.stats.dsfNonCloture[sector];
                const currentDSF = dsfStats.cloture + dsfStats.planif + dsfStats.resp;
                
                // Simuler une progression décroissante
                const ssiRestantes = [];
                const dsfRestantes = [];
                
                for (let i = 0; i < 6; i++) {
                    const factor = 1 + (5 - i) * 0.12;
                    ssiRestantes.push(Math.round(currentSSI * factor));
                    dsfRestantes.push(Math.round(currentDSF * factor));
                }
                
                return { weeks, ssiRestantes, dsfRestantes };
            }
        };

        // ============================================
        // AFFICHAGE DASHBOARD
        // ============================================
        function showDashboard() {
            console.log('🚀 Affichage Dashboard...');
            
            // Masquer zone import
            const importZone = document.getElementById('importZone');
            if (importZone) importZone.classList.add('hidden');
            
            // Afficher dashboard
            const dashboard = document.getElementById('dashboardContent');
            if (dashboard) dashboard.classList.remove('hidden');
            
            // Initialiser le module DASHBOARD
            DASHBOARD.init();
            
            // Initialiser les modules avec les données pré-traitées
            initVisitesModule();
            
            // Initialiser TRAVAUX
            if (APP.data.travaux.length > 0) {
                TRAVAUX.init();
            }
            
            // Initialiser DEVIS
            if (APP.data.devis.length > 0) {
                DEVIS.init();
            }
            
            // Initialiser DSF Tracker
            if (APP.data.dsfCloture.length > 0 || APP.data.dsfPlanif.length > 0 || APP.data.dsfResp.length > 0) {
                DSF.init();
            }
            
            // Initialiser PRODUITS
            if (APP.data.produits && APP.data.produits.length > 0) {
                PRODUITS.init();
            }
            
            // Initialiser SEARCH SSI
            if (APP.data.ssi && APP.data.ssi.length > 0) {
                SEARCHSSI.init();
            }
            
            // Initialiser RELANCES
            RELANCES.init();
            
            // Calculer et afficher les stats du dashboard
            updateDashboardStats();
            
            // Initialiser le graphique
            initEvolutionChart();
            
            console.log('✅ Dashboard affiché');
        }

        function updateDashboardStats() {
            // KPIs - utiliser les données pré-traitées
            updateKPIs();
            
            // Alertes
            updateAlerts();
            
            // Badges navigation
            updateNavBadges();
        }

        function updateKPIs() {
            // CA (depuis travaux pré-traités)
            let totalCA = 0;
            APP.data.travaux.forEach(row => {
                totalCA += row.ca || 0;  // Utiliser la propriété pré-traitée
            });
            const caEl = document.getElementById('kpiCa');
            if (caEl) caEl.textContent = formatCurrency(totalCA);
            
            // Travaux en cours
            const travauxEl = document.getElementById('kpiTravaux');
            if (travauxEl) travauxEl.textContent = APP.data.travaux.length;
            
            const badgeTravaux = document.getElementById('badge-travaux');
            if (badgeTravaux) badgeTravaux.textContent = APP.data.travaux.length;
            
            // Devis en attente (utiliser bcOk pré-traité)
            const devisEnAttente = APP.data.devis.filter(d => !d.bcOk).length;
            const devisEl = document.getElementById('kpiDevis');
            if (devisEl) devisEl.textContent = devisEnAttente;
            
            // Visites restantes - Calculées par initVisitesModule
            // Les valeurs sont mises à jour dans updateVisitesKPI()
            
            // DSF non clôturés
            const dsfNonClotures = (APP.data.dsfCloture?.length || 0) + 
                                   (APP.data.dsfPlanif?.length || 0) + 
                                   (APP.data.dsfResp?.length || 0);
            const dsfEl = document.getElementById('kpiDsf');
            if (dsfEl) dsfEl.textContent = dsfNonClotures;
            
            const badgeDsf = document.getElementById('badge-dsf');
            if (badgeDsf) badgeDsf.textContent = dsfNonClotures;
        }

        function updateAlerts() {
            // DSF RESP
            const alertEl = document.getElementById('alertDsfResp');
            if (alertEl) alertEl.textContent = APP.data.dsfResp?.length || 0;
        }

        function updateNavBadges() {
            // Mettre à jour les badges de navigation
            const badgeTravaux = document.getElementById('badge-travaux');
            if (badgeTravaux && APP.data.travaux.length === 0) {
                badgeTravaux.style.display = 'none';
            }
            
            const badgeDsf = document.getElementById('badge-dsf');
            const totalDsf = (APP.data.dsfCloture?.length || 0) + 
                            (APP.data.dsfPlanif?.length || 0) + 
                            (APP.data.dsfResp?.length || 0);
            if (badgeDsf && totalDsf === 0) {
                badgeDsf.style.display = 'none';
            }
        }

        // ============================================
        // GRAPHIQUE ÉVOLUTION
        // ============================================
        function initEvolutionChart() {
            const ctx = document.getElementById('evolutionChart');
            if (!ctx) return;
            
            // Récupérer les données initiales depuis DASHBOARD
            const chartData = DASHBOARD.getChartData('TOUS');
            
            DASHBOARD.chart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.weeks,
                    datasets: [
                        {
                            label: 'SSI Restantes',
                            data: chartData.ssiRestantes,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 5,
                            pointBackgroundColor: '#3b82f6'
                        },
                        {
                            label: 'DSF Restantes',
                            data: chartData.dsfRestantes,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 5,
                            pointBackgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#475569',
                                font: { family: 'Plus Jakarta Sans', weight: '600' },
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20
                            }
                        },
                        title: {
                            display: true,
                            text: 'Visites restantes par semaine',
                            color: '#1e293b',
                            font: { size: 14, weight: '600' },
                            padding: { bottom: 10 }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(148, 163, 184, 0.15)' },
                            ticks: { color: '#64748b', font: { weight: '500' } }
                        },
                        y: {
                            grid: { color: 'rgba(148, 163, 184, 0.15)' },
                            ticks: { color: '#64748b', font: { weight: '500' } },
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Visites restantes',
                                color: '#64748b'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // ============================================
        // RECHERCHE GLOBALE
        // ============================================
        function handleGlobalSearch(e) {
            const query = e.target.value.toLowerCase().trim();
            if (query.length < 2) return;
            
            // TODO: Implémenter recherche cross-modules
            console.log('🔍 Recherche:', query);
        }

        // ============================================
        // BRIDGE ACCESS (préparation)
        // ============================================
        function showAccessConfig() {
            alert('🔗 Connexion Access Bridge\n\nCette fonctionnalité sera disponible quand le serveur Node.js sera lancé sur votre PC.\n\nVoir le dossier "access-realtime-bridge" pour l\'installation.');
        }

        // ============================================
        // UTILITAIRES
        // ============================================
        function formatDateDDMMYYYY(val) {
            if (!val) return '';
            const str = String(val).trim();
            if (str === '' || str.toUpperCase() === 'UNDEFINED' || str.toUpperCase() === 'NAN') return '';
            
            // Si c'est un nombre Excel (serial date)
            const num = parseFloat(str);
            if (!isNaN(num) && num > 25569 && num < 60000) {
                const d = new Date((num - 25569) * 86400 * 1000);
                const day = String(d.getUTCDate()).padStart(2, '0');
                const month = String(d.getUTCMonth() + 1).padStart(2, '0');
                const year = d.getUTCFullYear();
                return day + '/' + month + '/' + year;
            }
            
            // Si c'est une chaîne de date
            const d = new Date(str);
            if (!isNaN(d.getTime())) {
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                return day + '/' + month + '/' + year;
            }
            
            return str;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('fr-FR').format(num);
        }

        function getPercentClass(percent) {
            if (percent >= 75) return 'good';
            if (percent >= 50) return 'warning';
            return 'danger';
        }

        // ============================================
        // PERSISTANCE (localStorage)
        // ============================================
        function saveData() {
            try {
                localStorage.setItem('gestionpro_data', JSON.stringify(APP.data));
                localStorage.setItem('gestionpro_timestamp', new Date().toISOString());
                console.log('💾 Données sauvegardées');
            } catch (e) {
                console.warn('Erreur sauvegarde localStorage:', e);
            }
        }

        function loadSavedData() {
            try {
                const saved = localStorage.getItem('gestionpro_data');
                const timestamp = localStorage.getItem('gestionpro_timestamp');
                
                if (saved && timestamp) {
                    const data = JSON.parse(saved);
                    const age = (new Date() - new Date(timestamp)) / 1000 / 60; // en minutes
                    
                    if (age < 60) { // Moins d'1h
                        APP.data = data;
                        APP.loaded = true;
                        
                        // Reconstruire les tables de référence
                        if (data.tech && data.tech.length > 0) buildTechTable(data.tech);
                        if (data.stt && data.stt.length > 0) buildSttTable(data.stt);
                        
                        showDashboard();
                        updateStatus(true);
                        console.log('📂 Données restaurées (sauvegarde de', Math.round(age), 'min)');
                    }
                }
            } catch (e) {
                console.warn('Erreur chargement localStorage:', e);
            }
        }

        // Sauvegarder automatiquement après chaque import
        window.addEventListener('beforeunload', () => {
            if (APP.loaded) saveData();
        });

        // ============================================
        // MODULE VISITES - LOGIQUE
        // ============================================
        const VISITES = {
            ssi: {
                counts: { s1: 0, s2: 0, s3: 0, autres: 0, total: 0 },
                v1Restantes: { s1: 0, s2: 0, s3: 0, autres: 0, total: 0 },
                v2Restantes: { s1: 0, s2: 0, s3: 0, autres: 0, total: 0 },
                history: { s1: [], s2: [], s3: [], autres: [] }
            },
            dsf: {
                counts: { s1: 0, s2: 0, s3: 0, autres: 0, total: 0 },
                restantes: { s1: 0, s2: 0, s3: 0, autres: 0, total: 0 },
                totales: { s1: 0, s2: 0, s3: 0, autres: 0, total: 0 },
                rawData: [],
                monthlyData: {}
            }
        };

        const SSI_HISTORY_KEY = 'gestionpro_ssi_history';

        // Onglets Visites
        function switchVisitesTab(tab) {
            document.querySelectorAll('.visites-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.visites-tab[data-tab="${tab}"]`).classList.add('active');
            
            document.querySelectorAll('.visites-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`visites-${tab}`).classList.add('active');
        }

        // Initialiser le module Visites
        function initVisitesModule() {
            console.log('🔄 Initialisation module Visites...');
            console.log('📅 SSI data:', APP.data.ssi.length, 'entrées');
            console.log('📈 DSF data:', APP.data.dsf.length, 'entrées');
            
            // Mettre à jour les infos semaine
            const weekNum = APP.currentWeek.num;
            const visitType = weekNum <= 26 ? 'V1' : 'V2';
            const visitPeriod = weekNum <= 26 ? 'Semaines 1-26' : 'Semaines 27-52';
            
            const weekTitle = document.getElementById('visitesWeekTitle');
            if (weekTitle) weekTitle.textContent = `📅 Semaine ${weekNum}`;
            
            const weekPeriod = document.getElementById('visitesWeekPeriod');
            if (weekPeriod) weekPeriod.textContent = getWeekDates(weekNum);
            
            const visitBadge = document.getElementById('visitTypeBadge');
            if (visitBadge) visitBadge.innerHTML = `<span>${visitType}</span><small>${visitPeriod}</small>`;
            
            const ssiWeek = document.getElementById('ssiWeekNum');
            if (ssiWeek) ssiWeek.textContent = weekNum;
            
            const dsfWeek = document.getElementById('dsfWeekNum');
            if (dsfWeek) dsfWeek.textContent = weekNum;
            
            // Charger l'historique
            loadSSIHistory();
            
            // Traiter les données SSI si disponibles
            if (APP.data.ssi.length > 0) {
                console.log('📊 Traitement SSI...');
                processSSIData();
                displaySSIStats();
                displaySSIHistory();
            } else {
                console.warn('⚠️ Aucune donnée SSI');
            }
            
            // Traiter les données DSF si disponibles
            if (APP.data.dsf.length > 0) {
                console.log('🔥 Traitement DSF...');
                processDSFData();
                displayDSFStats();
                generateDSFPlanning();
            } else {
                console.warn('⚠️ Aucune donnée DSF');
            }
            
            // Mettre à jour les compteurs des onglets
            const tabSSI = document.getElementById('tabCountSSI');
            if (tabSSI) tabSSI.textContent = VISITES.ssi.counts.total || 0;
            
            const tabDSF = document.getElementById('tabCountDSF');
            if (tabDSF) tabDSF.textContent = VISITES.dsf.counts.total || 0;
            
            // Mettre à jour le KPI Visites sur le dashboard
            updateVisitesKPI();
            
            // Initialiser le module VISITESMODULE (Planning, Historique, Modal STT)
            VISITESMODULE.init();
            
            console.log('✅ Module Visites initialisé');
        }
        
        function updateVisitesKPI() {
            const weekNum = APP.currentWeek.num;
            let totalRestantes = 0;
            
            if (weekNum <= 26) {
                // Période V1 - afficher V1 restantes
                totalRestantes = VISITES.ssi.v1Restantes.total + VISITES.dsf.restantes.total;
            } else {
                // Période V2 - afficher V2 restantes
                totalRestantes = VISITES.ssi.v2Restantes.total + VISITES.dsf.restantes.total;
            }
            
            const kpiEl = document.getElementById('kpiVisites');
            if (kpiEl) kpiEl.textContent = totalRestantes;
            
            console.log('📊 KPI Visites:', totalRestantes, 'restantes');
        }

        function getWeekDates(weekNum) {
            const year = new Date().getFullYear();
            const startOfYear = new Date(year, 0, 1);
            const startOfWeek = new Date(startOfYear);
            startOfWeek.setDate(startOfWeek.getDate() + (weekNum - 1) * 7 - startOfYear.getDay() + 1);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return `${startOfWeek.toLocaleDateString('fr-FR', options)} - ${endOfWeek.toLocaleDateString('fr-FR', options)}`;
        }

        // ============================================
        // MODULE VISITESMODULE - Planning, Historique, Modal STT
        // ============================================
        const MAIL_HISTORY_KEY = 'mailHistory_gestionpro';
        const MAIL_HISTORY_PLANIFIER_KEY = 'mailHistoryPlanifier_gestionpro';
        const MONTH_NAMES = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
        
        const VISITESMODULE = {
            currentSTT: null,
            sttOverdueData: {},
            mailHistory: {},
            mailHistoryPlanifier: {},

            init() {
                console.log('📅 Initialisation VISITESMODULE...');
                this.loadMailHistory();
                this.generateSTTSummary();
                this.generatePlanningTable();
                this.updateHistorique();
            },

            loadMailHistory() {
                try {
                    const stored = localStorage.getItem(MAIL_HISTORY_KEY);
                    if (stored) {
                        this.mailHistory = JSON.parse(stored);
                    }
                    const storedPlanifier = localStorage.getItem(MAIL_HISTORY_PLANIFIER_KEY);
                    if (storedPlanifier) {
                        this.mailHistoryPlanifier = JSON.parse(storedPlanifier);
                    }
                } catch (e) {
                    console.warn('Erreur chargement historique mail:', e);
                }
            },

            saveMailHistory(type = 'retard') {
                try {
                    if (type === 'retard') {
                        localStorage.setItem(MAIL_HISTORY_KEY, JSON.stringify(this.mailHistory));
                    } else {
                        localStorage.setItem(MAIL_HISTORY_PLANIFIER_KEY, JSON.stringify(this.mailHistoryPlanifier));
                    }
                } catch (e) {
                    console.warn('Erreur sauvegarde historique mail:', e);
                }
            },

            generateSTTSummary() {
                const grid = document.getElementById('sttSummaryGrid');
                if (!grid) return;

                // Collecter les données par STT
                this.sttOverdueData = {};
                const currentMonth = new Date().getMonth() + 1;

                // DSF data
                APP.data.dsf.forEach(row => {
                    const sttCode = row.sttCode || '';
                    const sttName = row.sttConverted || sttCode || 'Inconnu';
                    const sector = (row.secteur || 'AUTRES').toUpperCase();
                    const sectorKey = ['S1', 'S2', 'S3'].includes(sector) ? sector.toLowerCase() : 'autres';
                    const moisStr = row.mois || '';
                    
                    // Extraire le numéro de mois
                    let moisNum = 0;
                    const moisMatch = moisStr.match(/(\d+)/);
                    if (moisMatch) {
                        moisNum = parseInt(moisMatch[1]);
                    } else {
                        const moisIndex = MONTH_NAMES.findIndex(m => moisStr.toLowerCase().includes(m.toLowerCase()));
                        if (moisIndex >= 0) moisNum = moisIndex + 1;
                    }

                    const key = `${sttName}#${sectorKey}`;
                    if (!this.sttOverdueData[key]) {
                        this.sttOverdueData[key] = {
                            sttName,
                            sttCode,
                            sector: sectorKey,
                            email: row.sttEmail || '',
                            sites: [],
                            sitesAPlanifier: [],
                            totalSites: 0,
                            retardSites: 0,
                            planifierSites: 0
                        };
                    }

                    this.sttOverdueData[key].totalSites++;

                    // Site en retard si mois < mois actuel
                    if (moisNum > 0 && moisNum < currentMonth) {
                        this.sttOverdueData[key].retardSites++;
                        this.sttOverdueData[key].sites.push({
                            numClient: row.numClient || '',
                            nomSite: row.nomSite || '',
                            ville: row.ville || '',
                            moisSTT: MONTH_NAMES[moisNum - 1] || moisStr
                        });
                    }
                    // Site à planifier si mois >= mois actuel
                    else if (moisNum >= currentMonth) {
                        this.sttOverdueData[key].planifierSites++;
                        this.sttOverdueData[key].sitesAPlanifier.push({
                            numClient: row.numClient || '',
                            nomSite: row.nomSite || '',
                            ville: row.ville || '',
                            moisSTT: MONTH_NAMES[moisNum - 1] || moisStr
                        });
                    }
                });

                // Générer les cartes
                let html = '';
                Object.entries(this.sttOverdueData).forEach(([key, data]) => {
                    const hasRetard = data.retardSites > 0;
                    html += `
                        <div class="stt-card ${hasRetard ? 'has-retard' : ''}" data-sector="${data.sector.toUpperCase()}" data-stt="${data.sttName}" onclick="VISITESMODULE.openModalSTT('${key}')">
                            <div class="stt-card-header">
                                <span class="stt-card-name">${data.sttName}</span>
                                <span class="stt-card-sector ${data.sector}">${data.sector.toUpperCase()}</span>
                            </div>
                            <div class="stt-card-stats">
                                <div class="stt-card-stat">
                                    <span>📊</span> ${data.totalSites} sites
                                </div>
                                ${hasRetard ? `
                                    <div class="stt-card-stat retard">
                                        <span>⚠️</span> ${data.retardSites} en retard
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                grid.innerHTML = html || '<div class="empty-state-mini"><p>Aucun STT trouvé</p></div>';
            },

            generatePlanningTable() {
                const tbody = document.getElementById('planningTableBody');
                const emptyEl = document.getElementById('planningEmpty');
                if (!tbody) return;

                const currentMonth = new Date().getMonth() + 1;
                const rows = [];

                APP.data.dsf.forEach(row => {
                    const moisStr = row.mois || '';
                    let moisNum = 0;
                    const moisMatch = moisStr.match(/(\d+)/);
                    if (moisMatch) {
                        moisNum = parseInt(moisMatch[1]);
                    } else {
                        const moisIndex = MONTH_NAMES.findIndex(m => moisStr.toLowerCase().includes(m.toLowerCase()));
                        if (moisIndex >= 0) moisNum = moisIndex + 1;
                    }

                    const isRetard = moisNum > 0 && moisNum < currentMonth;
                    const sector = (row.secteur || 'AUTRES').toUpperCase();

                    rows.push({
                        sector,
                        stt: row.sttConverted || row.sttCode || '',
                        numClient: row.numClient || '',
                        nomSite: row.nomSite || '',
                        ville: row.ville || '',
                        mois: MONTH_NAMES[moisNum - 1] || moisStr,
                        moisNum,
                        isRetard
                    });
                });

                // Trier par mois puis secteur
                rows.sort((a, b) => a.moisNum - b.moisNum || a.sector.localeCompare(b.sector));

                let html = '';
                rows.forEach(r => {
                    html += `
                        <tr data-sector="${r.sector}" data-stt="${r.stt}" data-mois="${r.moisNum}" data-statut="${r.isRetard ? 'RETARD' : 'OK'}">
                            <td><span class="sector-badge ${r.sector.toLowerCase()}">${r.sector}</span></td>
                            <td>${r.stt}</td>
                            <td>${r.numClient}</td>
                            <td>${r.nomSite}</td>
                            <td>${r.ville}</td>
                            <td>${r.mois}</td>
                            <td><span class="status-badge ${r.isRetard ? 'retard' : 'ok'}">${r.isRetard ? '⚠️ Retard' : '✅ OK'}</span></td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
                if (emptyEl) emptyEl.style.display = rows.length ? 'none' : 'block';
                
                // Remplir les filtres dynamiquement
                this.populatePlanningFilters(rows);
            },

            populatePlanningFilters(rows) {
                // Collecter les valeurs uniques
                const sectors = new Set();
                const stts = new Set();
                const moisSet = new Set();

                rows.forEach(r => {
                    if (r.sector) sectors.add(r.sector);
                    if (r.stt) stts.add(r.stt);
                    if (r.moisNum > 0) moisSet.add(r.moisNum);
                });

                // Filtre Secteur
                const sectorSelect = document.getElementById('planningFilterSector');
                if (sectorSelect) {
                    const currentVal = sectorSelect.value;
                    sectorSelect.innerHTML = '<option value="TOUS">Tous les secteurs</option>';
                    [...sectors].sort().forEach(s => {
                        sectorSelect.innerHTML += `<option value="${s}">${s}</option>`;
                    });
                    sectorSelect.value = currentVal;
                }

                // Filtre STT (avec conversion - garde le nom converti)
                const sttSelect = document.getElementById('planningFilterSTT');
                if (sttSelect) {
                    const currentVal = sttSelect.value;
                    sttSelect.innerHTML = '<option value="TOUS">Tous les STT</option>';
                    [...stts].sort().forEach(s => {
                        sttSelect.innerHTML += `<option value="${s}">${s}</option>`;
                    });
                    sttSelect.value = currentVal;
                }

                // Filtre Mois
                const moisSelect = document.getElementById('planningFilterMois');
                if (moisSelect) {
                    const currentVal = moisSelect.value;
                    moisSelect.innerHTML = '<option value="TOUS">Tous les mois</option>';
                    [...moisSet].sort((a, b) => a - b).forEach(m => {
                        moisSelect.innerHTML += `<option value="${m}">${MONTH_NAMES[m - 1]}</option>`;
                    });
                    moisSelect.value = currentVal;
                }
            },

            filterPlanning() {
                const sectorFilter = document.getElementById('planningFilterSector')?.value || 'TOUS';
                const sttFilter = document.getElementById('planningFilterSTT')?.value || 'TOUS';
                const moisFilter = document.getElementById('planningFilterMois')?.value || 'TOUS';
                const statutFilter = document.getElementById('planningFilterStatut')?.value || 'TOUS';

                // 1. Filtrer les lignes du tableau Planning
                const rows = document.querySelectorAll('#planningTableBody tr');
                const visibleRows = [];
                
                rows.forEach(row => {
                    const sector = row.dataset.sector || '';
                    const stt = row.dataset.stt || '';
                    const moisNum = row.dataset.mois || '';
                    const statut = row.dataset.statut || '';

                    let show = true;
                    if (sectorFilter !== 'TOUS' && sector !== sectorFilter) show = false;
                    if (sttFilter !== 'TOUS' && stt !== sttFilter) show = false;
                    if (moisFilter !== 'TOUS' && moisNum !== moisFilter) show = false;
                    if (statutFilter !== 'TOUS' && statut !== statutFilter) show = false;

                    row.style.display = show ? '' : 'none';
                    if (show) visibleRows.push({ sector, stt, moisNum, statut });
                });

                // 2. Filtrer les cartes STT du récapitulatif
                const sttCards = document.querySelectorAll('#sttSummaryGrid .stt-card');
                sttCards.forEach(card => {
                    const cardSector = card.dataset.sector || '';
                    const cardStt = card.dataset.stt || '';

                    let show = true;
                    if (sectorFilter !== 'TOUS' && cardSector !== sectorFilter) show = false;
                    if (sttFilter !== 'TOUS' && cardStt !== sttFilter) show = false;

                    card.style.display = show ? '' : 'none';
                });

                // 3. Mettre à jour les filtres dynamiquement (cascade)
                this.updateFiltersOptions(sectorFilter, sttFilter, moisFilter, statutFilter, visibleRows);
            },

            updateFiltersOptions(currentSector, currentStt, currentMois, currentStatut, visibleRows) {
                // Collecter les valeurs disponibles selon les filtres actuels
                const allRows = document.querySelectorAll('#planningTableBody tr');
                
                // Pour chaque filtre, déterminer les options valides
                const sectorsAvailable = new Set();
                const sttsAvailable = new Set();
                const moisAvailable = new Set();
                const statutsAvailable = new Set();

                allRows.forEach(row => {
                    const sector = row.dataset.sector || '';
                    const stt = row.dataset.stt || '';
                    const moisNum = row.dataset.mois || '';
                    const statut = row.dataset.statut || '';

                    // Secteurs disponibles (sans filtre secteur)
                    let matchOthers = true;
                    if (currentStt !== 'TOUS' && stt !== currentStt) matchOthers = false;
                    if (currentMois !== 'TOUS' && moisNum !== currentMois) matchOthers = false;
                    if (currentStatut !== 'TOUS' && statut !== currentStatut) matchOthers = false;
                    if (matchOthers && sector) sectorsAvailable.add(sector);

                    // STT disponibles (sans filtre STT)
                    matchOthers = true;
                    if (currentSector !== 'TOUS' && sector !== currentSector) matchOthers = false;
                    if (currentMois !== 'TOUS' && moisNum !== currentMois) matchOthers = false;
                    if (currentStatut !== 'TOUS' && statut !== currentStatut) matchOthers = false;
                    if (matchOthers && stt) sttsAvailable.add(stt);

                    // Mois disponibles (sans filtre mois)
                    matchOthers = true;
                    if (currentSector !== 'TOUS' && sector !== currentSector) matchOthers = false;
                    if (currentStt !== 'TOUS' && stt !== currentStt) matchOthers = false;
                    if (currentStatut !== 'TOUS' && statut !== currentStatut) matchOthers = false;
                    if (matchOthers && moisNum) moisAvailable.add(moisNum);

                    // Statuts disponibles
                    matchOthers = true;
                    if (currentSector !== 'TOUS' && sector !== currentSector) matchOthers = false;
                    if (currentStt !== 'TOUS' && stt !== currentStt) matchOthers = false;
                    if (currentMois !== 'TOUS' && moisNum !== currentMois) matchOthers = false;
                    if (matchOthers && statut) statutsAvailable.add(statut);
                });

                // Mettre à jour filtre Secteur
                const sectorSelect = document.getElementById('planningFilterSector');
                if (sectorSelect) {
                    const options = sectorSelect.querySelectorAll('option');
                    options.forEach(opt => {
                        if (opt.value !== 'TOUS') {
                            opt.disabled = !sectorsAvailable.has(opt.value);
                            opt.style.color = opt.disabled ? '#ccc' : '';
                        }
                    });
                }

                // Mettre à jour filtre STT
                const sttSelect = document.getElementById('planningFilterSTT');
                if (sttSelect) {
                    const options = sttSelect.querySelectorAll('option');
                    options.forEach(opt => {
                        if (opt.value !== 'TOUS') {
                            opt.disabled = !sttsAvailable.has(opt.value);
                            opt.style.color = opt.disabled ? '#ccc' : '';
                        }
                    });
                }

                // Mettre à jour filtre Mois
                const moisSelect = document.getElementById('planningFilterMois');
                if (moisSelect) {
                    const options = moisSelect.querySelectorAll('option');
                    options.forEach(opt => {
                        if (opt.value !== 'TOUS') {
                            opt.disabled = !moisAvailable.has(opt.value);
                            opt.style.color = opt.disabled ? '#ccc' : '';
                        }
                    });
                }

                // Mettre à jour filtre Statut
                const statutSelect = document.getElementById('planningFilterStatut');
                if (statutSelect) {
                    const options = statutSelect.querySelectorAll('option');
                    options.forEach(opt => {
                        if (opt.value !== 'TOUS') {
                            opt.disabled = !statutsAvailable.has(opt.value);
                            opt.style.color = opt.disabled ? '#ccc' : '';
                        }
                    });
                }
            },

            updateHistorique() {
                // Utilise l'historique SSI existant
                displaySSIHistory();
            },

            openModalSTT(key) {
                const data = this.sttOverdueData[key];
                if (!data) return;

                this.currentSTT = { key, ...data };

                document.getElementById('modalSTTTitle').textContent = `📋 Fiche STT - ${data.sttName}`;
                document.getElementById('modalSTTName').textContent = data.sttName;
                document.getElementById('modalSTTSector').textContent = data.sector.toUpperCase();
                document.getElementById('modalSTTEmail').textContent = data.email || 'Email non trouvé';
                document.getElementById('modalSTTRetardCount').textContent = data.retardSites || 0;
                document.getElementById('modalSTTPlanifierCount').textContent = data.planifierSites || 0;

                // Historique envois RETARD
                const mailDatesRetard = this.getMailDates(key, 'retard');
                document.getElementById('modalSTTLastSentRetard').textContent = mailDatesRetard.last;
                document.getElementById('modalSTTSecondLastSentRetard').textContent = mailDatesRetard.secondLast;

                // Historique envois PLANIFIER
                const mailDatesPlanifier = this.getMailDates(key, 'planifier');
                document.getElementById('modalSTTLastSentPlanifier').textContent = mailDatesPlanifier.last;
                document.getElementById('modalSTTSecondLastSentPlanifier').textContent = mailDatesPlanifier.secondLast;

                // Tableau sites en retard
                const tbodyRetard = document.getElementById('modalSTTSitesRetardBody');
                let htmlRetard = '';
                if (data.sites && data.sites.length > 0) {
                    data.sites.forEach(site => {
                        htmlRetard += `
                            <tr>
                                <td>${site.numClient}</td>
                                <td>${site.nomSite}</td>
                                <td>${site.ville}</td>
                                <td>${site.moisSTT}</td>
                            </tr>
                        `;
                    });
                } else {
                    htmlRetard = '<tr><td colspan="4" style="text-align:center; color: var(--success);">✅ Aucun site en retard</td></tr>';
                }
                tbodyRetard.innerHTML = htmlRetard;

                // Tableau sites à planifier
                const tbodyPlanifier = document.getElementById('modalSTTSitesPlanifierBody');
                let htmlPlanifier = '';
                if (data.sitesAPlanifier && data.sitesAPlanifier.length > 0) {
                    data.sitesAPlanifier.forEach(site => {
                        htmlPlanifier += `
                            <tr>
                                <td>${site.numClient}</td>
                                <td>${site.nomSite}</td>
                                <td>${site.ville}</td>
                                <td>${site.moisSTT}</td>
                            </tr>
                        `;
                    });
                } else {
                    htmlPlanifier = '<tr><td colspan="4" style="text-align:center; color: var(--success);">✅ Aucun site à planifier</td></tr>';
                }
                tbodyPlanifier.innerHTML = htmlPlanifier;

                // Reset onglet actif
                this.switchModalTab('retard');

                document.getElementById('modalSTTStatus').textContent = '';
                document.getElementById('modalSTT').style.display = 'flex';
            },

            switchModalTab(tab) {
                // Onglets
                document.querySelectorAll('.modal-stt-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.modal-stt-tab.${tab}`).classList.add('active');
                
                // Contenus
                document.querySelectorAll('.modal-stt-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`modalSTTContent${tab === 'retard' ? 'Retard' : 'Planifier'}`).classList.add('active');
            },

            closeModalSTT() {
                document.getElementById('modalSTT').style.display = 'none';
                this.currentSTT = null;
            },

            getMailDates(key, type = 'retard') {
                const history = type === 'retard' ? this.mailHistory : this.mailHistoryPlanifier;
                const dates = history[key] || [];
                return {
                    last: dates[0] ? new Date(dates[0]).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Non enregistré',
                    secondLast: dates[1] ? new Date(dates[1]).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Non enregistré'
                };
            },

            generateMailSTT(type = 'retard') {
                if (!this.currentSTT) return;

                const { sttName, sector, email, sites, sitesAPlanifier } = this.currentSTT;
                const statusEl = document.getElementById('modalSTTStatus');
                
                // Choisir les sites selon le type
                const sitesToSend = type === 'retard' ? sites : sitesAPlanifier;

                if (!sitesToSend || sitesToSend.length === 0) {
                    statusEl.textContent = type === 'retard' 
                        ? '❌ Aucun site en retard à envoyer.' 
                        : '❌ Aucun site à planifier à envoyer.';
                    statusEl.className = 'mail-status error';
                    return;
                }

                // Sujet différent selon le type
                const sectorName = sector.toUpperCase();
                let subject, bodyIntro;
                
                if (type === 'retard') {
                    subject = `⚠️ ALERTE : ${sitesToSend.length} Visite(s) DSF en RETARD pour ${sttName} (${sectorName})`;
                    bodyIntro = `La liste des ${sitesToSend.length} sites DSF pour le STT ${sttName} (${sectorName}) en retard de planification :`;
                } else {
                    subject = `📅 RAPPEL : ${sitesToSend.length} Visite(s) DSF À PLANIFIER pour ${sttName} (${sectorName})`;
                    bodyIntro = `La liste des ${sitesToSend.length} sites DSF pour le STT ${sttName} (${sectorName}) à planifier prochainement :`;
                }

                // Corps du mail - Format identique à TABLEAU_V2.html
                let body = `Bonjour,\n\n`;
                body += bodyIntro + `\n\n`;

                // Largeurs colonnes
                const colWidths = { numClient: 15, nomSite: 50, ville: 20, moisSTT: 15 };
                const headerWidths = {
                    numClient: Math.max('NUM. CLIENT'.length, colWidths.numClient),
                    nomSite: Math.max('NOM DU SITE'.length, colWidths.nomSite),
                    ville: Math.max('VILLE'.length, colWidths.ville),
                    moisSTT: Math.max('MOIS STT'.length, colWidths.moisSTT)
                };

                const sep = '    ';

                // En-tête
                const header = 
                    'NUM. CLIENT'.padEnd(headerWidths.numClient) + sep +
                    'NOM DU SITE'.padEnd(headerWidths.nomSite) + sep +
                    'VILLE'.padEnd(headerWidths.ville) + sep +
                    'MOIS STT'.padEnd(headerWidths.moisSTT);

                const separatorLine = '═'.repeat(header.length);

                body += header + '\n';
                body += separatorLine + '\n';

                // Lignes de données
                sitesToSend.forEach(site => {
                    body += 
                        String(site.numClient).padEnd(headerWidths.numClient) + sep +
                        String(site.nomSite).padEnd(headerWidths.nomSite) + sep +
                        String(site.ville).padEnd(headerWidths.ville) + sep +
                        String(site.moisSTT).padEnd(headerWidths.moisSTT) + '\n';
                });

                // Conclusion différente selon le type
                if (type === 'retard') {
                    body += `\nMerci de planifier ces visites en priorité et de nous remonter les informations.\n\nCordialement,\nVotre Tableau de Bord de Suivi`;
                } else {
                    body += `\nMerci de nous confirmer les dates de planification prévues pour ces visites.\n\nCordialement,\nVotre Tableau de Bord de Suivi`;
                }

                // Lien mailto
                const mailtoLink = `mailto:${email || ''}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

                window.open(mailtoLink, '_self');

                statusEl.innerHTML = '✉️ Le client de messagerie a été ouvert avec le mail pré-rempli.';
                statusEl.className = 'mail-status success';
            },

            archiveMailDate(type = 'retard') {
                if (!this.currentSTT) return;

                const key = this.currentSTT.key;
                const now = new Date().toISOString();
                
                // Choisir le bon historique selon le type
                const history = type === 'retard' ? this.mailHistory : this.mailHistoryPlanifier;

                if (!history[key]) {
                    history[key] = [];
                }

                // Ajouter au début et garder max 2
                history[key].unshift(now);
                if (history[key].length > 2) {
                    history[key] = history[key].slice(0, 2);
                }

                this.saveMailHistory(type);

                // Mettre à jour l'affichage selon le type
                const mailDates = this.getMailDates(key, type);
                if (type === 'retard') {
                    document.getElementById('modalSTTLastSentRetard').textContent = mailDates.last;
                    document.getElementById('modalSTTSecondLastSentRetard').textContent = mailDates.secondLast;
                } else {
                    document.getElementById('modalSTTLastSentPlanifier').textContent = mailDates.last;
                    document.getElementById('modalSTTSecondLastSentPlanifier').textContent = mailDates.secondLast;
                }

                const statusEl = document.getElementById('modalSTTStatus');
                const typeLabel = type === 'retard' ? 'RETARD' : 'RAPPEL';
                statusEl.innerHTML = `💾 Date d'envoi ${typeLabel} archivée avec succès !`;
                statusEl.className = 'mail-status success';
            },

            exportHistorique() {
                alert('📥 Export en cours de développement...');
            }
        };

        // Traitement données SSI (utilise les données pré-traitées)
        function processSSIData() {
            const counts = { s1: 0, s2: 0, s3: 0, autres: 0, total: 0 };
            const v1Restantes = { s1: 0, s2: 0, s3: 0, autres: 0, total: 0 };
            const v2Restantes = { s1: 0, s2: 0, s3: 0, autres: 0, total: 0 };
            
            APP.data.ssi.forEach(row => {
                const sectorKey = row.secteur ? row.secteur.toLowerCase() : 'autres';
                const key = sectorKey === 's1' || sectorKey === 's2' || sectorKey === 's3' ? sectorKey : 'autres';
                
                counts[key]++;
                if (row.v1Restante) v1Restantes[key]++;
                if (row.v2Restante) v2Restantes[key]++;
            });
            
            counts.total = counts.s1 + counts.s2 + counts.s3 + counts.autres;
            v1Restantes.total = v1Restantes.s1 + v1Restantes.s2 + v1Restantes.s3 + v1Restantes.autres;
            v2Restantes.total = v2Restantes.s1 + v2Restantes.s2 + v2Restantes.s3 + v2Restantes.autres;
            
            VISITES.ssi.counts = counts;
            VISITES.ssi.v1Restantes = v1Restantes;
            VISITES.ssi.v2Restantes = v2Restantes;
            
            console.log('📊 SSI traité:', counts.total, 'sites, V1 restantes:', v1Restantes.total, ', V2 restantes:', v2Restantes.total);
            
            // Archiver la semaine courante
            archiveSSICurrentWeek();
        }

        function displaySSIStats() {
            const counts = VISITES.ssi.counts;
            const v1 = VISITES.ssi.v1Restantes;
            const v2 = VISITES.ssi.v2Restantes;
            
            console.log('🎨 displaySSIStats - Données:', { counts, v1, v2 });
            
            ['s1', 's2', 's3', 'autres'].forEach(sector => {
                // Construire l'ID correctement
                let idSuffix;
                if (sector === 's1') idSuffix = 'S1';
                else if (sector === 's2') idSuffix = 'S2';
                else if (sector === 's3') idSuffix = 'S3';
                else idSuffix = 'Autres';
                
                // Sites
                const sitesId = `ssiStat${idSuffix}Sites`;
                const sitesEl = document.getElementById(sitesId);
                console.log(`   ${sitesId}: element=${sitesEl ? 'TROUVÉ' : 'NULL'}, value=${counts[sector]}`);
                if (sitesEl) sitesEl.textContent = counts[sector];
                
                // V1
                const v1Done = counts[sector] - v1[sector];
                const v1Pct = counts[sector] > 0 ? Math.round((v1Done / counts[sector]) * 100) : 0;
                
                const v1Id = `ssiStat${idSuffix}V1`;
                const v1El = document.getElementById(v1Id);
                if (v1El) v1El.textContent = v1[sector];
                
                const v1PctId = `ssiStat${idSuffix}V1Pct`;
                const v1PctEl = document.getElementById(v1PctId);
                if (v1PctEl) {
                    v1PctEl.textContent = v1Pct + '%';
                    v1PctEl.className = 'visit-percent ' + getPercentClass(v1Pct);
                }
                
                const v1BarId = `ssiStat${idSuffix}V1Bar`;
                const v1BarEl = document.getElementById(v1BarId);
                if (v1BarEl) v1BarEl.style.width = v1Pct + '%';
                
                // V2
                const v2Done = counts[sector] - v2[sector];
                const v2Pct = counts[sector] > 0 ? Math.round((v2Done / counts[sector]) * 100) : 0;
                
                const v2Id = `ssiStat${idSuffix}V2`;
                const v2El = document.getElementById(v2Id);
                if (v2El) v2El.textContent = v2[sector];
                
                const v2PctId = `ssiStat${idSuffix}V2Pct`;
                const v2PctEl = document.getElementById(v2PctId);
                if (v2PctEl) {
                    v2PctEl.textContent = v2Pct + '%';
                    v2PctEl.className = 'visit-percent ' + getPercentClass(v2Pct);
                }
                
                const v2BarId = `ssiStat${idSuffix}V2Bar`;
                const v2BarEl = document.getElementById(v2BarId);
                if (v2BarEl) v2BarEl.style.width = v2Pct + '%';
            });
            
            // Mettre à jour le dashboard aussi
            updateDashboardSSI();
        }

        function updateDashboardSSI() {
            const counts = VISITES.ssi.counts;
            const v1 = VISITES.ssi.v1Restantes;
            const v2 = VISITES.ssi.v2Restantes;
            
            console.log('🎨 updateDashboardSSI - Données:', { counts, v1, v2 });
            
            // Calculer semaines restantes
            const weekNum = APP.currentWeek.num;
            const isV1 = weekNum <= 26;
            const weeksRemaining = isV1 ? Math.max(1, 26 - weekNum + 1) : Math.max(1, 52 - weekNum + 1);
            
            ['s1', 's2', 's3', 'autres'].forEach(sector => {
                // Construire l'ID correctement : ssiS1Sites, ssiS2Sites, ssiS3Sites, ssiAutresSites
                let idSuffix;
                if (sector === 's1') idSuffix = 'S1';
                else if (sector === 's2') idSuffix = 'S2';
                else if (sector === 's3') idSuffix = 'S3';
                else idSuffix = 'Autres';
                
                // Dashboard - Sites (IDs: ssiS1Sites, ssiS2Sites, ssiS3Sites, ssiAutresSites)
                const sitesId = `ssi${idSuffix}Sites`;
                const sitesEl = document.getElementById(sitesId);
                console.log(`   Dashboard ${sitesId}: element=${sitesEl ? 'TROUVÉ' : 'NULL'}, value=${counts[sector]}`);
                if (sitesEl) sitesEl.textContent = counts[sector];
                
                // Dashboard - V1
                const v1Done = counts[sector] - v1[sector];
                const v1Pct = counts[sector] > 0 ? Math.round((v1Done / counts[sector]) * 100) : 0;
                
                const v1El = document.getElementById(`ssi${idSuffix}V1`);
                if (v1El) v1El.textContent = v1[sector];
                
                const v1PctEl = document.getElementById(`ssi${idSuffix}V1Pct`);
                if (v1PctEl) {
                    v1PctEl.textContent = v1Pct + '%';
                    v1PctEl.className = 'stat-percent ' + getPercentClass(v1Pct);
                }
                
                // Dashboard - V2
                const v2Done = counts[sector] - v2[sector];
                const v2Pct = counts[sector] > 0 ? Math.round((v2Done / counts[sector]) * 100) : 0;
                
                const v2El = document.getElementById(`ssi${idSuffix}V2`);
                if (v2El) v2El.textContent = v2[sector];
                
                const v2PctEl = document.getElementById(`ssi${idSuffix}V2Pct`);
                if (v2PctEl) {
                    v2PctEl.textContent = v2Pct + '%';
                    v2PctEl.className = 'stat-percent ' + getPercentClass(v2Pct);
                }
                
                // Dashboard - Progress
                const progressEl = document.getElementById(`ssi${idSuffix}Progress`);
                if (progressEl) {
                    const avgPct = Math.round((v1Pct + v2Pct) / 2);
                    progressEl.style.width = avgPct + '%';
                }
                
                // Dashboard - Objectif par secteur
                const restantes = isV1 ? v1[sector] : v2[sector];
                const objectif = Math.ceil(restantes / weeksRemaining);
                const objectifEl = document.getElementById(`ssi${idSuffix}Objectif`);
                if (objectifEl) {
                    objectifEl.textContent = `Objectif: ~${objectif}/sem (${weeksRemaining} sem.)`;
                }
            });
            
            // KPI Visites - inclure aussi DSF
            let totalRestantes;
            if (weekNum <= 26) {
                totalRestantes = v1.total + (VISITES.dsf.restantes?.total || 0);
            } else {
                totalRestantes = v2.total + (VISITES.dsf.restantes?.total || 0);
            }
            const kpiEl = document.getElementById('kpiVisites');
            if (kpiEl) kpiEl.textContent = totalRestantes;
        }

        // Historique SSI
        function loadSSIHistory() {
            try {
                const stored = localStorage.getItem(SSI_HISTORY_KEY);
                if (stored) {
                    VISITES.ssi.history = JSON.parse(stored);
                }
            } catch (e) {
                console.warn('Erreur chargement historique SSI:', e);
            }
        }

        function saveSSIHistory() {
            try {
                localStorage.setItem(SSI_HISTORY_KEY, JSON.stringify(VISITES.ssi.history));
            } catch (e) {
                console.warn('Erreur sauvegarde historique SSI:', e);
            }
        }

        function archiveSSICurrentWeek() {
            const weekNum = APP.currentWeek.num;
            const v1 = VISITES.ssi.v1Restantes;
            const v2 = VISITES.ssi.v2Restantes;
            const counts = VISITES.ssi.counts;
            
            ['s1', 's2', 's3', 'autres'].forEach(sector => {
                if (!VISITES.ssi.history[sector]) {
                    VISITES.ssi.history[sector] = [];
                }
                
                const existingIndex = VISITES.ssi.history[sector].findIndex(e => e.week === weekNum);
                
                let entry;
                if (weekNum <= 26) {
                    const prevEntry = VISITES.ssi.history[sector].filter(e => e.type === 'V1' && e.week < weekNum).pop();
                    const prevRestantes = prevEntry ? prevEntry.restantes : v1[sector];
                    const realisees = prevRestantes - v1[sector];
                    const weeksLeft = Math.max(1, 26 - weekNum + 1);
                    const objectif = Math.ceil(v1[sector] / weeksLeft);
                    
                    entry = {
                        week: weekNum,
                        type: 'V1',
                        restantes: v1[sector],
                        realisees: realisees,
                        objectif: objectif
                    };
                } else {
                    const prevEntry = VISITES.ssi.history[sector].filter(e => e.type === 'V2' && e.week < weekNum).pop();
                    const prevRestantes = prevEntry ? prevEntry.restantes : v2[sector];
                    const realisees = prevRestantes - v2[sector];
                    const weeksLeft = Math.max(1, 52 - weekNum + 1);
                    const objectif = Math.ceil(v2[sector] / weeksLeft);
                    
                    entry = {
                        week: weekNum,
                        type: 'V2',
                        restantes: v2[sector],
                        realisees: realisees,
                        objectif: objectif
                    };
                }
                
                if (existingIndex !== -1) {
                    VISITES.ssi.history[sector][existingIndex] = entry;
                } else {
                    VISITES.ssi.history[sector].push(entry);
                }
                
                VISITES.ssi.history[sector].sort((a, b) => a.week - b.week);
            });
            
            saveSSIHistory();
        }

        function archiveSSIWeek() {
            archiveSSICurrentWeek();
            displaySSIHistory();
            alert('✅ Semaine ' + APP.currentWeek.num + ' archivée avec succès !');
        }

        function displaySSIHistory() {
            const weekNum = APP.currentWeek.num;
            
            ['s1', 's2', 's3', 'autres'].forEach(sector => {
                // Construire l'ID correctement : ssiHistoryS1, ssiHistoryS2, ssiHistoryS3, ssiHistoryAutres
                let idSuffix;
                if (sector === 's1') idSuffix = 'S1';
                else if (sector === 's2') idSuffix = 'S2';
                else if (sector === 's3') idSuffix = 'S3';
                else idSuffix = 'Autres';
                
                const tbody = document.getElementById(`ssiHistory${idSuffix}`);
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                const history = VISITES.ssi.history[sector] || [];
                
                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted); padding: 30px;">Aucune donnée archivée</td></tr>';
                    return;
                }
                
                history.forEach(entry => {
                    const row = document.createElement('tr');
                    const isCurrentWeek = entry.week === weekNum;
                    if (isCurrentWeek) row.className = 'current-week';
                    
                    const realiseClass = entry.realisees > 0 ? 'cell-realise positive' : 'cell-realise negative';
                    const realiseText = entry.realisees >= 0 ? `+${entry.realisees}` : entry.realisees;
                    
                    row.innerHTML = `
                        <td>${isCurrentWeek ? '➤ ' : ''}Semaine ${entry.week}</td>
                        <td><span class="cell-type ${entry.type.toLowerCase()}">${entry.type}</span></td>
                        <td style="font-weight: 700; font-family: 'JetBrains Mono', monospace;">${entry.restantes}</td>
                        <td><span class="${realiseClass}">${realiseText}</span></td>
                        <td class="cell-objectif">${entry.objectif}/sem</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            });
        }

        // Traitement données DSF (utilise les données pré-traitées)
        function processDSFData() {
            const counts = { s1: 0, s2: 0, s3: 0, autres: 0, total: 0 };
            const restantes = { s1: 0, s2: 0, s3: 0, autres: 0, total: 0 };
            const totales = { s1: 0, s2: 0, s3: 0, autres: 0, total: 0 };
            
            VISITES.dsf.rawData = [];
            
            APP.data.dsf.forEach(row => {
                const sectorKey = row.secteur ? row.secteur.toLowerCase() : 'autres';
                const key = sectorKey === 's1' || sectorKey === 's2' || sectorKey === 's3' ? sectorKey : 'autres';
                
                counts[key]++;
                restantes[key] += row.visitesRestantes || 0;
                totales[key] += row.visitesTotales || 0;
                
                VISITES.dsf.rawData.push({
                    sector: key,
                    stt: row.sttConverted || '',
                    sttCode: row.sttCode || '',
                    sttEmail: row.sttEmail || '',
                    mois: row.mois || '',
                    restantes: row.visitesRestantes || 0,
                    totales: row.visitesTotales || 0,
                    numClient: row.numClient || '',
                    nomSite: row.nomSite || '',
                    ville: row.ville || ''
                });
            });
            
            counts.total = counts.s1 + counts.s2 + counts.s3 + counts.autres;
            restantes.total = restantes.s1 + restantes.s2 + restantes.s3 + restantes.autres;
            totales.total = totales.s1 + totales.s2 + totales.s3 + totales.autres;
            
            VISITES.dsf.counts = counts;
            VISITES.dsf.restantes = restantes;
            VISITES.dsf.totales = totales;
            
            console.log('🔥 DSF traité:', counts.total, 'sites, Restantes:', restantes.total);
        }

        function displayDSFStats() {
            const counts = VISITES.dsf.counts;
            const restantes = VISITES.dsf.restantes;
            const totales = VISITES.dsf.totales;
            
            console.log('🎨 displayDSFStats - Données:', { counts, restantes, totales });
            
            ['s1', 's2', 's3', 'autres'].forEach(sector => {
                // Construire l'ID correctement : dsfStatS1Sites, dsfStatS2Sites, etc.
                let idSuffix;
                if (sector === 's1') idSuffix = 'S1';
                else if (sector === 's2') idSuffix = 'S2';
                else if (sector === 's3') idSuffix = 'S3';
                else idSuffix = 'Autres';
                
                // Sites
                const sitesId = `dsfStat${idSuffix}Sites`;
                const sitesEl = document.getElementById(sitesId);
                console.log(`   DSF ${sitesId}: element=${sitesEl ? 'TROUVÉ' : 'NULL'}, value=${counts[sector]}`);
                if (sitesEl) sitesEl.textContent = counts[sector];
                
                // Restantes
                const restEl = document.getElementById(`dsfStat${idSuffix}Rest`);
                if (restEl) restEl.textContent = restantes[sector];
                
                // Pourcentage
                const done = totales[sector] - restantes[sector];
                const pct = totales[sector] > 0 ? Math.round((done / totales[sector]) * 100) : 0;
                
                const pctEl = document.getElementById(`dsfStat${idSuffix}Pct`);
                if (pctEl) pctEl.textContent = pct + '%';
                
                const barEl = document.getElementById(`dsfStat${idSuffix}Bar`);
                if (barEl) barEl.style.width = pct + '%';
                
                // Cercle de progression
                const circumference = 100.53;
                const offset = circumference - (pct / 100) * circumference;
                const circle = document.getElementById(`dsfCircle${idSuffix}`);
                if (circle) circle.style.strokeDashoffset = offset;
            });
            
            // Mettre à jour le dashboard
            updateDashboardDSF();
        }

        function updateDashboardDSF() {
            const counts = VISITES.dsf.counts;
            const restantes = VISITES.dsf.restantes;
            const totales = VISITES.dsf.totales;
            
            console.log('🎨 updateDashboardDSF - Données:', { counts, restantes, totales });
            
            ['s1', 's2', 's3', 'autres'].forEach(sector => {
                // Construire l'ID correctement : dsfS1Sites, dsfS2Sites, etc.
                let idSuffix;
                if (sector === 's1') idSuffix = 'S1';
                else if (sector === 's2') idSuffix = 'S2';
                else if (sector === 's3') idSuffix = 'S3';
                else idSuffix = 'Autres';
                
                const sitesId = `dsf${idSuffix}Sites`;
                const sitesEl = document.getElementById(sitesId);
                console.log(`   Dashboard ${sitesId}: element=${sitesEl ? 'TROUVÉ' : 'NULL'}, value=${counts[sector]}`);
                if (sitesEl) sitesEl.textContent = counts[sector];
                
                const restEl = document.getElementById(`dsf${idSuffix}Rest`);
                if (restEl) restEl.textContent = restantes[sector];
                
                const done = totales[sector] - restantes[sector];
                const pct = totales[sector] > 0 ? Math.round((done / totales[sector]) * 100) : 0;
                
                const pctEl = document.getElementById(`dsf${idSuffix}Pct`);
                if (pctEl) {
                    pctEl.textContent = pct + '%';
                    pctEl.className = 'stat-percent ' + getPercentClass(pct);
                }
                
                const progressEl = document.getElementById(`dsf${idSuffix}Progress`);
                if (progressEl) progressEl.style.width = pct + '%';
            });
        }

        function generateDSFPlanning() {
            const container = document.getElementById('dsfPlanningContainer');
            const emptyState = document.getElementById('dsfPlanningEmpty');
            
            if (VISITES.dsf.rawData.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Grouper par secteur et STT
            const dataBySection = { s1: {}, s2: {}, s3: {}, autres: {} };
            const currentMonth = new Date().getMonth() + 1;
            
            // Stocker les données pour la modal STT (global)
            window.DSF_STT_DATA = { s1: {}, s2: {}, s3: {}, autres: {} };
            
            VISITES.dsf.rawData.forEach(row => {
                const sttKey = row.stt || 'Sans nom';
                
                if (!dataBySection[row.sector][sttKey]) {
                    dataBySection[row.sector][sttKey] = {
                        nbVisitesTotales: 0,
                        mois: Array(12).fill(0),
                        visitesRestantes: 0,
                        visitesEnRetard: 0
                    };
                    // Stocker pour relance
                    window.DSF_STT_DATA[row.sector][sttKey] = {
                        email: row.sttEmail || '',
                        sitesEnRetard: [],
                        sitesAPlanifier: []
                    };
                }
                
                dataBySection[row.sector][sttKey].nbVisitesTotales += row.totales;
                dataBySection[row.sector][sttKey].visitesRestantes += row.restantes;
                
                if (row.mois && row.restantes > 0) {
                    const moisNum = parseInt(String(row.mois).trim());
                    if (moisNum >= 1 && moisNum <= 12) {
                        dataBySection[row.sector][sttKey].mois[moisNum - 1] += row.restantes;
                        const MOIS_NOMS = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
                        
                        if (moisNum < currentMonth) {
                            // Site en retard
                            dataBySection[row.sector][sttKey].visitesEnRetard += row.restantes;
                            window.DSF_STT_DATA[row.sector][sttKey].sitesEnRetard.push({
                                numClient: row.numClient || '',
                                nomSite: row.nomSite || '',
                                ville: row.ville || '',
                                moisSTT: MOIS_NOMS[moisNum - 1]
                            });
                        } else {
                            // Site à planifier (mois courant ou futur)
                            window.DSF_STT_DATA[row.sector][sttKey].sitesAPlanifier.push({
                                numClient: row.numClient || '',
                                nomSite: row.nomSite || '',
                                ville: row.ville || '',
                                moisSTT: MOIS_NOMS[moisNum - 1]
                            });
                        }
                    }
                }
            });
            
            // Générer les tableaux
            const moisNoms = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];
            const sectorColors = {
                s1: { name: '🔵 SECTEUR S1', class: 's1' },
                s2: { name: '🟢 SECTEUR S2', class: 's2' },
                s3: { name: '🔴 SECTEUR S3', class: 's3' },
                autres: { name: '⚪ AUTRES SECTEURS', class: 'autres' }
            };
            
            let html = '';
            
            Object.entries(dataBySection).forEach(([sector, data]) => {
                // Trier les STT par nombre de retards (décroissant)
                const sttList = Object.keys(data).sort((a, b) => {
                    return (data[b].visitesEnRetard || 0) - (data[a].visitesEnRetard || 0);
                });
                if (sttList.length === 0) return;
                
                let totalRestant = 0;
                
                html += `
                    <div class="dsf-planning-section" data-sector="${sector}">
                        <div class="dsf-planning-header history-table-header ${sectorColors[sector].class}">
                            <span class="icon-animated">${sectorColors[sector].name.split(' ')[0]}</span> ${sectorColors[sector].name.substring(2)} - PLANNING MENSUEL
                        </div>
                        <div class="dsf-planning-table-wrapper">
                            <table class="dsf-planning-table">
                                <thead>
                                    <tr>
                                        <th>STT</th>
                                        <th>Total</th>
                                        ${moisNoms.map((m, i) => `<th class="month-cell${i + 1 === currentMonth ? ' current' : ''}">${m}</th>`).join('')}
                                        <th>Retard</th>
                                        <th>Restant</th>
                                        <th>% Fait</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                sttList.forEach(stt => {
                    const d = data[stt];
                    const done = d.nbVisitesTotales - d.visitesRestantes;
                    const pct = d.nbVisitesTotales > 0 ? Math.round((done / d.nbVisitesTotales) * 100) : 0;
                    const pctClass = pct >= 75 ? 'good' : pct >= 50 ? 'warning' : 'danger';
                    const hasRetard = d.visitesEnRetard > 0;
                    
                    totalRestant += d.visitesRestantes;
                    
                    // STT cliquable si en retard - ouvre la modal
                    const sttDisplay = hasRetard 
                        ? `<span class="stt-clickable has-retard" onclick="openDSFRelanceModal('${stt.replace(/'/g, "\\'")}', '${sector}')" title="Cliquez pour relancer">${stt}</span>`
                        : stt;
                    
                    html += `
                        <tr${hasRetard ? ' style="background: rgba(239, 68, 68, 0.05);"' : ''}>
                            <td class="stt-name">${sttDisplay}</td>
                            <td>${d.nbVisitesTotales}</td>
                            ${d.mois.map((v, i) => {
                                const isOverdue = v > 0 && i + 1 < currentMonth;
                                const isCurrent = i + 1 === currentMonth;
                                return `<td class="month-cell${isCurrent ? ' current' : ''}${isOverdue ? ' overdue' : ''}">${v || '-'}</td>`;
                            }).join('')}
                            <td class="retard-cell">${d.visitesEnRetard || '-'}</td>
                            <td class="restant-cell">${d.visitesRestantes}</td>
                            <td class="percent-cell ${pctClass}">${pct}%</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="14" style="text-align: right;">TOTAL RESTANTES:</td>
                                        <td class="restant-cell">${totalRestant}</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function filterDSFPlanning(sector) {
            const sections = document.querySelectorAll('.dsf-planning-section');
            sections.forEach(section => {
                if (sector === 'all' || section.dataset.sector === sector) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });
        }

        // Fonction pour ouvrir la modal de relance STT depuis les tableaux DSF
        function openDSFRelanceModal(sttName, sector) {
            if (!window.DSF_STT_DATA || !window.DSF_STT_DATA[sector] || !window.DSF_STT_DATA[sector][sttName]) {
                alert('Données non disponibles pour ce STT');
                return;
            }

            const data = window.DSF_STT_DATA[sector][sttName];
            const sectorNames = { s1: 'S1', s2: 'S2', s3: 'S3', autres: 'AUTRES' };
            
            // Créer une clé compatible avec VISITESMODULE
            const key = `${sttName}#${sector}`;
            
            // Injecter les données dans VISITESMODULE.sttOverdueData
            if (typeof VISITESMODULE !== 'undefined') {
                VISITESMODULE.sttOverdueData[key] = {
                    sttName: sttName,
                    sector: sector,
                    email: data.email,
                    retardSites: data.sitesEnRetard.length,
                    planifierSites: (data.sitesAPlanifier || []).length,
                    totalSites: data.sitesEnRetard.length + (data.sitesAPlanifier || []).length,
                    sites: data.sitesEnRetard,
                    sitesAPlanifier: data.sitesAPlanifier || []
                };
                
                // Ouvrir la modal
                VISITESMODULE.openModalSTT(key);
            } else {
                alert('Module Visites non initialisé');
            }
        }

        // ============================================
        // MODULE TRAVAUX - LOGIQUE COMPLÈTE
        // ============================================
        const TRAVAUX = {
            data: [],
            filtered: [],
            allHeaders: [],
            sortState: {},
            currentDetailIndex: -1,
            currentSttTab: 'aPlanifier',
            emailHistory: JSON.parse(localStorage.getItem('travaux_email_history') || '{}'),

            displayColumns: [4, 13, 70, 2, 11, 9, 35, 36, 38, 41, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 44, 45, 46, 49, 88, 89, 33, 28, 29, 52, 54, 76, 81, 83],

            ficheConfig: {
                'NUM CLIENT/DEVIS/TECH': { icon: '👤', cols: [[60, 2, 4], [13, 70]], grid: 2 },
                'CLIENT': { icon: '👤', cols: [[11, 9, 35, 36, 38, 41], [44, 45, 46, 49]], grid: 2 },
                'PLANNING': { icon: '📅', cols: [[88, 89, 33]], grid: 3 },
                'COUT': { icon: '💰', cols: [[14, 16, 18, 20, 22], [15, 17, 19, 21, 23, 24, 25]], grid: 2 },
                'SOUS TRAITANT': { icon: '🏢', cols: [[29, 52, 54]], grid: 3 },
                'CLIENT HCE': { icon: '🏠', cols: [[76, 81, 83]], grid: 3 },
                'INFO DEVIS': { icon: '📄', cols: [[64, 8, 26], [27, 51, 12, 57, 58, 59]], grid: 2 }
            },

            init() {
                if (APP.data.travaux.length === 0) {
                    document.getElementById('travauxEmptyState').style.display = 'block';
                    return;
                }
                document.getElementById('travauxEmptyState').style.display = 'none';
                
                // Les données sont déjà pré-traitées par processTravauxRow
                this.data = APP.data.travaux;
                this.allHeaders = APP.data.travauxHeaders || [];
                
                console.log('📋 TRAVAUX init:', this.data.length, 'lignes');
                
                this.populateFilters();
                this.applyFilters();
                this.setupEventListeners();
            },

            // Suppression de processData() car les données sont déjà traitées

            populateFilters() {
                const techSet = new Set();
                const anneeSet = new Set();
                
                this.data.forEach(row => {
                    if (row.tech_converted) techSet.add(row.tech_converted);
                    if (row.annee) anneeSet.add(row.annee);
                });
                
                // Tech filter
                const techFilter = document.getElementById('travauxTechFilter');
                techFilter.innerHTML = '<option value="TOUS">Tous les techniciens</option>';
                [...techSet].sort().forEach(t => {
                    techFilter.innerHTML += `<option value="${t}">${t}</option>`;
                });
                
                // Année filter
                const anneeFilter = document.getElementById('travauxAnneeFilter');
                anneeFilter.innerHTML = '<option value="TOUS">Toutes</option>';
                [...anneeSet].sort().reverse().forEach(a => {
                    anneeFilter.innerHTML += `<option value="${a}">${a}</option>`;
                });
            },

            setupEventListeners() {
                ['travauxTechFilter', 'travauxRedacteurFilter', 'travauxSecteurFilter', 'travauxSttFilter', 'travauxAnneeFilter'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => this.applyFilters());
                });
            },

            applyFilters() {
                const tech = document.getElementById('travauxTechFilter').value;
                const redacteur = document.getElementById('travauxRedacteurFilter').value;
                const secteur = document.getElementById('travauxSecteurFilter').value;
                const stt = document.getElementById('travauxSttFilter').value;
                const annee = document.getElementById('travauxAnneeFilter').value;
                
                this.filtered = this.data.filter(row => {
                    if (tech !== 'TOUS' && row.tech_converted !== tech) return false;
                    if (redacteur !== 'TOUS' && row.redacteur_converted !== redacteur) return false;
                    if (secteur !== 'TOUS' && row.secteur !== secteur) return false;
                    if (stt === 'AVEC' && !row.has_stt) return false;
                    if (stt === 'SANS' && row.has_stt) return false;
                    if (stt.startsWith('STT_') && row.stt_converted !== stt.substring(4)) return false;
                    if (annee !== 'TOUS' && row.annee !== annee) return false;
                    return true;
                });
                
                this.updateDynamicFilters();
                this.updateStats();
                this.renderTable();
                this.updateButtons();
            },

            updateDynamicFilters() {
                // Rédacteur dynamique
                const redacteurCounts = {};
                const sttCounts = {};
                
                this.filtered.forEach(row => {
                    if (row.redacteur_converted) {
                        redacteurCounts[row.redacteur_converted] = (redacteurCounts[row.redacteur_converted] || 0) + 1;
                    }
                    if (row.has_stt && row.stt_converted) {
                        sttCounts[row.stt_converted] = (sttCounts[row.stt_converted] || 0) + 1;
                    }
                });
                
                const currentRedacteur = document.getElementById('travauxRedacteurFilter').value;
                const redacteurFilter = document.getElementById('travauxRedacteurFilter');
                redacteurFilter.innerHTML = '<option value="TOUS">Tous les rédacteurs</option>';
                Object.entries(redacteurCounts).sort((a, b) => b[1] - a[1]).forEach(([r, c]) => {
                    redacteurFilter.innerHTML += `<option value="${r}">${r} (${c})</option>`;
                });
                if ([...redacteurFilter.options].some(o => o.value === currentRedacteur)) {
                    redacteurFilter.value = currentRedacteur;
                }
                
                const currentStt = document.getElementById('travauxSttFilter').value;
                const sttFilter = document.getElementById('travauxSttFilter');
                sttFilter.innerHTML = '<option value="TOUS">Tous</option><option value="AVEC">Avec STT</option><option value="SANS">Sans STT</option>';
                Object.entries(sttCounts).sort((a, b) => b[1] - a[1]).forEach(([s, c]) => {
                    sttFilter.innerHTML += `<option value="STT_${s}">${s} (${c})</option>`;
                });
                if ([...sttFilter.options].some(o => o.value === currentStt)) {
                    sttFilter.value = currentStt;
                }
            },

            updateStats() {
                const totalCA = this.filtered.reduce((sum, r) => sum + (r.ca || 0), 0);
                const el1 = document.getElementById('travauxCA');
                if (el1) el1.textContent = formatCurrency(totalCA);
                
                const el2 = document.getElementById('travauxNbSecteur');
                if (el2) el2.textContent = this.filtered.length;
                
                const el3 = document.getElementById('travauxNbTech');
                if (el3) el3.textContent = this.filtered.length;
                
                const nbStt = this.filtered.filter(r => r.has_stt).length;
                const el4 = document.getElementById('travauxNbStt');
                if (el4) el4.textContent = nbStt;
                
                const budgetStt = this.filtered.filter(r => r.has_stt).reduce((sum, r) => sum + (r.budget_stt || 0), 0);
                const el5 = document.getElementById('travauxBudgetStt');
                if (el5) el5.textContent = formatCurrency(budgetStt);
                
                // Update dashboard
                const el6 = document.getElementById('kpiTravaux');
                if (el6) el6.textContent = this.data.length;
                
                const el7 = document.getElementById('badge-travaux');
                if (el7) el7.textContent = this.data.length;
                
                const dashCA = this.data.reduce((sum, r) => sum + (r.ca || 0), 0);
                const el8 = document.getElementById('kpiCa');
                if (el8) el8.textContent = formatCurrency(dashCA);
            },

            updateButtons() {
                const redacteurFilter = document.getElementById('travauxRedacteurFilter');
                const redacteur = redacteurFilter ? redacteurFilter.value : 'TOUS';
                const btnRedacteur = document.getElementById('btnEmailRedacteur');
                if (btnRedacteur) btnRedacteur.style.display = redacteur !== 'TOUS' ? 'flex' : 'none';
                
                const nbStt = this.filtered.filter(r => r.has_stt).length;
                const btnStt = document.getElementById('btnEmailSttList');
                if (btnStt) btnStt.style.display = nbStt > 0 ? 'flex' : 'none';
            },

            renderTable() {
                const thead = document.getElementById('travauxTableHead');
                const tbody = document.getElementById('travauxTableBody');
                
                if (!thead || !tbody) return;
                
                // Colonnes affichées (simplifiées)
                const cols = [
                    { idx: 0, label: 'N° Client' },
                    { idx: 2, label: 'N° Devis' },
                    { idx: 'tech', label: 'Technicien' },
                    { idx: 'redacteur', label: 'Rédacteur' },
                    { idx: 9, label: 'Nom Site' },
                    { idx: 34, label: 'Ville' },
                    { idx: 'secteur', label: 'Secteur' },
                    { idx: 'stt', label: 'STT' },
                    { idx: 'ca', label: 'Montant HT' }
                ];
                
                // Header
                thead.innerHTML = `<tr>${cols.map(c => 
                    `<th onclick="TRAVAUX.sortBy('${c.idx}')">${c.label} <span class="sort-icon">⬍</span></th>`
                ).join('')}</tr>`;
                
                // Body
                tbody.innerHTML = '';
                const countEl = document.getElementById('travauxCount');
                if (countEl) countEl.textContent = `${this.filtered.length} travaux`;
                
                this.filtered.forEach((row, idx) => {
                    const tr = document.createElement('tr');
                    if (row.has_stt) tr.classList.add('has-stt');
                    tr.onclick = () => this.showDetail(idx);
                    
                    cols.forEach(c => {
                        const td = document.createElement('td');
                        let val = '';
                        if (c.idx === 'tech') val = row.tech_converted;
                        else if (c.idx === 'redacteur') val = row.redacteur_converted;
                        else if (c.idx === 'secteur') val = row.secteur;
                        else if (c.idx === 'stt') val = row.stt_converted;
                        else if (c.idx === 'ca') val = formatCurrency(row.ca);
                        else val = row[c.idx] || '';
                        td.textContent = val;
                        tr.appendChild(td);
                    });
                    
                    tbody.appendChild(tr);
                });
            },

            sortBy(key) {
                const dir = this.sortState[key] === 'asc' ? 'desc' : 'asc';
                this.sortState = { [key]: dir };
                
                this.filtered.sort((a, b) => {
                    let va, vb;
                    if (key === 'tech') { va = a.tech_converted; vb = b.tech_converted; }
                    else if (key === 'redacteur') { va = a.redacteur_converted; vb = b.redacteur_converted; }
                    else if (key === 'secteur') { va = a.secteur; vb = b.secteur; }
                    else if (key === 'stt') { va = a.stt_converted; vb = b.stt_converted; }
                    else if (key === 'ca') { va = a.ca; vb = b.ca; }
                    else { va = a[key]; vb = b[key]; }
                    
                    if (typeof va === 'number') {
                        return dir === 'asc' ? va - vb : vb - va;
                    }
                    return dir === 'asc' ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
                });
                
                this.renderTable();
            },

            showDetail(idx) {
                this.currentDetailIndex = idx;
                const row = this.filtered[idx];
                const modal = document.getElementById('travauxDetailModal');
                const content = document.getElementById('travauxDetailContent');
                
                if (!modal || !content) return;
                
                // Nav
                const navCounter = document.getElementById('travauxNavCounter');
                if (navCounter) navCounter.textContent = `${idx + 1} / ${this.filtered.length}`;
                
                const prevBtn = document.getElementById('travauxPrevBtn');
                if (prevBtn) prevBtn.disabled = idx === 0;
                
                const nextBtn = document.getElementById('travauxNextBtn');
                if (nextBtn) nextBtn.disabled = idx === this.filtered.length - 1;
                
                // Email STT button
                const emailBtn = document.getElementById('travauxEmailSttBtn');
                if (emailBtn) emailBtn.style.display = row.has_stt ? 'flex' : 'none';
                
                // Content
                let html = '';
                Object.entries(this.ficheConfig).forEach(([section, config]) => {
                    html += `<div class="detail-section">
                        <div class="detail-section-title">${config.icon} ${section}</div>
                        <div class="detail-section-content${config.grid === 3 ? ' cols-3' : ''}">`;
                    
                    config.cols.forEach(colGroup => {
                        colGroup.forEach(colIdx => {
                            const arrayIdx = colIdx - 1;
                            const label = this.allHeaders[arrayIdx] || `Col ${colIdx}`;
                            let value = row[arrayIdx] || '';
                            
                            if (colIdx === 70) value = row.tech_converted;
                            if (colIdx === 13) value = row.redacteur_converted;
                            if (colIdx === 29) value = row.stt_converted;
                            if (colIdx === 25) value = formatCurrency(row.ca);
                            
                            html += `<div class="detail-item">
                                <div class="item-label">${label}</div>
                                <div class="item-value">${value || '-'}</div>
                            </div>`;
                        });
                    });
                    
                    html += `</div></div>`;
                });
                
                content.innerHTML = html;
                modal.classList.add('active');
            },

            closeDetail() {
                const modal = document.getElementById('travauxDetailModal');
                if (modal) modal.classList.remove('active');
            },

            navigate(dir) {
                const newIdx = this.currentDetailIndex + dir;
                if (newIdx >= 0 && newIdx < this.filtered.length) {
                    this.showDetail(newIdx);
                }
            },

            sendEmailSttSingle() {
                if (this.currentDetailIndex < 0) return;
                const row = this.filtered[this.currentDetailIndex];
                this.sendSttEmail([row]);
            },

            openSttModal() {
                const modal = document.getElementById('travauxSttModal');
                if (modal) modal.classList.add('active');
                this.currentSttTab = 'aPlanifier';
                this.renderSttTab();
            },

            closeSttModal() {
                const modal = document.getElementById('travauxSttModal');
                if (modal) modal.classList.remove('active');
            },

            switchSttTab(tab) {
                this.currentSttTab = tab;
                document.querySelectorAll('.stt-tab-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.tab === tab);
                });
                this.renderSttTab();
            },

            renderSttTab() {
                const container = document.getElementById('travauxSttContent');
                if (!container) return;
                
                const sttRows = this.filtered.filter(r => r.has_stt);
                const rows = this.currentSttTab === 'aPlanifier' 
                    ? sttRows.filter(r => !r.is_planified)
                    : sttRows.filter(r => r.is_planified);
                
                if (rows.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 60px; color: var(--text-muted);">Aucun travail dans cette catégorie</p>';
                    return;
                }
                
                let html = `
                    <div class="select-all-row">
                        <input type="checkbox" id="selectAllStt" checked onchange="TRAVAUX.toggleAllCheckboxes()">
                        <label for="selectAllStt">Tout sélectionner</label>
                        <span>(${rows.length} travaux)</span>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="stt-list-table">
                            <thead>
                                <tr>
                                    <th class="checkbox-cell">✓</th>
                                    <th>Historique</th>
                                    <th>N° Travaux</th>
                                    <th>Nom Site</th>
                                    <th>Ville</th>
                                    <th>STT</th>
                                    <th>PL STT</th>
                                    <th>Budget</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                rows.forEach((row, i) => {
                    const history = this.emailHistory[row.uniqueKey] || [];
                    const historyStr = history.slice(-2).map(d => new Date(d).toLocaleDateString('fr-FR')).join('<br>') || '-';
                    const numTravaux = `${row[0] || ''}TX${row[2] || ''}`;
                    const plStt = row.pl_stt || '-';
                    
                    html += `
                        <tr>
                            <td class="checkbox-cell"><input type="checkbox" class="stt-cb" data-idx="${this.filtered.indexOf(row)}" checked></td>
                            <td class="history-cell">${historyStr}</td>
                            <td><strong>${numTravaux}</strong></td>
                            <td>${row[9] || ''}</td>
                            <td>${row[34] || ''}</td>
                            <td>${row.stt_converted}</td>
                            <td>${plStt}</td>
                            <td>${formatCurrency(row.budget_stt)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },

            toggleAllCheckboxes() {
                const checked = document.getElementById('selectAllStt').checked;
                document.querySelectorAll('.stt-cb').forEach(cb => cb.checked = checked);
            },

            sendSelectedSttEmails() {
                const selected = [...document.querySelectorAll('.stt-cb:checked')];
                if (selected.length === 0) {
                    alert('Veuillez sélectionner au moins un travail.');
                    return;
                }
                
                const rows = selected.map(cb => this.filtered[parseInt(cb.dataset.idx)]);
                
                // Grouper par STT
                const grouped = {};
                rows.forEach(r => {
                    if (!grouped[r.stt_converted]) grouped[r.stt_converted] = [];
                    grouped[r.stt_converted].push(r);
                });
                
                Object.values(grouped).forEach(sttRows => {
                    this.sendSttEmail(sttRows);
                });
            },

            sendSttEmail(rows) {
                if (rows.length === 0) return;
                
                const first = rows[0];
                const email = first.stt_email || '';
                const nomStt = first.stt_converted || 'Sous-traitant';
                
                let body = `Bonjour ${nomStt},\n\n`;
                body += this.currentSttTab === 'aPlanifier'
                    ? 'Merci de nous communiquer vos dates de disponibilité pour les travaux suivants :\n\n'
                    : 'Rappel concernant les travaux planifiés suivants :\n\n';
                
                rows.forEach(r => {
                    body += `- ${r[0] || ''} TX ${r[2] || ''} | ${r[9] || ''} | ${r[34] || ''}\n`;
                    body += `  Budget: ${formatCurrency(r.budget_stt)}\n\n`;
                    
                    // Sauvegarder historique
                    if (!this.emailHistory[r.uniqueKey]) this.emailHistory[r.uniqueKey] = [];
                    this.emailHistory[r.uniqueKey].unshift(new Date().toISOString());
                    if (this.emailHistory[r.uniqueKey].length > 2) this.emailHistory[r.uniqueKey].pop();
                });
                
                localStorage.setItem('travaux_email_history', JSON.stringify(this.emailHistory));
                
                body += '\nCordialement';
                
                window.location.href = `mailto:${email}?subject=Travaux à planifier - ${nomStt}&body=${encodeURIComponent(body)}`;
            },

            sendEmailRedacteur() {
                const redacteur = document.getElementById('travauxRedacteurFilter').value;
                if (redacteur === 'TOUS' || this.filtered.length === 0) return;
                
                const email = this.filtered[0].redacteur_email || '';
                if (!email) { alert('Email non trouvé.'); return; }
                
                let body = `Salut ${redacteur},\n\nDevis et travaux maintenance à planifier :\n\n`;
                
                this.filtered.forEach(r => {
                    body += `- ${r[0] || ''} TX ${r[2] || ''} | ${r[9] || ''} | ${r[34] || ''}\n`;
                });
                
                window.location.href = `mailto:${email}?subject=Suivi Travaux ${redacteur}&body=${encodeURIComponent(body)}`;
            },

            // Modals Stats
            openModalCA() {
                const byTech = {};
                this.filtered.forEach(r => {
                    const t = r.tech_converted || 'Non défini';
                    if (!byTech[t]) byTech[t] = { count: 0, ca: 0 };
                    byTech[t].count++;
                    byTech[t].ca += r.ca;
                });
                
                this.showStatsModal('💰 Détail Chiffre d\'Affaires', byTech, 'ca');
            },

            openModalSecteur() {
                const bySecteur = {};
                this.filtered.forEach(r => {
                    const s = r.secteur;
                    if (!bySecteur[s]) bySecteur[s] = { count: 0, ca: 0 };
                    bySecteur[s].count++;
                    bySecteur[s].ca += r.ca;
                });
                
                this.showStatsModal('📊 Détail par Secteur', bySecteur, 'count');
            },

            openModalTechnicien() {
                const byTech = {};
                this.filtered.forEach(r => {
                    const t = r.tech_converted || 'Non défini';
                    if (!byTech[t]) byTech[t] = { count: 0, ca: 0 };
                    byTech[t].count++;
                    byTech[t].ca += r.ca;
                });
                
                this.showStatsModal('👷 Détail par Technicien', byTech, 'count');
            },

            openModalStatsStt() {
                const byStt = {};
                this.filtered.filter(r => r.has_stt).forEach(r => {
                    const s = r.stt_converted || 'Non défini';
                    if (!byStt[s]) byStt[s] = { count: 0, ca: 0, budget: 0 };
                    byStt[s].count++;
                    byStt[s].ca += r.ca;
                    byStt[s].budget += r.budget_stt;
                });
                
                this.showStatsModal('🏢 Statistiques Sous-traitants', byStt, 'count');
            },

            openModalBudgetStt() {
                const byStt = {};
                this.filtered.filter(r => r.has_stt).forEach(r => {
                    const s = r.stt_converted || 'Non défini';
                    if (!byStt[s]) byStt[s] = { count: 0, budget: 0 };
                    byStt[s].count++;
                    byStt[s].budget += r.budget_stt || 0;
                });
                
                let html = '<div class="stats-grid-modal">';
                let totalBudget = 0;
                
                Object.entries(byStt).sort((a, b) => b[1].budget - a[1].budget).forEach(([name, data]) => {
                    totalBudget += data.budget;
                    html += `<div class="stats-row">
                        <span class="stats-name">${name}</span>
                        <span class="stats-count">${data.count} travaux</span>
                        <span class="stats-value">${formatCurrency(data.budget)}</span>
                    </div>`;
                });
                
                html += '</div>';
                
                const titleEl = document.getElementById('travauxStatsModalTitle');
                if (titleEl) titleEl.textContent = '💰 Détail Budget Sous-traitants';
                
                const contentEl = document.getElementById('travauxStatsContent');
                if (contentEl) contentEl.innerHTML = html;
                
                const totalEl = document.getElementById('travauxStatsTotal');
                if (totalEl) {
                    totalEl.innerHTML = `
                        <div class="total-label">💰 Total Budget STT</div>
                        <div class="total-value">${formatCurrency(totalBudget)}</div>
                    `;
                    totalEl.style.background = 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)';
                }
                
                const modal = document.getElementById('travauxStatsModal');
                if (modal) modal.classList.add('active');
            },

            showStatsModal(title, data, mainField) {
                let html = '<div class="stats-grid-modal">';
                let total = 0;
                let totalCA = 0;
                
                Object.entries(data).sort((a, b) => b[1][mainField] - a[1][mainField]).forEach(([name, d]) => {
                    total += d.count;
                    totalCA += d.ca || 0;
                    html += `<div class="stats-row">
                        <span class="stats-name">${name}</span>
                        <span class="stats-count">${d.count} travaux</span>
                        <span class="stats-value">${formatCurrency(d.ca || 0)}</span>
                    </div>`;
                });
                
                html += '</div>';
                
                const titleEl = document.getElementById('travauxStatsModalTitle');
                if (titleEl) titleEl.textContent = title;
                
                const contentEl = document.getElementById('travauxStatsContent');
                if (contentEl) contentEl.innerHTML = html;
                
                const totalEl = document.getElementById('travauxStatsTotal');
                if (totalEl) {
                    totalEl.innerHTML = `
                        <div class="total-label">${mainField === 'ca' ? '💰 Total CA' : '📊 Total'}</div>
                        <div class="total-value">${mainField === 'ca' ? formatCurrency(totalCA) : total + ' travaux'}</div>
                    `;
                    totalEl.style.background = '';
                }
                
                const modal = document.getElementById('travauxStatsModal');
                if (modal) modal.classList.add('active');
            },

            closeStatsModal() {
                const modal = document.getElementById('travauxStatsModal');
                if (modal) modal.classList.remove('active');
            }
        };


        // ============================================
        // MODULE DEVIS - CODE EXACT DU FICHIER ORIGINAL
        // ============================================
        
        // Variables globales IDENTIQUES au fichier DEVIS.html
        let devisData = [];
        let devisColumnHeaders = [];
        let devisSsiData = [];
        let devisTechData = [];
        let devisSttData = [];
        let devisCurrentResults = [];
        let devisSearchTimeout;
        let devisCurrentIndex = 0;

        // Fonction pour initialiser depuis APP.data (remplace handleFile)
        // CODE IDENTIQUE à handleFile - juste source différente
        function initDevisFromAppData() {
            if (!APP.data.devis || APP.data.devis.length === 0) {
                console.log('⚠️ Pas de données DEVIS');
                return;
            }

            // EXACTEMENT comme handleFile ligne 295:
            // columnHeaders = jsonData[0];
            devisColumnHeaders = APP.data.devisHeaders || [];

            // EXACTEMENT comme handleFile lignes 296-306:
            // devisData = jsonData.slice(1).map(row => {
            //     let obj = {};
            //     columnHeaders.forEach((header, index) => {
            //         let value = row[index];
            //         if (header && (header.toLowerCase().includes('date') || header === 'Date')) {
            //             value = excelDateToJSDate(value);
            //         }
            //         obj[header] = value !== undefined && value !== null && value !== '' ? value : null;
            //     });
            //     return obj;
            // }).filter(row => Object.values(row).some(val => val !== null && val !== ''));
            
            devisData = APP.data.devis.map(row => {
                const rawRow = row._raw || [];
                let obj = {};
                devisColumnHeaders.forEach((header, index) => {
                    let value = rawRow[index];
                    if (header && (header.toLowerCase().includes('date') || header === 'Date')) {
                        value = devisExcelDateToJSDate(value);
                    }
                    obj[header] = value !== undefined && value !== null && value !== '' ? value : null;
                });
                return obj;
            }).filter(row => Object.values(row).some(val => val !== null && val !== ''));

            // EXACTEMENT comme handleFile lignes 309-316:
            // ssiData = ssiJsonData.slice(1).filter(...)
            devisSsiData = (APP.data.ssi || []).map(row => row._raw || []);

            // EXACTEMENT comme handleFile lignes 319-326:
            // techData = techJsonData.slice(1).filter(...)
            devisTechData = APP.data.techRaw || [];
            // Fallback sur APP.tables.tech si APP.data.techRaw n'existe pas
            if (devisTechData.length === 0 && APP.tables && APP.tables.tech) {
                devisTechData = [];
                APP.tables.tech.forEach((info, code) => {
                    devisTechData.push([code, info.value || '']);
                });
            }

            // EXACTEMENT comme handleFile lignes 329-336:
            // sttData = sttJsonData.slice(1).filter(...)
            devisSttData = APP.data.sttRaw || [];
            // Fallback sur APP.tables.stt si APP.data.sttRaw n'existe pas
            if (devisSttData.length === 0 && APP.tables && APP.tables.stt) {
                devisSttData = [];
                APP.tables.stt.forEach((info, code) => {
                    devisSttData.push([code, info.value || '']);
                });
            }

            // EXACTEMENT comme handleFile lignes 340-342:
            // updateSttDropdown();
            // updateSynthese();
            // performSearch();
            devisCurrentResults = devisData;
            devisUpdateSttDropdown();
            devisUpdateSynthese();
            devisPerformSearch();

            console.log('📄 DEVIS initialisé:', devisData.length, 'devis');
        }

        // FONCTIONS EXACTES DU FICHIER DEVIS.html (avec préfixe devis pour éviter conflits)

        function devisExcelDateToJSDate(excelDate) {
            if (!excelDate) return '';
            if (typeof excelDate === 'string') return excelDate;
            if (typeof excelDate === 'number') {
                const date = new Date((excelDate - 25569) * 86400 * 1000);
                return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
            }
            return excelDate;
        }

        function devisDebounceSearch() {
            clearTimeout(devisSearchTimeout);
            devisSearchTimeout = setTimeout(devisPerformSearch, 300);
        }

        function devisGetTechnicienName(codeKey) {
            if (!codeKey || !devisTechData || devisTechData.length === 0) return '';
            const codeStr = String(codeKey).trim().toUpperCase();
            for (let i = 0; i < devisTechData.length; i++) {
                const techCode = String(devisTechData[i][0] || '').trim().toUpperCase();
                if (techCode === codeStr) {
                    return devisTechData[i][1] || '';
                }
            }
            return '';
        }

        function devisGetSiteNameFromSSI(clientNumber) {
            if (!clientNumber || !devisSsiData || devisSsiData.length === 0) return '';
            const clientStr = String(clientNumber).trim();
            for (let i = 0; i < devisSsiData.length; i++) {
                const ssiClientNumber = String(devisSsiData[i][0] || '').trim();
                if (ssiClientNumber === clientStr) {
                    return devisSsiData[i][5] || '';
                }
            }
            return '';
        }

        function devisGetSttNameFromCode(sttCode) {
            if (!sttCode || !devisSttData || devisSttData.length === 0) return '';
            const codeStr = String(sttCode).trim().toUpperCase();
            for (let i = 0; i < devisSttData.length; i++) {
                const dataCode = String(devisSttData[i][0] || '').trim().toUpperCase();
                if (dataCode === codeStr) {
                    return devisSttData[i][1] || '';
                }
            }
            return '';
        }

        function devisUpdateSttDropdown() {
            const select = document.getElementById('devisSttSelect');
            if (!select) return;
            select.innerHTML = '<option value="">Sélectionnez un STT...</option>';
            
            // Compter les interventions par Nom STT converti (colonne AB = index 27)
            const sttCounts = {};
            devisCurrentResults.forEach(devis => {
                const sttCode = String(devis[devisColumnHeaders[27]] || '').trim();
                if (sttCode) {
                    const nomStt = devisGetSttNameFromCode(sttCode) || sttCode;
                    sttCounts[nomStt] = (sttCounts[nomStt] || 0) + 1;
                }
            });

            // Trier par nombre décroissant
            const sortedSttNames = Object.keys(sttCounts).sort((a, b) => sttCounts[b] - sttCounts[a]);
            sortedSttNames.forEach(nomStt => {
                const count = sttCounts[nomStt];
                const option = document.createElement('option');
                option.value = nomStt;
                option.textContent = `${nomStt} (${count})`;
                select.appendChild(option);
            });

            devisUpdateSttSummary();
        }

        function devisUpdateSttSummary() {
            let totalBudget = 0;
            const uniqueStt = new Set();
            const budgetByYear = {};

            devisCurrentResults.forEach(devis => {
                const sttCode = String(devis[devisColumnHeaders[27]] || '').trim();
                if (sttCode) {
                    const nomStt = devisGetSttNameFromCode(sttCode) || sttCode;
                    uniqueStt.add(nomStt);
                    const budgetBA = parseFloat(devis[devisColumnHeaders[52]]) || 0;
                    totalBudget += budgetBA;

                    const dateStr = devis['Date'];
                    let year = 'N/A';
                    if (dateStr) {
                        const dateMatch = String(dateStr).match(/(\d{4})/);
                        if (dateMatch) year = dateMatch[1];
                    }

                    if (!budgetByYear[year]) {
                        budgetByYear[year] = 0;
                    }
                    budgetByYear[year] += budgetBA;
                }
            });

            const totalEl = document.getElementById('devisTotalBudgetSTT');
            if (totalEl) totalEl.textContent = totalBudget.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' €';
            
            const countEl = document.getElementById('devisCountSTT');
            if (countEl) countEl.textContent = uniqueStt.size;

            const budgetParAnneeDiv = document.getElementById('devisBudgetParAnneeSTT');
            const sortedYears = Object.keys(budgetByYear).sort((a, b) => b.localeCompare(a));

            if (budgetParAnneeDiv) {
                if (sortedYears.length === 0) {
                    budgetParAnneeDiv.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); font-size: 12px;">Aucune donnée</div>';
                } else {
                    budgetParAnneeDiv.innerHTML = sortedYears.map(year => {
                        const budget = budgetByYear[year];
                        return `<div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.1); padding: 6px 10px; border-radius: 4px;">
                            <span style="font-weight: 700; font-size: 14px;">${year}</span>
                            <span style="font-weight: 600; font-size: 14px;">${budget.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} €</span>
                        </div>`;
                    }).join('');
                }
            }
        }

        function devisUpdateSttBudget() {
            const select = document.getElementById('devisSttSelect');
            const sttContent = document.getElementById('devisSttContent');
            if (!select || !sttContent) return;
            
            const selectedName = select.value;

            if (!selectedName) {
                sttContent.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px; font-size: 14px;">Sélectionnez un STT</div>';
                return;
            }

            const sttBudgetByYear = {};

            devisCurrentResults.forEach(devis => {
                const sttCode = String(devis[devisColumnHeaders[27]] || '').trim();
                const nomStt = devisGetSttNameFromCode(sttCode) || sttCode;
                if (nomStt === selectedName) {
                    const dateStr = devis['Date'];
                    let year = 'N/A';
                    if (dateStr) {
                        const dateMatch = String(dateStr).match(/(\d{4})/);
                        if (dateMatch) year = dateMatch[1];
                    }

                    if (!sttBudgetByYear[year]) {
                        sttBudgetByYear[year] = 0;
                    }

                    const budgetBA = parseFloat(devis[devisColumnHeaders[52]]) || 0;
                    sttBudgetByYear[year] += budgetBA;
                }
            });

            const sortedYears = Object.keys(sttBudgetByYear).sort((a, b) => b.localeCompare(a));

            if (sortedYears.length === 0) {
                sttContent.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px; font-size: 14px;">Aucune donnée pour ce STT</div>';
                return;
            }

            sttContent.innerHTML = sortedYears.map(year => {
                const budget = sttBudgetByYear[year];
                return `<div class="stt-item" style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                    <div class="stt-label" style="font-size: 12px; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">Année ${year}</div>
                    <div class="stt-value" style="font-size: 24px; font-weight: 700;">${budget.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} €</div>
                </div>`;
            }).join('');
        }

        function devisUpdateSynthese(dataToAnalyze) {
            dataToAnalyze = dataToAnalyze || devisData;
            const syntheseContent = document.getElementById('devisSyntheseContent');
            if (!syntheseContent) return;
            
            const syntheseByYear = {};

            dataToAnalyze.forEach(devis => {
                const dateStr = devis['Date'];
                let year = 'N/A';
                if (dateStr) {
                    const dateMatch = String(dateStr).match(/(\d{4})/);
                    if (dateMatch) year = dateMatch[1];
                }

                if (!syntheseByYear[year]) {
                    syntheseByYear[year] = { countBcOk: 0, countNonSigne: 0, totalBcOk: 0, totalNonSigne: 0 };
                }

                const hasBonCommande = devis['Bon de commande'] && String(devis['Bon de commande']).trim() !== '';
                const expr1 = parseFloat(devis['Expr1']) || 0;

                if (hasBonCommande) {
                    syntheseByYear[year].countBcOk++;
                    syntheseByYear[year].totalBcOk += expr1;
                } else {
                    syntheseByYear[year].countNonSigne++;
                    syntheseByYear[year].totalNonSigne += expr1;
                }
            });

            const sortedYears = Object.keys(syntheseByYear).sort((a, b) => b.localeCompare(a));

            if (sortedYears.length === 0) {
                syntheseContent.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Aucun devis trouvé</div>';
                return;
            }

            syntheseContent.innerHTML = sortedYears.map(year => {
                const data = syntheseByYear[year];
                return `<div class="synthese-item" style="background: rgba(255, 255, 255, 0.2); padding: 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div class="synthese-year" style="font-weight: 700; font-size: 20px;">${year}</div>
                    <div class="synthese-details" style="text-align: right; font-size: 14px;">
                        <div class="synthese-bc-ok" style="color: #000000; font-weight: 700; font-size: 14px; margin-bottom: 3px;">BC OK: ${data.countBcOk} (${data.totalBcOk.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} €)</div>
                        <div class="synthese-non-signe" style="color: #ffffff; font-weight: 700; font-size: 14px;">Non sig.: ${data.countNonSigne} (${data.totalNonSigne.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} €)</div>
                    </div>
                </div>`;
            }).join('');
        }

        function devisResetContratInfo() {
            const valeurEl = document.getElementById('devisValeurContrat');
            const tauxEl = document.getElementById('devisTauxHoraire');
            const pctEl = document.getElementById('devisPourcentageTaux');
            if (valeurEl) valeurEl.textContent = '-- €';
            if (tauxEl) tauxEl.textContent = '-- €';
            if (pctEl) pctEl.textContent = '--% du contrat';
        }

        function devisUpdateContratInfo(filteredDevis) {
            filteredDevis = filteredDevis || [];
            if (filteredDevis.length === 0 || devisSsiData.length === 0) {
                devisResetContratInfo();
                return;
            }

            const clientNumbers = filteredDevis.map(devis => String(devis[devisColumnHeaders[0]] || '').trim()).filter(Boolean);
            if (clientNumbers.length === 0) {
                devisResetContratInfo();
                return;
            }

            let ssiRow = null;
            for (let i = 0; i < devisSsiData.length; i++) {
                if (clientNumbers.includes(String(devisSsiData[i][0] || '').trim())) {
                    ssiRow = devisSsiData[i];
                    break;
                }
            }

            if (!ssiRow) {
                devisResetContratInfo();
                return;
            }

            function colToIndex(col) {
                let index = 0;
                for (let i = 0; i < col.length; i++) {
                    index = index * 26 + (col.charCodeAt(i) - 'A'.charCodeAt(0) + 1);
                }
                return index - 1;
            }

            const valeurContrat = parseFloat(ssiRow[colToIndex('DL')]) || 0;
            const valeurBH = parseFloat(ssiRow[colToIndex('BH')]) || 0;
            let valeurS = parseFloat(ssiRow[colToIndex('S')]) || 0;
            if (valeurS === 2) valeurS = 1.5;
            const valeurBI = parseFloat(ssiRow[colToIndex('BI')]) || 1;

            let tauxHoraire = 0;
            if (valeurBH !== 0 && valeurS !== 0 && valeurBI !== 0) {
                tauxHoraire = (valeurContrat / (valeurBH * valeurS)) / valeurBI;
            }

            let pourcentage = 0;
            if (valeurContrat !== 0) {
                pourcentage = (tauxHoraire / valeurContrat) * 100;
            }

            const valeurEl = document.getElementById('devisValeurContrat');
            const tauxEl = document.getElementById('devisTauxHoraire');
            const pctEl = document.getElementById('devisPourcentageTaux');
            
            if (valeurEl) valeurEl.textContent = valeurContrat.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' €';
            if (tauxEl) tauxEl.textContent = tauxHoraire.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' €';
            if (pctEl) pctEl.textContent = pourcentage.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '% du contrat';
        }

        function devisPerformSearch() {
            const searchClient = (document.getElementById('devisSearchClient')?.value || '').toLowerCase().trim();
            const searchDevis = (document.getElementById('devisSearchDevis')?.value || '').toLowerCase().trim();
            const searchRedacteur = (document.getElementById('devisSearchRedacteur')?.value || '').toLowerCase().trim();

            if (!searchClient && !searchDevis && !searchRedacteur) {
                const resultsSection = document.getElementById('devisResultsSection');
                if (resultsSection) resultsSection.style.display = 'none';
                devisUpdateSynthese(devisData);
                devisCurrentResults = devisData;
                devisUpdateSttDropdown();
                devisResetContratInfo();
                return;
            }

            let results = devisData.filter(devis => {
                const clientMatch = searchClient ? String(devis[devisColumnHeaders[0]] || '').toLowerCase().includes(searchClient) : true;
                const devisMatch = searchDevis ? String(devis['N° devis'] || '').toLowerCase().includes(searchDevis) : true;
                
                let redacteurMatch = true;
                if (searchRedacteur) {
                    const redacteurName = devisGetTechnicienName(devis[devisColumnHeaders[11]]);
                    redacteurMatch = redacteurName.toLowerCase().includes(searchRedacteur);
                }

                return clientMatch && devisMatch && redacteurMatch;
            });

            devisCurrentResults = results;
            devisUpdateSynthese(results);
            devisUpdateContratInfo(results);
            devisUpdateSttDropdown();
            devisDisplayResults(results);
        }

        function devisDisplayResults(results) {
            const resultsSection = document.getElementById('devisResultsSection');
            const devisList = document.getElementById('devisDevisList');
            const resultsCount = document.getElementById('devisResultsCount');

            if (!resultsSection || !devisList) return;

            resultsSection.style.display = 'block';
            if (resultsCount) resultsCount.textContent = `${results.length} devis trouvé${results.length > 1 ? 's' : ''}`;

            if (results.length === 0) {
                devisList.innerHTML = '<div class="no-results" style="text-align: center; padding: 40px; color: #999; font-size: 18px;">Aucun devis trouvé</div>';
                return;
            }

            const limitedResults = results.slice(0, 100);
            if (results.length > 100 && resultsCount) {
                resultsCount.textContent = `${results.length} devis trouvés (affichage des 100 premiers)`;
            }

            devisList.innerHTML = limitedResults.map((devis, index) => {
                const hasCommande = devis['Bon de commande'] && String(devis['Bon de commande']).trim() !== '';
                
                const redacteurCode = devis[devisColumnHeaders[11]];
                const redacteurName = devisGetTechnicienName(redacteurCode);
                
                const clientNumber = devis[devisColumnHeaders[0]];
                const nomSite = devisGetSiteNameFromSSI(clientNumber);
                
                const siteTechnicienCode = devisColumnHeaders[68] ? devis[devisColumnHeaders[68]] : null;
                const siteTechnicienName = devisGetTechnicienName(siteTechnicienCode);
                
                // Nom STT = conversion du code (colonne AB index 27) via feuille STT
                const nomStt = devisGetSttNameFromCode(devis[devisColumnHeaders[27]]);

                return `<div class="devis-card${hasCommande ? ' has-commande' : ''}" onclick="devisShowDetails(${index})" style="background: ${hasCommande ? '#fffde7' : '#f8f9ff'}; border: 2px solid ${hasCommande ? '#ffd54f' : '#e0e7ff'}; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s;">
                    <div class="devis-card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div class="devis-number" style="font-size: 20px; font-weight: 700; color: #667eea;">Devis #${devis['N° devis'] || ''}</div>
                        <div class="devis-date" style="color: #666; font-size: 16px; font-weight: 600;">${formatDateDDMMYYYY(devis['Date'])}</div>
                    </div>
                    <div class="devis-info" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <div class="info-item" style="font-size: 15px;"><span class="info-label" style="font-weight: 600; color: #555;">N° Client:</span><span class="info-value" style="color: #333; margin-left: 5px;">${devis[devisColumnHeaders[0]] || ''}</span></div>
                        <div class="info-item" style="font-size: 15px;"><span class="info-label" style="font-weight: 600; color: #555;">Nom Client:</span><span class="info-value" style="color: #333; margin-left: 5px;">${devis['Nom du client'] || ''}</span></div>
                        <div class="info-item" style="font-size: 15px;"><span class="info-label" style="font-weight: 600; color: #555;">Rédacteur:</span><span class="info-value" style="color: #333; margin-left: 5px;">${redacteurName || 'N/A'}</span></div>
                        <div class="info-item" style="font-size: 15px;"><span class="info-label" style="font-weight: 600; color: #555;">Nom du Site:</span><span class="info-value" style="color: #333; margin-left: 5px;">${nomSite || 'N/A'}</span></div>
                        <div class="info-item" style="font-size: 15px;"><span class="info-label" style="font-weight: 600; color: #555;">Site Technicien:</span><span class="info-value" style="color: #333; margin-left: 5px;">${siteTechnicienName || 'N/A'}</span></div>
                        <div class="info-item" style="font-size: 15px;"><span class="info-label" style="font-weight: 600; color: #555;">STT:</span><span class="info-value" style="color: #333; margin-left: 5px;">${nomStt || 'N/A'}</span></div>
                        <div class="info-item" style="font-size: 15px;"><span class="info-label" style="font-weight: 600; color: #555;">Objet:</span><span class="info-value" style="color: #333; margin-left: 5px;">${devis['Objet du devis'] || ''}</span></div>
                        <div class="info-item" style="font-size: 15px;"><span class="info-label" style="font-weight: 600; color: #555;">Ville:</span><span class="info-value" style="color: #333; margin-left: 5px;">${devis['Ville'] || ''}</span></div>
                        <div class="info-item" style="font-size: 15px;"><span class="info-label" style="font-weight: 600; color: #555;">Prix (Expr1):</span><span class="info-value" style="color: #333; margin-left: 5px;">${devis['Expr1'] ? parseFloat(devis['Expr1']).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' €' : ''}</span></div>
                    </div>
                </div>`;
            }).join('');
        }

        function devisShowDetails(index) {
            devisCurrentIndex = index;
            devisUpdateModal();
        }

        function devisNavigate(direction) {
            devisCurrentIndex += direction;
            if (devisCurrentIndex < 0) devisCurrentIndex = 0;
            if (devisCurrentIndex >= devisCurrentResults.length) devisCurrentIndex = devisCurrentResults.length - 1;
            devisUpdateModal();
        }

        function devisUpdateModal() {
            const devis = devisCurrentResults[devisCurrentIndex];
            const modal = document.getElementById('devisDetailModal');
            if (!modal || !devis) return;
            
            const redacteurCode = devis[devisColumnHeaders[11]];
            const redacteurName = devisGetTechnicienName(redacteurCode);
            
            const clientNumber = devis[devisColumnHeaders[0]];
            const nomSite = devisGetSiteNameFromSSI(clientNumber);
            
            const siteTechnicienCode = devisColumnHeaders[68] ? devis[devisColumnHeaders[68]] : null;
            const siteTechnicienName = devisGetTechnicienName(siteTechnicienCode);
            
            // Nom STT = conversion du code (colonne AB index 27) via feuille STT
            const nomStt = devisGetSttNameFromCode(devis[devisColumnHeaders[27]]);
            const budgetSTT = devis[devisColumnHeaders[52]] || '';

            document.getElementById('devisModalTitle').textContent = `Devis #${devis['N° devis'] || ''}`;
            document.getElementById('devisNavInfo').textContent = `${devisCurrentIndex + 1}/${devisCurrentResults.length}`;
            document.getElementById('devisPrevBtn').disabled = devisCurrentIndex === 0;
            document.getElementById('devisNextBtn').disabled = devisCurrentIndex === devisCurrentResults.length - 1;

            document.getElementById('devisModalBody').innerHTML = `
                <div class="detail-section" style="margin-bottom: 30px;">
                    <div class="section-title" style="font-size: 18px; font-weight: 700; color: #667eea; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;">Informations Générales du Devis</div>
                    <div class="detail-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Date</div>
                            <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${formatDateDDMMYYYY(devis['Date'])}</div>
                        </div>
                        <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">N° devis</div>
                            <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['N° devis'] || ''}</div>
                        </div>
                        <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Objet du devis</div>
                            <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Objet du devis'] || ''}</div>
                        </div>
                        <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Nom du client</div>
                            <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Nom du client'] || ''}</div>
                        </div>
                        <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Ville</div>
                            <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Ville'] || ''}</div>
                        </div>
                        <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Rédacteur</div>
                            <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${redacteurName || 'N/A'} (Code: ${redacteurCode || 'N/A'})</div>
                        </div>
                        <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Nom du Site</div>
                            <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${nomSite || 'N/A'}</div>
                        </div>
                        <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Site Technicien</div>
                            <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${siteTechnicienName || 'N/A'} (Code: ${siteTechnicienCode || 'N/A'})</div>
                        </div>
                    </div>
                </div>
                <div class="detail-section" style="margin-bottom: 30px;">
                    <div class="section-title" style="font-size: 18px; font-weight: 700; color: #667eea; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;">Suivi des Commandes</div>
                    <div class="detail-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Date retour commande</div>
                            <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${formatDateDDMMYYYY(devis['Date retour commande'])}</div>
                        </div>
                        <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Bon de commande</div>
                            <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Bon de commande'] || ''}</div>
                        </div>
                        <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Rapport inter 1</div>
                            <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Rapport inter 1'] || ''}</div>
                        </div>
                    </div>
                </div>
                <div class="detail-section" style="margin-bottom: 30px;">
                    <div class="section-title" style="font-size: 18px; font-weight: 700; color: #667eea; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;">STT</div>
                    <div class="detail-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Nom STT</div>
                            <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${nomStt || 'N/A'}</div>
                        </div>
                        <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Budget STT</div>
                            <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${budgetSTT}</div>
                        </div>
                    </div>
                </div>
                <div class="detail-section" style="margin-bottom: 30px;">
                    <div class="section-title" style="font-size: 18px; font-weight: 700; color: #667eea; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;">Pièces et Prix</div>
                    <div class="pieces-prix-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="pieces-column" style="display: flex; flex-direction: column; gap: 15px;">
                            <div class="column-header" style="font-size: 16px; font-weight: 700; color: #667eea; padding-bottom: 10px; border-bottom: 2px solid #e0e7ff; margin-bottom: 5px;">PIÈCES</div>
                            <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Pieces 1</div>
                                <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Pieces 1'] || ''}</div>
                            </div>
                            <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Pieces 2</div>
                                <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Pieces 2'] || ''}</div>
                            </div>
                            <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Pieces 3</div>
                                <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Pieces 3'] || ''}</div>
                            </div>
                            <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Pieces 4</div>
                                <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Pieces 4'] || ''}</div>
                            </div>
                            <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Pieces 5</div>
                                <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Pieces 5'] || ''}</div>
                            </div>
                            <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Forfait M/O</div>
                                <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Forfait M/O'] || ''}</div>
                            </div>
                        </div>
                        <div class="prix-column" style="display: flex; flex-direction: column; gap: 15px;">
                            <div class="column-header" style="font-size: 16px; font-weight: 700; color: #667eea; padding-bottom: 10px; border-bottom: 2px solid #e0e7ff; margin-bottom: 5px;">PRIX HT</div>
                            <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Prix ht 1</div>
                                <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Prix ht 1'] || ''}</div>
                            </div>
                            <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Prix ht 2</div>
                                <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Prix ht 2'] || ''}</div>
                            </div>
                            <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Prix ht 3</div>
                                <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Prix ht 3'] || ''}</div>
                            </div>
                            <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Prix ht 4</div>
                                <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Prix ht 4'] || ''}</div>
                            </div>
                            <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Prix ht 5</div>
                                <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Prix ht 5'] || ''}</div>
                            </div>
                            <div class="detail-item" style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div class="detail-label" style="font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px;">Expr1 (Total)</div>
                                <div class="detail-value" style="font-size: 17px; color: #333; font-weight: 500;">${devis['Expr1'] || ''}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function devisCloseModal() {
            const modal = document.getElementById('devisDetailModal');
            if (modal) modal.classList.remove('active');
        }

        // Objet DEVIS pour l'encapsulation (interface avec le reste de l'app)
        const DEVIS = {
            init() {
                // Ajouter les listeners
                document.getElementById('devisSearchClient')?.addEventListener('input', devisDebounceSearch);
                document.getElementById('devisSearchDevis')?.addEventListener('input', devisDebounceSearch);
                document.getElementById('devisSearchRedacteur')?.addEventListener('input', devisDebounceSearch);
                document.getElementById('devisSttSelect')?.addEventListener('change', devisUpdateSttBudget);
                
                // Initialiser depuis APP.data
                initDevisFromAppData();
            },
            navigate(dir) { devisNavigate(dir); },
            closeDetail() { devisCloseModal(); }
        };


        // ============================================
        // MODULE DSF TRACKER - LOGIQUE
        // ============================================
        const DSF = {
            cloture: [],
            planif: [],
            resp: [],
            currentTab: 'cloture',
            filtered: [],
            history: {},

            init() {
                this.loadHistory();
                this.processData();
                this.updateStats();
                this.renderTable();
                this.updateDashboard();
            },

            loadHistory() {
                try {
                    this.history = JSON.parse(localStorage.getItem('dsf_history') || '{}');
                } catch (e) {
                    this.history = {};
                }
            },

            saveHistory() {
                localStorage.setItem('dsf_history', JSON.stringify(this.history));
            },

            processData() {
                // DSF CLOTURE
                this.cloture = APP.data.dsfCloture.map((row, idx) => {
                    const values = Object.values(row);
                    return this.processRow(values, idx, 'cloture');
                });
                
                // DSF PLANIF
                this.planif = APP.data.dsfPlanif.map((row, idx) => {
                    const values = Object.values(row);
                    return this.processRow(values, idx, 'planif');
                });
                
                // DSF RESP
                this.resp = APP.data.dsfResp.map((row, idx) => {
                    const values = Object.values(row);
                    return this.processRow(values, idx, 'resp');
                });
            },

            processRow(values, idx, type) {
                const processed = { _raw: values, _index: idx, _type: type };
                
                values.forEach((val, i) => { processed[i] = val || ''; });
                
                // Secteur
                const secteurCode = String(values[35] || '').trim();
                const secteurInfo = APP.tables.tech.get(secteurCode);
                const secteurName = secteurInfo ? secteurInfo.value || secteurInfo.nom : secteurCode;
                
                let secteur = 'AUTRES';
                if (secteurName) {
                    const lastTwo = String(secteurName).slice(-2).toUpperCase();
                    if (lastTwo === 'S1') secteur = 'S1';
                    else if (lastTwo === 'S2') secteur = 'S2';
                    else if (lastTwo === 'S3') secteur = 'S3';
                }
                processed.secteur = secteur;
                
                // STT
                const sttCode = String(values[33] || '').trim();
                const sttInfo = APP.tables.stt.get(sttCode);
                processed.stt = sttInfo ? sttInfo.value : sttCode;
                
                // Infos site
                processed.numClient = values[0] || '';
                processed.nomSite = values[4] || '';
                processed.ville = values[6] || '';
                
                return processed;
            },

            updateStats() {
                const weekNum = APP.currentWeek.num;
                const weekEl = document.getElementById('dsfCurrentWeek');
                if (weekEl) weekEl.textContent = `S${weekNum}`;
                
                // Badges
                const badgeCloture = document.getElementById('dsfBadgeCloture');
                if (badgeCloture) badgeCloture.textContent = this.cloture.length;
                
                const badgePlanif = document.getElementById('dsfBadgePlanif');
                if (badgePlanif) badgePlanif.textContent = this.planif.length;
                
                const badgeResp = document.getElementById('dsfBadgeResp');
                if (badgeResp) badgeResp.textContent = this.resp.length;
                
                // Total
                const total = this.cloture.length + this.planif.length + this.resp.length;
                
                // Par secteur (basé sur l'onglet actuel)
                const data = this.getCurrentData();
                const s1 = data.filter(r => r.secteur === 'S1').length;
                const s2 = data.filter(r => r.secteur === 'S2').length;
                const s3 = data.filter(r => r.secteur === 'S3').length;
                
                // KPI Dashboard
                const kpiEl = document.getElementById('kpiDsf');
                if (kpiEl) kpiEl.textContent = total;
                
                const badgeEl = document.getElementById('badge-dsf');
                if (badgeEl) badgeEl.textContent = total;
                
                const alertEl = document.getElementById('alertDsfResp');
                if (alertEl) alertEl.textContent = this.resp.length;
            },

            getCurrentData() {
                if (this.currentTab === 'cloture') return this.cloture;
                if (this.currentTab === 'planif') return this.planif;
                return this.resp;
            },

            switchTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.dsf-tab-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.tab === tab);
                });
                this.applyFilter();
            },

            applyFilter() {
                const secteur = document.getElementById('dsfSectorFilterTable').value;
                let data = this.getCurrentData();
                
                if (secteur !== 'TOUS') {
                    data = data.filter(r => r.secteur === secteur);
                }
                
                this.filtered = data;
                this.renderTable();
            },

            renderTable() {
                const thead = document.getElementById('dsfTableHead');
                const tbody = document.getElementById('dsfTableBody');
                
                if (!thead || !tbody) return;
                
                const countEl = document.getElementById('dsfResultCount');
                if (countEl) countEl.textContent = `${this.filtered.length} éléments`;
                
                if (this.filtered.length === 0) {
                    const emptyEl = document.getElementById('dsfEmptyState');
                    if (emptyEl) emptyEl.style.display = 'block';
                    thead.innerHTML = '';
                    tbody.innerHTML = '';
                    return;
                }
                
                const emptyEl = document.getElementById('dsfEmptyState');
                if (emptyEl) emptyEl.style.display = 'none';
                
                thead.innerHTML = `<tr>
                    <th>N° Client</th>
                    <th>Nom Site</th>
                    <th>Ville</th>
                    <th>Secteur</th>
                    <th>STT</th>
                </tr>`;
                
                tbody.innerHTML = this.filtered.map((row, idx) => `
                    <tr onclick="DSF.showDetail(${idx})">
                        <td>${row.numClient}</td>
                        <td>${row.nomSite}</td>
                        <td>${row.ville}</td>
                        <td><span class="sector-badge ${row.secteur.toLowerCase()}">${row.secteur}</span></td>
                        <td>${row.stt || '-'}</td>
                    </tr>
                `).join('');
            },

            showDetail(idx) {
                const row = this.filtered[idx];
                const modal = document.getElementById('dsfDetailModal');
                if (!modal) return;
                
                const titleEl = document.getElementById('dsfModalTitle');
                if (titleEl) titleEl.textContent = `📈 DSF ${this.currentTab.toUpperCase()} - ${row.nomSite}`;
                
                let html = `<div class="detail-section">
                    <div class="detail-section-content">
                        <div class="detail-item"><div class="item-label">N° Client</div><div class="item-value">${row.numClient}</div></div>
                        <div class="detail-item"><div class="item-label">Nom Site</div><div class="item-value">${row.nomSite}</div></div>
                        <div class="detail-item"><div class="item-label">Ville</div><div class="item-value">${row.ville}</div></div>
                        <div class="detail-item"><div class="item-label">Secteur</div><div class="item-value">${row.secteur}</div></div>
                        <div class="detail-item"><div class="item-label">STT</div><div class="item-value">${row.stt || '-'}</div></div>
                    </div>
                </div>`;
                
                const contentEl = document.getElementById('dsfDetailContent');
                if (contentEl) contentEl.innerHTML = html;
                modal.classList.add('active');
            },

            closeDetail() {
                const modal = document.getElementById('dsfDetailModal');
                if (modal) modal.classList.remove('active');
            },

            archiveWeek() {
                const weekKey = APP.currentWeek.label;
                
                this.history[weekKey] = {
                    cloture: this.cloture.length,
                    planif: this.planif.length,
                    resp: this.resp.length,
                    date: new Date().toISOString()
                };
                
                this.saveHistory();
                alert(`✅ Semaine ${APP.currentWeek.num} archivée !`);
            },

            updateDashboard() {
                // Mise à jour des alertes DSF sur le dashboard principal
            }
        };

        // ============================================
        // MODULE SEARCH SSI - CODE EXACT DU FICHIER ssi_search_fixed__3_.html
        // ============================================
        
        // Variables globales EXACTES ligne 64-67
        let ssiAllData=[],ssiFilteredData=[],ssiTechMapping={},ssiSttMapping={},ssiFullDataRows=[],ssiCurrentSort={column:null,direction:null};
        let ssiActiveFilters={bpbt:false,bqbv:false};
        let ssiSelectedTechs=new Set();
        let ssiTechFilterOpen=false;

        // COPIE EXACTE ligne 69-79
        function ssiToggleTechFilter(e) {
            e.stopPropagation();
            ssiTechFilterOpen = !ssiTechFilterOpen;
            const dropdown = document.getElementById('ssiTechFilterDropdown');
            if (ssiTechFilterOpen) {
                dropdown.style.display = 'block';
                ssiUpdateTechCheckboxList();
            } else {
                dropdown.style.display = 'none';
            }
        }

        // COPIE EXACTE ligne 81-106
        function ssiUpdateTechCheckboxList() {
            const secteur = document.getElementById('ssiSearchSecteur').value.trim().toUpperCase();
            
            let techsToShow = new Set();
            ssiAllData.forEach(d => {
                if (!secteur || d.secteur === secteur) {
                    techsToShow.add(d.tech);
                }
            });
            
            const techArray = [...techsToShow].sort();
            const container = document.getElementById('ssiTechCheckboxList');
            if (!container) return;
            
            container.innerHTML = techArray.map(tech => `
                <label style="display:block;padding:8px;cursor:pointer;border-radius:5px;transition:0.2s" 
                       onmouseover="this.style.background='#f0f0f0'" 
                       onmouseout="this.style.background='transparent'">
                    <input type="checkbox" value="${tech}" 
                           ${ssiSelectedTechs.has(tech) ? 'checked' : ''} 
                           onchange="ssiOnTechCheckboxChange()"
                           style="margin-right:8px;cursor:pointer;width:18px;height:18px">
                    <span style="font-weight:600;color:#2c3e50">${tech}</span>
                </label>
            `).join('');
        }

        // COPIE EXACTE ligne 108-118
        function ssiOnTechCheckboxChange() {
            const checkboxes = document.querySelectorAll('#ssiTechCheckboxList input[type="checkbox"]');
            ssiSelectedTechs.clear();
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    ssiSelectedTechs.add(cb.value);
                }
            });
            ssiFilterData();
            ssiUpdateTechFilterButtonLabel();
        }

        // COPIE EXACTE ligne 120-130
        function ssiSelectAllTech() {
            const checkboxes = document.querySelectorAll('#ssiTechCheckboxList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            ssiOnTechCheckboxChange();
        }

        function ssiDeselectAllTech() {
            const checkboxes = document.querySelectorAll('#ssiTechCheckboxList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            ssiOnTechCheckboxChange();
        }

        // COPIE EXACTE ligne 132-141
        function ssiUpdateTechFilterButtonLabel() {
            const btn = document.getElementById('ssiTechFilterBtn');
            if (!btn) return;
            if (ssiSelectedTechs.size > 0) {
                btn.textContent = `▼ (${ssiSelectedTechs.size})`;
                btn.style.background = '#48bb78';
            } else {
                btn.textContent = '▼';
                btn.style.background = '#667eea';
            }
        }

        // COPIE EXACTE ligne 143-166
        function ssiOnSecteurChange() {
            const secteur = document.getElementById('ssiSearchSecteur').value.trim().toUpperCase();
            
            const validTechs = new Set();
            ssiAllData.forEach(d => {
                if (!secteur || d.secteur === secteur) {
                    validTechs.add(d.tech);
                }
            });
            
            ssiSelectedTechs = new Set([...ssiSelectedTechs].filter(t => validTechs.has(t)));
            
            if (ssiTechFilterOpen) {
                ssiUpdateTechCheckboxList();
            }
            
            ssiUpdateTechFilterButtonLabel();
            ssiFilterData();
        }

        // COPIE EXACTE ligne 187
        function ssiCalculHeures(v,h){v=parseFloat(v)||0;h=parseFloat(h)||0;return v===1?h:v===2?h*1.5:h*v;}

        // COPIE EXACTE ligne 189-198
        function ssiGetSecteur(tech){
            const t=String(tech).trim().toUpperCase();
            if(t.length>=2){
                const last2=t.slice(-2);
                if(last2==='S1')return 'S1';
                if(last2==='S2')return 'S2';
                if(last2==='S3')return 'S3';
            }
            return 'AUTRES';
        }

        // COPIE EXACTE ligne 200-203
        function ssiIsEmpty(val){
            const s=String(val||'').trim().toUpperCase();
            return s===''||s==='UNDEFINED'||s==='NAN'||s==='-';
        }

        // COPIE EXACTE ligne 205-215
        function ssiFormatDateFromExcel(val){
            if(!val)return '';
            const str=String(val).trim();
            if(str===''||str.toUpperCase()==='UNDEFINED'||str.toUpperCase()==='NAN')return '';
            const num=parseFloat(str);
            if(!isNaN(num)&&num>25569&&num<60000){
                const d=new Date((num-25569)*86400*1000);
                const day=String(d.getDate()).padStart(2,'0');
                const month=String(d.getMonth()+1).padStart(2,'0');
                const year=d.getFullYear();
                return day+'/'+month+'/'+year;
            }
            const d=new Date(str);
            if(!isNaN(d.getTime())){
                const day=String(d.getDate()).padStart(2,'0');
                const month=String(d.getMonth()+1).padStart(2,'0');
                const year=d.getFullYear();
                return day+'/'+month+'/'+year;
            }
            return str;
        }

        // REMPLACE handleFile - lit depuis APP.data au lieu du fichier Excel
        // Logique EXACTE lignes 274-319 mais source différente
        function ssiInitFromAppData(){
            if (!APP.data.ssi || APP.data.ssi.length === 0) {
                console.log('⚠️ Pas de données SSI');
                return;
            }

            // Copier techMapping depuis APP.tables.tech
            ssiTechMapping={};
            if (APP.tables && APP.tables.tech) {
                APP.tables.tech.forEach((info, code) => {
                    const k=String(code).trim().toUpperCase();
                    const v=String(info.value||'').trim().toUpperCase();
                    if(k)ssiTechMapping[k]=v;
                });
            }

            // Copier sttMapping depuis APP.tables.stt
            ssiSttMapping={};
            if (APP.tables && APP.tables.stt) {
                APP.tables.stt.forEach((info, code) => {
                    const k=String(code).trim().toUpperCase();
                    const v=String(info.value||'').trim().toUpperCase();
                    if(k)ssiSttMapping[k]=v;
                });
            }

            // EXACTEMENT comme lignes 274-319
            const hd = APP.data.ssiHeaders || [];
            ssiAllData=[];
            ssiFullDataRows=[];
            
            for(let i=0;i<APP.data.ssi.length;i++){
                const json = APP.data.ssi[i]._raw || [];
                if(json.length>0){
                    const tc=String(json[4]||'').trim().toUpperCase(),
                          tv=ssiTechMapping[tc]||tc,
                          nv=parseFloat(json[18])||0,
                          nh=parseFloat(json[59])||0,
                          ca=String(json[78]||'').trim().toUpperCase(),
                          eb=ca!==''&&ca!=='UNDEFINED'&&ca!=='NAN',
                          tb=eb?(ssiTechMapping[ca]||ca):'';
                    const idx=ssiAllData.length;
                    ssiAllData.push({
                        idx,
                        tech:tv,
                        nom:String(json[5]||'').trim().toUpperCase(),
                        ville:String(json[7]||'').trim().toUpperCase(),
                        code:String(json[0]||'').trim().toUpperCase(),
                        site:String(json[16]||'').trim().toUpperCase(),
                        dept:String(json[9]||'').trim().toUpperCase(),
                        nbVisite:nv,
                        nbHeure:nh,
                        heureCalc:ssiCalculHeures(nv,nh),
                        estBinome:eb,
                        techBinome:tb,
                        techBinomeAffich:tb,
                        secteur:ssiGetSecteur(tv),
                        bk:ssiFormatDateFromExcel(json[62]),
                        bt:ssiFormatDateFromExcel(json[71]),
                        bp:ssiFormatDateFromExcel(json[67]),
                        bv:ssiFormatDateFromExcel(json[73]),
                        bq:ssiFormatDateFromExcel(json[68])
                    });
                    ssiFullDataRows.push({hd,row:json,tv});
                }
            }
            
            console.log('🔍 SSI Données chargées:', ssiAllData.length, 'lignes');
            ssiCurrentSort={column:null,direction:null};
            ssiFilteredData=[...ssiAllData];
            ssiDisplayData(ssiFilteredData);
            ssiUpdateStats();
            ssiUpdateSortIcons();
            ssiUpdateTechCheckboxList();
            ssiUpdateTechFilterButtonLabel();
        }

        // COPIE EXACTE ligne 351-360
        function ssiToggleFilter(type){
            ssiActiveFilters[type]=!ssiActiveFilters[type];
            const btn=document.getElementById(type==='bpbt'?'ssiFilterV1':'ssiFilterV2');
            if(btn){
                if(ssiActiveFilters[type]){
                    btn.classList.add('active');
                    btn.style.background='var(--primary)';
                    btn.style.color='white';
                }else{
                    btn.classList.remove('active');
                    btn.style.background='var(--bg-elevated)';
                    btn.style.color='var(--text-secondary)';
                }
            }
            ssiFilterData();
        }

        // COPIE EXACTE ligne 362-394
        function ssiSortTable(col){
            if(ssiCurrentSort.column===col){
                if(ssiCurrentSort.direction==='asc'){
                    ssiCurrentSort.direction='desc';
                }else if(ssiCurrentSort.direction==='desc'){
                    ssiCurrentSort.column=null;
                    ssiCurrentSort.direction=null;
                    ssiFilterData();
                    return;
                }
            }else{
                ssiCurrentSort.column=col;
                ssiCurrentSort.direction='asc';
            }
            
            ssiFilteredData.sort((a,b)=>{
                let valA=a[col],valB=b[col];
                if(col==='nbVisite'||col==='nbHeure'){
                    valA=parseFloat(valA)||0;
                    valB=parseFloat(valB)||0;
                }else{
                    valA=String(valA).toUpperCase();
                    valB=String(valB).toUpperCase();
                }
                if(valA<valB)return ssiCurrentSort.direction==='asc'?-1:1;
                if(valA>valB)return ssiCurrentSort.direction==='asc'?1:-1;
                return 0;
            });
            
            ssiDisplayData(ssiFilteredData);
            ssiUpdateStats();
            ssiUpdateSortIcons();
        }

        // COPIE EXACTE ligne 396-407
        function ssiUpdateSortIcons(){
            ['tech','nom','ville','code','site','dept','nbVisite','nbHeure','techBinomeAffich','bk','bt','bp','bv','bq'].forEach(col=>{
                const el=document.getElementById('ssiSort'+col.charAt(0).toUpperCase()+col.slice(1));
                if(el){
                    if(ssiCurrentSort.column===col){
                        el.textContent=ssiCurrentSort.direction==='asc'?'▲':'▼';
                    }else{
                        el.textContent='';
                    }
                }
            });
        }

        // COPIE EXACTE ligne 409-449
        function ssiFilterData(){
            const c=document.getElementById('ssiSearchCode')?.value.trim().toUpperCase()||'',
                  n=document.getElementById('ssiSearchNom')?.value.trim().toUpperCase()||'',
                  v=document.getElementById('ssiSearchVille')?.value.trim().toUpperCase()||'',
                  d=document.getElementById('ssiSearchDept')?.value.trim().toUpperCase()||'',
                  s=document.getElementById('ssiSearchSecteur')?.value.trim().toUpperCase()||'';
            
            ssiFilteredData=ssiAllData.filter(i=>{
                let match=(!c||i.code.includes(c))&&
                    (!n||i.nom.includes(n))&&
                    (!v||i.ville.includes(v))&&
                    (!d||i.dept.includes(d))&&
                    (!s||i.secteur===s)&&
                    (ssiSelectedTechs.size===0||ssiSelectedTechs.has(i.tech));
                
                if(match&&ssiActiveFilters.bpbt){
                    match=ssiIsEmpty(i.bp)&&ssiIsEmpty(i.bt);
                }
                
                if(match&&ssiActiveFilters.bqbv){
                    match=ssiIsEmpty(i.bq)&&ssiIsEmpty(i.bv);
                }
                
                return match;
            });
            
            if(ssiCurrentSort.column){
                const tmpCol=ssiCurrentSort.column;
                const tmpDir=ssiCurrentSort.direction;
                ssiCurrentSort={column:null,direction:null};
                ssiSortTable(tmpCol);
                if(tmpDir==='desc'){
                    ssiSortTable(tmpCol);
                }
                return;
            }
            
            ssiDisplayData(ssiFilteredData);
            ssiUpdateStats();
            ssiUpdateFilterCounter();
        }

        // COPIE EXACTE ligne 451-455
        function ssiDisplayData(data){
            const tbody=document.getElementById('ssiSearchTableBody');
            if(!tbody)return;
            tbody.innerHTML=data.length===0?
                '<tr><td colspan="15" style="text-align:center;padding:60px;color:#999;">🔍 Aucun résultat</td></tr>':
                data.map((i,idx)=>`<tr onclick="ssiShowSiteDetails(${idx})" style="cursor:pointer;border-bottom:1px solid var(--border-subtle);" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='transparent'"><td style="padding:12px;"><strong>${i.tech}</strong></td><td style="padding:12px;">${i.nom}</td><td style="padding:12px;">${i.ville}</td><td style="padding:12px;">${i.code}</td><td style="padding:12px;">${i.site}</td><td style="padding:12px;">${i.dept}</td><td style="padding:12px;">${i.nbVisite}</td><td style="padding:12px;">${i.nbHeure}</td><td style="padding:12px;">${i.techBinomeAffich}</td><td style="padding:12px;">${i.bk||'-'}</td><td style="padding:12px;">${i.bt||'-'}</td><td style="padding:12px;">${i.bp||'-'}</td><td style="padding:12px;">${i.bv||'-'}</td><td style="padding:12px;">${i.bq||'-'}</td><td style="padding:12px;"><strong>${idx+1}</strong></td></tr>`).join('');
        }

        // COPIE EXACTE ligne 457-511
        function ssiUpdateStats(){
            const tS={},tB={};
            let sB=0;
            ssiFilteredData.forEach(i=>{
                if(!tS[i.tech])tS[i.tech]=0;
                tS[i.tech]+=i.heureCalc;
                if(i.estBinome&&i.techBinome){
                    if(!tB[i.techBinome])tB[i.techBinome]=0;
                    tB[i.techBinome]+=i.heureCalc;
                    sB++;
                }
            });
            
            const pS={s1:[],s2:[],s3:[],autres:[]};
            Object.keys(tS).forEach(t=>{
                const s=t.slice(-2).toUpperCase()==='S1'?'s1':t.slice(-2).toUpperCase()==='S2'?'s2':t.slice(-2).toUpperCase()==='S3'?'s3':'autres';
                let e=pS[s].find(x=>x.nom===t);
                if(e)e.heureSeul+=tS[t];
                else pS[s].push({nom:t,heureSeul:tS[t],heureBinome:0});
            });
            
            Object.keys(tB).forEach(t=>{
                const s=t.slice(-2).toUpperCase()==='S1'?'s1':t.slice(-2).toUpperCase()==='S2'?'s2':t.slice(-2).toUpperCase()==='S3'?'s3':'autres';
                let e=pS[s].find(x=>x.nom===t);
                if(e)e.heureBinome+=tB[t];
                else pS[s].push({nom:t,heureSeul:0,heureBinome:tB[t]});
            });
            
            Object.keys(pS).forEach(s=>pS[s].sort((a,b)=>(b.heureSeul+b.heureBinome)-(a.heureSeul+a.heureBinome)));
            
            let totS=0,totB=0;
            
            [{k:'s1',c:'ssiTechS1'},{k:'s2',c:'ssiTechS2'},{k:'s3',c:'ssiTechS3'},{k:'autres',c:'ssiTechAutres'}].forEach(sec=>{
                const col=document.getElementById(sec.c);
                if(!col)return;
                const tSeul=pS[sec.k].reduce((s,t)=>s+(t.heureSeul||0),0),tBin=pS[sec.k].reduce((s,t)=>s+(t.heureBinome||0),0);
                totS+=tSeul;
                totB+=tBin;
                if(pS[sec.k].length===0)col.innerHTML=`<div style="color:var(--text-muted);font-size:0.9em;text-align:center;padding:10px;">Aucun</div>`;
                else col.innerHTML=pS[sec.k].map(t=>`<div style="background:var(--${sec.k==='autres'?'autres':sec.k}-color);color:white;padding:10px 12px;border-radius:var(--radius-sm);margin-bottom:8px;"><div style="font-weight:600;font-size:0.9em;">${t.nom}</div><div style="font-size:0.85em;opacity:0.9;">${(t.heureSeul||0).toFixed(1)}h seul / ${(t.heureBinome||0).toFixed(1)}h binôme</div></div>`).join('');
            });
            
            const elSeul=document.getElementById('ssiHeuresSeul');
            const elBinome=document.getElementById('ssiHeuresBinome');
            const elTotal=document.getElementById('ssiTotalHeures');
            const elSites=document.getElementById('ssiSitesTotal');
            const elSitesSeul=document.getElementById('ssiSitesSeul');
            const elSitesBinome=document.getElementById('ssiSitesBinome');
            if(elSeul)elSeul.textContent=totS.toFixed(1);
            if(elBinome)elBinome.textContent=totB.toFixed(1);
            if(elTotal)elTotal.textContent=(totS+totB).toFixed(1);
            if(elSites)elSites.textContent=ssiFilteredData.length;
            if(elSitesSeul)elSitesSeul.textContent=ssiFilteredData.length-sB;
            if(elSitesBinome)elSitesBinome.textContent=sB;
        }

        // COPIE EXACTE ligne 513-530
        function ssiResetFilters(){
            ['ssiSearchCode','ssiSearchNom','ssiSearchVille','ssiSearchDept'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
            const sectEl=document.getElementById('ssiSearchSecteur');if(sectEl)sectEl.value='';
            ssiActiveFilters={bpbt:false,bqbv:false};
            ssiSelectedTechs.clear();
            const btn1=document.getElementById('ssiFilterV1');
            const btn2=document.getElementById('ssiFilterV2');
            if(btn1){btn1.classList.remove('active');btn1.style.background='var(--bg-elevated)';btn1.style.color='var(--text-secondary)';}
            if(btn2){btn2.classList.remove('active');btn2.style.background='var(--bg-elevated)';btn2.style.color='var(--text-secondary)';}
            ssiCurrentSort={column:null,direction:null};
            ssiFilteredData=[...ssiAllData];
            ssiDisplayData(ssiFilteredData);
            ssiUpdateStats();
            ssiUpdateSortIcons();
            ssiUpdateFilterCounter();
            ssiUpdateTechFilterButtonLabel();
            if(ssiTechFilterOpen){ssiUpdateTechCheckboxList();}
        }

        // Index courant pour navigation
        let ssiCurrentDetailIndex = 0;

        // COPIE EXACTE ligne 532-599
        function ssiShowSiteDetails(idx){
            if(idx>=ssiFilteredData.length)return;
            ssiCurrentDetailIndex = idx;
            const dataItem = ssiFilteredData[idx];
            const originalIdx = dataItem.idx;
            const{row,tv}=ssiFullDataRows[originalIdx];
            const g=i=>String(row[i]||'').trim();
            const b=i=>{const v=String(row[i]||'').toLowerCase();return v==='vrai'||v==='true'||v==='1'||v==='oui'||v==='x';};
            const chk=i=>`<div style="display:flex;align-items:center;gap:3px;"><div style="width:12px;height:12px;border:1px solid #667eea;border-radius:2px;display:flex;align-items:center;justify-content:center;background:${b(i)?'#667eea':'#fff'};">${b(i)?'<span style="color:white;font-weight:700;font-size:8px;">✓</span>':''}</div><span style="font-size:0.85em;">${b(i)?'OUI':'NON'}</span></div>`;
            const val=i=>{const v=g(i);if(v===''||v.toUpperCase()==='UNDEFINED'||v.toUpperCase()==='NAN')return '-';return v;};
            const fmtDate=i=>{const v=g(i);if(v===''||v.toUpperCase()==='UNDEFINED'||v.toUpperCase()==='NAN')return '-';const num=parseFloat(v);if(!isNaN(num)&&num>25569&&num<60000){const d=new Date((num-25569)*86400*1000);const day=String(d.getDate()).padStart(2,'0');const month=String(d.getMonth()+1).padStart(2,'0');const year=d.getFullYear();return day+'/'+month+'/'+year;}const d=new Date(v);if(!isNaN(d.getTime())){const day=String(d.getDate()).padStart(2,'0');const month=String(d.getMonth()+1).padStart(2,'0');const year=d.getFullYear();return day+'/'+month+'/'+year;}return v;};
            const tech2Cle=String(row[78]||'').trim().toUpperCase();
            const tech2Nom=ssiTechMapping[tech2Cle]||tech2Cle||'-';
            const sttCle=String(row[128]||'').trim().toUpperCase();
            const sttNom=ssiSttMapping[sttCle]||sttCle||'-';
            const prix=g(115);
            const prixF=prix&&prix!==''&&prix.toUpperCase()!=='UNDEFINED'?prix+' €':'-';
            const titleEl=document.getElementById('ssiModalTitle');
            const bodyEl=document.getElementById('ssiModalBody');
            // Mise à jour boutons navigation
            const prevBtn=document.getElementById('ssiPrevBtn');
            const nextBtn=document.getElementById('ssiNextBtn');
            if(prevBtn)prevBtn.disabled=ssiCurrentDetailIndex===0;
            if(nextBtn)nextBtn.disabled=ssiCurrentDetailIndex>=ssiFilteredData.length-1;
            if(prevBtn)prevBtn.style.opacity=ssiCurrentDetailIndex===0?'0.5':'1';
            if(nextBtn)nextBtn.style.opacity=ssiCurrentDetailIndex>=ssiFilteredData.length-1?'0.5':'1';
            if(titleEl)titleEl.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;gap:10px;font-size:0.85em;"><span>🏢 ${val(5)} - ${val(7)} | Code: ${val(0)}</span><span style="font-size:0.8em;color:#666;">${ssiCurrentDetailIndex+1}/${ssiFilteredData.length}</span><span style="background:linear-gradient(135deg,#f093fb,#f5576c);color:white;padding:3px 10px;border-radius:15px;font-size:0.85em;font-weight:700;">💰 ${prixF}</span></div>`;
            if(bodyEl)bodyEl.innerHTML=`
<div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:8px;align-items:start;">
<div>
<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:4px 8px;border-radius:4px;margin-bottom:4px;font-size:0.85em;font-weight:600;">📋 INFO CLIENT / SITE</div>
<table style="width:100%;border-collapse:collapse;background:white;border-radius:4px;overflow:hidden;font-size:0.9em;">
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;width:45%;">Client_Num</td><td style="padding:3px 6px;">${val(0)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Nom du site</td><td style="padding:3px 6px;">${val(5)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Ville</td><td style="padding:3px 6px;">${val(7)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Type contrat SSI</td><td style="padding:3px 6px;">${val(16)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Technicien</td><td style="padding:3px 6px;">${tv}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Nb Visites</td><td style="padding:3px 6px;">${val(18)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Nb heures</td><td style="padding:3px 6px;">${val(59)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Nb Tech</td><td style="padding:3px 6px;">${val(60)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Tech 2</td><td style="padding:3px 6px;">${tech2Nom}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Centrale 1</td><td style="padding:3px 6px;">${val(37)} / ${val(39)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Centrale 2</td><td style="padding:3px 6px;">${val(38)} / ${val(40)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Astreinte 2H</td><td style="padding:3px 6px;">${chk(30)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Astreinte 4H</td><td style="padding:3px 6px;">${chk(31)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Astr intrusion</td><td style="padding:3px 6px;">${chk(32)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Premium intrusion</td><td style="padding:3px 6px;">${chk(17)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Intrusion</td><td style="padding:3px 6px;">${chk(36)}</td></tr>
</table>
</div>
<div>
<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:4px 8px;border-radius:4px;margin-bottom:4px;font-size:0.85em;font-weight:600;">📅 PLANNING SSI</div>
<table style="width:100%;border-collapse:collapse;background:white;border-radius:4px;overflow:hidden;font-size:0.9em;">
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;width:60%;">V0 date max (BK)</td><td style="padding:3px 6px;">${fmtDate(62)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">V1-23 (BP)</td><td style="padding:3px 6px;">${fmtDate(67)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">V2-23 (BQ)</td><td style="padding:3px 6px;">${fmtDate(68)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">PL 1er sem (BT)</td><td style="padding:3px 6px;">${fmtDate(71)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">PL 2eme sem (BV)</td><td style="padding:3px 6px;">${fmtDate(73)}</td></tr>
</table>
<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:4px 8px;border-radius:4px;margin:6px 0 4px;font-size:0.85em;font-weight:600;">🔄 RECO</div>
<table style="width:100%;border-collapse:collapse;background:white;border-radius:4px;overflow:hidden;font-size:0.9em;">
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;width:60%;">Prépayé</td><td style="padding:3px 6px;">${chk(22)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Recond 2023</td><td style="padding:3px 6px;">${val(89)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Recond</td><td style="padding:3px 6px;">${val(21)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">PL recond</td><td style="padding:3px 6px;">${fmtDate(91)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Recond expe</td><td style="padding:3px 6px;">${fmtDate(101)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Recond recup</td><td style="padding:3px 6px;">${val(26)}</td></tr>
</table>
</div>
<div>
<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:4px 8px;border-radius:4px;margin-bottom:4px;font-size:0.85em;font-weight:600;">🚒 DSF</div>
<table style="width:100%;border-collapse:collapse;background:white;border-radius:4px;overflow:hidden;font-size:0.9em;">
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;width:60%;">Débits</td><td style="padding:3px 6px;">${chk(92)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Blocs</td><td style="padding:3px 6px;">${chk(93)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Infiltro</td><td style="padding:3px 6px;">${chk(94)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Extincteurs</td><td style="padding:3px 6px;">${chk(95)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Désenfumage</td><td style="padding:3px 6px;">${chk(80)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Date fin DSF</td><td style="padding:3px 6px;">${fmtDate(28)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Date CE DSF</td><td style="padding:3px 6px;">${fmtDate(86)}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Sous traitant</td><td style="padding:3px 6px;">${sttNom}</td></tr>
<tr style="border-bottom:1px solid #e9ecef;"><td style="padding:3px 6px;font-weight:600;color:#555;background:#f8f9fa;">Mois STT</td><td style="padding:3px 6px;">${val(129)}</td></tr>
</table>
</div>
</div>`;
            const modal=document.getElementById('ssiSiteModal');
            if(modal)modal.classList.add('active');
        }

        // COPIE EXACTE ligne 601-603
        function ssiCloseModal(){
            const modal=document.getElementById('ssiSiteModal');
            if(modal)modal.classList.remove('active');
        }

        // COPIE EXACTE ligne 605-615
        function ssiUpdateFilterCounter(){
            const counter=document.getElementById('ssiFilterCounter');
            const counterValue=document.getElementById('ssiCounterValue');
            const hasActiveFilter=ssiActiveFilters.bpbt||ssiActiveFilters.bqbv;
            if(counter){
                if(hasActiveFilter){
                    counter.style.display='block';
                    if(counterValue)counterValue.textContent=ssiFilteredData.length;
                }else{
                    counter.style.display='none';
                }
            }
        }

        // Interface SEARCHSSI pour le reste de l'app
        const SEARCHSSI = {
            init() {
                ssiInitFromAppData();
                // Event listeners
                ['ssiSearchCode','ssiSearchNom','ssiSearchVille','ssiSearchDept'].forEach(id=>{
                    const el=document.getElementById(id);
                    if(el)el.addEventListener('input',()=>ssiFilterData());
                });
                const sectEl=document.getElementById('ssiSearchSecteur');
                if(sectEl)sectEl.addEventListener('change',()=>ssiOnSecteurChange());
            },
            toggleFilter(type) { ssiToggleFilter(type==='v1'?'bpbt':'bqbv'); },
            sort(col) { ssiSortTable(col); },
            reset() { ssiResetFilters(); },
            closeModal() { ssiCloseModal(); },
            showDetail(idx) { ssiShowSiteDetails(idx); },
            prev() { if(ssiCurrentDetailIndex>0) ssiShowSiteDetails(ssiCurrentDetailIndex-1); },
            next() { if(ssiCurrentDetailIndex<ssiFilteredData.length-1) ssiShowSiteDetails(ssiCurrentDetailIndex+1); },
            filterByTech(tech) {
                ssiSelectedTechs.clear();
                ssiSelectedTechs.add(tech);
                ssiUpdateTechFilterButtonLabel();
                ssiFilterData();
            }
        };

        // Fermer le dropdown TECH quand on clique ailleurs - COPIE EXACTE ligne 168-176
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('ssiTechFilterDropdown');
            const btn = document.getElementById('ssiTechFilterBtn');
            if (dropdown && btn && !dropdown.contains(e.target) && e.target !== btn) {
                ssiTechFilterOpen = false;
                dropdown.style.display = 'none';
            }
        });

        // ============================================
        // MODULE PRODUITS - LOGIQUE
        // ============================================
        const PRODUITS = {
            data: [],
            filtered: [],
            years: [],
            categories: [],

            init() {
                if (APP.data.produits.length === 0) {
                    const emptyEl = document.getElementById('produitsEmptyState');
                    if (emptyEl) emptyEl.style.display = 'block';
                    return;
                }
                const emptyEl = document.getElementById('produitsEmptyState');
                if (emptyEl) emptyEl.style.display = 'none';
                
                this.processData();
                this.populateFilters();
                this.search();
            },

            processData() {
                this.data = [];
                this.years = [];
                this.categories = new Set();
                
                APP.data.produits.forEach((row, idx) => {
                    // Les données sont déjà pré-traitées par parseWorkbook
                    const processed = { 
                        _raw: row._raw || row, 
                        _index: idx,
                        code: row.code || '',
                        designation: row.designation || '',
                        description: row.description || '',
                        marque: row.marque || '',
                        categorie: row.categorie || '',
                        tarifs: row.tarifs || {}
                    };
                    
                    if (processed.categorie) this.categories.add(processed.categorie);
                    
                    // Collecter les années des tarifs
                    Object.keys(processed.tarifs).forEach(year => {
                        if (!this.years.includes(year)) this.years.push(year);
                    });
                    
                    this.data.push(processed);
                });
                
                this.years.sort().reverse();
            },

            populateFilters() {
                // Catégories
                const catSelect = document.getElementById('produitsCategorieFilter');
                if (catSelect) {
                    catSelect.innerHTML = '<option value="">Toutes les catégories</option>';
                    [...this.categories].sort().forEach(cat => {
                        catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                    });
                }
                
                // Marques
                const marqueSelect = document.getElementById('produitsMarqueFilter');
                if (marqueSelect) {
                    const marques = new Set();
                    this.data.forEach(p => { if (p.marque) marques.add(p.marque); });
                    marqueSelect.innerHTML = '<option value="">Toutes les marques</option>';
                    [...marques].sort().forEach(m => {
                        marqueSelect.innerHTML += `<option value="${m}">${m}</option>`;
                    });
                }
            },

            search() {
                const searchInput = document.getElementById('produitsSearchInput');
                const query = (searchInput?.value || '').toLowerCase();
                
                const catFilter = document.getElementById('produitsCategorieFilter');
                const categorie = catFilter?.value || '';
                
                const marqueFilter = document.getElementById('produitsMarqueFilter');
                const marque = marqueFilter?.value || '';
                
                this.filtered = this.data.filter(p => {
                    if (query) {
                        const searchStr = `${p.code} ${p.designation} ${p.description} ${p.marque}`.toLowerCase();
                        if (!searchStr.includes(query)) return false;
                    }
                    if (categorie && p.categorie !== categorie) return false;
                    if (marque && p.marque !== marque) return false;
                    return true;
                });
                
                this.render();
            },

            render() {
                const container = document.getElementById('produitsGrid');
                const countEl = document.getElementById('produitsSearchCount');
                
                if (countEl) countEl.textContent = `${this.filtered.length} produits`;
                
                if (!container) return;
                
                if (this.filtered.length === 0) {
                    container.innerHTML = '<p class="empty-text">Aucun produit trouvé</p>';
                    return;
                }
                
                container.innerHTML = this.filtered.slice(0, 100).map((p, idx) => `
                    <div class="produit-card" onclick="PRODUITS.showDetail(${idx})">
                        <div class="produit-code">${p.code}</div>
                        <div class="produit-designation">${p.designation}</div>
                        <div class="produit-description">${p.description || '-'}</div>
                        <div class="produit-tarifs">
                            ${this.years.slice(0, 2).map(y => `
                                <span class="tarif-badge">${y}: ${p.tarifs[y] ? formatCurrency(p.tarifs[y]) : '-'}</span>
                            `).join('')}
                        </div>
                        <button class="btn-copy" onclick="event.stopPropagation(); PRODUITS.copy(${idx})">📋 Copier</button>
                    </div>
                `).join('');
            },

            showDetail(idx) {
                const p = this.filtered[idx];
                const modal = document.getElementById('produitDetailModal');
                
                let html = `<div class="detail-section">
                    <div class="detail-section-content">
                        <div class="detail-item"><div class="item-label">Code</div><div class="item-value">${p.code}</div></div>
                        <div class="detail-item"><div class="item-label">Désignation</div><div class="item-value">${p.designation}</div></div>
                        <div class="detail-item"><div class="item-label">Description</div><div class="item-value">${p.description || '-'}</div></div>
                        <div class="detail-item"><div class="item-label">Marque</div><div class="item-value">${p.marque || '-'}</div></div>
                        <div class="detail-item"><div class="item-label">Catégorie</div><div class="item-value">${p.categorie || '-'}</div></div>
                    </div>
                </div>
                <div class="detail-section">
                    <div class="detail-section-title">💰 Tarifs par année</div>
                    <div class="detail-section-content">
                        ${this.years.map(y => `
                            <div class="detail-item"><div class="item-label">${y}</div><div class="item-value">${p.tarifs[y] ? formatCurrency(p.tarifs[y]) : '-'}</div></div>
                        `).join('')}
                    </div>
                </div>`;
                
                document.getElementById('produitDetailContent').innerHTML = html;
                modal.classList.add('active');
            },

            closeDetail() {
                document.getElementById('produitDetailModal').classList.remove('active');
            },

            copy(idx) {
                const p = this.filtered[idx];
                const text = `${p.code}\t${p.designation}\t${p.tarifs[this.years[0]] || ''}`;
                navigator.clipboard.writeText(text).then(() => {
                    alert('✅ Copié dans le presse-papier !');
                });
            }
        };

        // ============================================
        // MODULE RELANCES - LOGIQUE
        // ============================================
        const RELANCES = {
            history: [],

            init() {
                this.loadHistory();
                this.updateCounts();
            },

            loadHistory() {
                try {
                    this.history = JSON.parse(localStorage.getItem('relances_history') || '[]');
                } catch (e) {
                    this.history = [];
                }
                this.renderHistory();
            },

            saveHistory() {
                localStorage.setItem('relances_history', JSON.stringify(this.history.slice(0, 50)));
            },

            updateCounts() {
                // STT à relancer
                const sttCount = TRAVAUX.filtered ? TRAVAUX.filtered.filter(r => r.has_stt && !r.is_planified).length : 0;
                document.getElementById('relanceCountStt').textContent = sttCount;
                
                // Devis en attente > 30j
                document.getElementById('relanceCountDevis').textContent = 0;
                
                // DSF
                document.getElementById('relanceCountDsf').textContent = DSF.resp ? DSF.resp.length : 0;
                
                // Visites
                document.getElementById('relanceCountVisites').textContent = 0;
            },

            openType(type) {
                if (type === 'stt') {
                    navigateTo('travaux');
                    setTimeout(() => {
                        document.getElementById('travauxSttFilter').value = 'AVEC';
                        TRAVAUX.applyFilters();
                    }, 100);
                } else if (type === 'dsf') {
                    navigateTo('dsf');
                    setTimeout(() => {
                        DSF.switchTab('resp');
                    }, 100);
                } else if (type === 'devis') {
                    navigateTo('devis');
                } else if (type === 'visites') {
                    navigateTo('visites');
                }
            },

            record(type, destinataire, count) {
                this.history.unshift({
                    date: new Date().toISOString(),
                    type: type,
                    destinataire: destinataire,
                    count: count
                });
                this.saveHistory();
                this.renderHistory();
            },

            renderHistory() {
                const container = document.getElementById('relancesHistoryList');
                if (!container) return;
                
                if (this.history.length === 0) {
                    container.innerHTML = '<p class="empty-text">Aucune relance envoyée récemment</p>';
                    return;
                }
                
                container.innerHTML = this.history.slice(0, 10).map(h => `
                    <div class="history-item">
                        <span class="history-date">${new Date(h.date).toLocaleDateString('fr-FR')}</span>
                        <span class="history-type">${h.type}</span>
                        <span class="history-dest">${h.destinataire}</span>
                        <span class="history-count">${h.count} éléments</span>
                    </div>
                `).join('');
            }
        };

        // ============================================
        // MODULE PRODUITS (Recherche Réf Produit) - Import séparé
        // ============================================
        let produitData = [];
        let produitAvailableYears = [];
        let produitCurrentYear = 2024;
        let produitSelectedCategory = '';

        function handleProduitFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { raw: false, defval: '' });
                    processProduitData(jsonData);
                    document.getElementById('produitUploadZone').style.display = 'none';
                    document.getElementById('produitSearchContainer').style.display = 'block';
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('Erreur lors de la lecture du fichier');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processProduitData(data) {
            const headers = Object.keys(data[0] || {});
            produitAvailableYears = [];
            headers.forEach(header => {
                const yearMatch = header.match(/202\d|203\d/);
                if (yearMatch && header.includes('INSTAL')) {
                    const year = parseInt(yearMatch[0]);
                    if (!produitAvailableYears.includes(year)) produitAvailableYears.push(year);
                }
            });
            produitAvailableYears.sort((a, b) => b - a);
            if (produitAvailableYears.length > 0) produitCurrentYear = produitAvailableYears[0];
            
            produitData = data.map((row, idx) => ({
                code: row['Code'] || '',
                nom: row['Nom'] || '',
                description: row['Description'] || '',
                categorie: row['Catégorie'] || row['Categorie'] || '',
                prices: produitAvailableYears.reduce((acc, year) => {
                    acc[year] = {
                        instal: row[`TARIF INSTAL ${year}`] || row[`TARIF INSTAL${year}`] || 0,
                        util: row[`TARIF UTIL ${year}`] || row[`TARIF UTIL${year}`] || 0,
                        public: row[`TARIF PUBLIC ${year}`] || row[`TARIF PUBLIC${year}`] || 0
                    };
                    return acc;
                }, {})
            }));

            createProduitYearButtons();
            populateProduitCategoryFilter();
            displayProduitResults(produitData);
        }

        function createProduitYearButtons() {
            const container = document.getElementById('produitYearButtons');
            if (!container) return;
            container.innerHTML = '';
            produitAvailableYears.forEach(year => {
                const btn = document.createElement('button');
                btn.className = 'produit-year-btn' + (year === produitCurrentYear ? ' active' : '');
                btn.textContent = year;
                btn.onclick = () => {
                    produitCurrentYear = year;
                    document.querySelectorAll('.produit-year-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    performProduitSearch();
                };
                container.appendChild(btn);
            });
        }

        function populateProduitCategoryFilter() {
            const categories = [...new Set(produitData.map(p => p.categorie).filter(c => c))].sort();
            const select = document.getElementById('produitCategoryFilter');
            if (!select) return;
            select.innerHTML = '<option value="">Toutes</option>';
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                select.appendChild(opt);
            });
        }

        function performProduitSearch() {
            const query = (document.getElementById('produitSearchInput')?.value || '').toLowerCase().trim();
            let filtered = produitData;
            if (produitSelectedCategory) filtered = filtered.filter(p => p.categorie === produitSelectedCategory);
            if (query) filtered = filtered.filter(p => p.nom.toLowerCase().includes(query) || p.description.toLowerCase().includes(query) || p.code.toLowerCase().includes(query));
            displayProduitResults(filtered);
        }

        function displayProduitResults(products) {
            const body = document.getElementById('produitResultsBody');
            const info = document.getElementById('produitResultsInfo');
            const count = document.getElementById('produitResultsCount');
            if (!body) return;
            
            if (products.length === 0) {
                if (info) info.style.display = 'none';
                body.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#999;"><div style="font-size:3em;margin-bottom:10px;">🔍</div>Aucun produit trouvé</td></tr>';
                return;
            }
            if (info) info.style.display = 'flex';
            if (count) count.textContent = products.length + ' produit' + (products.length > 1 ? 's' : '');
            
            body.innerHTML = products.map(p => {
                const prices = p.prices[produitCurrentYear] || { instal: 0, util: 0, public: 0 };
                return '<tr>' +
                    '<td><button class="produit-copy-btn" onclick="copyProduitInfo(\'' + p.code.replace(/'/g,"\\'") + '\',\'' + p.nom.replace(/'/g,"\\'") + '\',this)">📋</button></td>' +
                    '<td style="font-weight:700;color:#667eea;font-family:monospace;">' + p.code + '</td>' +
                    '<td style="font-weight:500;">' + p.nom + '</td>' +
                    '<td style="color:#666;font-size:0.9em;">' + p.description + '</td>' +
                    '<td style="text-align:right;font-weight:600;">' + formatProduitPrice(prices.public) + ' €</td>' +
                    '<td style="text-align:right;font-weight:600;">' + formatProduitPrice(prices.util) + ' €</td>' +
                    '<td style="text-align:right;font-weight:600;">' + formatProduitPrice(prices.instal) + ' €</td>' +
                '</tr>';
            }).join('');
        }

        function copyProduitInfo(code, nom, btn) {
            navigator.clipboard.writeText(code + ' ' + nom).then(() => {
                btn.classList.add('copied');
                btn.innerHTML = '✓';
                setTimeout(() => { btn.classList.remove('copied'); btn.innerHTML = '📋'; }, 2000);
            });
        }

        function formatProduitPrice(price) {
            if (!price || price === 0) return '0.00';
            return parseFloat(price).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // ============================================
        // FIREBASE AUTHENTICATION (CONFIG INTÉGRÉE)
        // ============================================
        (function initFirebaseAuth() {
            // Configuration Firebase intégrée
            const firebaseConfig = {
                apiKey: "AIzaSyC-zpGDbnkqkWkjCdxsOjFg8Q5n5KCBgX0",
                authDomain: "dashboard-a012f.firebaseapp.com",
                projectId: "dashboard-a012f",
                storageBucket: "dashboard-a012f.firebasestorage.app",
                messagingSenderId: "429058528722",
                appId: "1:429058528722:web:4bb4d3e086ba2fcdbc184b"
            };
            
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                // Check auth state
                firebase.auth().onAuthStateChanged(function(user) {
                    const loadingEl = document.getElementById('auth-loading');
                    const userInfoEl = document.getElementById('userInfo');
                    const logoutBtnEl = document.getElementById('logoutBtn');
                    const userEmailEl = document.getElementById('userEmail');
                    
                    if (user) {
                        // User is signed in
                        console.log('✅ User authenticated:', user.email);
                        
                        // Show UI elements
                        if (userInfoEl) {
                            userInfoEl.style.display = 'flex';
                        }
                        if (logoutBtnEl) {
                            logoutBtnEl.style.display = 'flex';
                        }
                        if (userEmailEl) {
                            userEmailEl.textContent = user.email;
                        }
                        
                        // Hide loading
                        setTimeout(() => {
                            if (loadingEl) {
                                loadingEl.classList.add('hidden');
                            }
                        }, 500);
                        
                    } else {
                        // User is signed out, redirect to login
                        console.log('❌ User not authenticated');
                        window.location.href = 'index.html';
                    }
                });
                
            } catch (error) {
                console.error('Firebase init error:', error);
                window.location.href = 'index.html';
            }
        })();
        
        // Logout function
        function handleLogout() {
            if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
                firebase.auth().signOut().then(() => {
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error('Logout error:', error);
                    alert('Erreur lors de la déconnexion');
                });
            }
        }

    </script>
</body>
</html>
